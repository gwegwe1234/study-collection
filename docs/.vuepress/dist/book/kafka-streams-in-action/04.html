<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.69cdfe8d.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.c868891f.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.18806e4e.js" as="script"><link rel="preload" href="/study-collection/assets/js/5.ae8549cb.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.78fd625e.js"><link rel="prefetch" href="/study-collection/assets/js/100.e383c732.js"><link rel="prefetch" href="/study-collection/assets/js/101.4cd683f4.js"><link rel="prefetch" href="/study-collection/assets/js/102.d65e967d.js"><link rel="prefetch" href="/study-collection/assets/js/103.e1490cb9.js"><link rel="prefetch" href="/study-collection/assets/js/104.918e1077.js"><link rel="prefetch" href="/study-collection/assets/js/105.534c6a73.js"><link rel="prefetch" href="/study-collection/assets/js/106.f4dcf55c.js"><link rel="prefetch" href="/study-collection/assets/js/107.584c0a74.js"><link rel="prefetch" href="/study-collection/assets/js/108.d929e7cc.js"><link rel="prefetch" href="/study-collection/assets/js/109.88e0200f.js"><link rel="prefetch" href="/study-collection/assets/js/11.a0f12b30.js"><link rel="prefetch" href="/study-collection/assets/js/110.3cfcc3e8.js"><link rel="prefetch" href="/study-collection/assets/js/111.4ae37b59.js"><link rel="prefetch" href="/study-collection/assets/js/112.33d5d946.js"><link rel="prefetch" href="/study-collection/assets/js/113.b5259d7d.js"><link rel="prefetch" href="/study-collection/assets/js/114.9e045700.js"><link rel="prefetch" href="/study-collection/assets/js/115.5e606553.js"><link rel="prefetch" href="/study-collection/assets/js/116.1b5c40e8.js"><link rel="prefetch" href="/study-collection/assets/js/117.fd50b9b6.js"><link rel="prefetch" href="/study-collection/assets/js/118.fc1b6dd3.js"><link rel="prefetch" href="/study-collection/assets/js/119.51dba8be.js"><link rel="prefetch" href="/study-collection/assets/js/12.54c4aa49.js"><link rel="prefetch" href="/study-collection/assets/js/120.fd7ad585.js"><link rel="prefetch" href="/study-collection/assets/js/121.749f802a.js"><link rel="prefetch" href="/study-collection/assets/js/122.1f9b6871.js"><link rel="prefetch" href="/study-collection/assets/js/123.1a0529c4.js"><link rel="prefetch" href="/study-collection/assets/js/124.1e77cfbd.js"><link rel="prefetch" href="/study-collection/assets/js/125.9c961a16.js"><link rel="prefetch" href="/study-collection/assets/js/126.30b96676.js"><link rel="prefetch" href="/study-collection/assets/js/127.4f79bff5.js"><link rel="prefetch" href="/study-collection/assets/js/128.69291795.js"><link rel="prefetch" href="/study-collection/assets/js/129.2e0e7f32.js"><link rel="prefetch" href="/study-collection/assets/js/13.fe008e8c.js"><link rel="prefetch" href="/study-collection/assets/js/130.3b66ca81.js"><link rel="prefetch" href="/study-collection/assets/js/131.dd64c053.js"><link rel="prefetch" href="/study-collection/assets/js/132.eb792328.js"><link rel="prefetch" href="/study-collection/assets/js/133.cf4ad13d.js"><link rel="prefetch" href="/study-collection/assets/js/134.1b0f212f.js"><link rel="prefetch" href="/study-collection/assets/js/135.f0d11cdb.js"><link rel="prefetch" href="/study-collection/assets/js/136.79c83e41.js"><link rel="prefetch" href="/study-collection/assets/js/137.f038cc4c.js"><link rel="prefetch" href="/study-collection/assets/js/138.f8ad6c5b.js"><link rel="prefetch" href="/study-collection/assets/js/139.08f55c31.js"><link rel="prefetch" href="/study-collection/assets/js/14.0c11c254.js"><link rel="prefetch" href="/study-collection/assets/js/140.bf4fbebd.js"><link rel="prefetch" href="/study-collection/assets/js/141.5dc21586.js"><link rel="prefetch" href="/study-collection/assets/js/142.42820d89.js"><link rel="prefetch" href="/study-collection/assets/js/143.9d840cc3.js"><link rel="prefetch" href="/study-collection/assets/js/144.a24b919b.js"><link rel="prefetch" href="/study-collection/assets/js/145.561d4b73.js"><link rel="prefetch" href="/study-collection/assets/js/146.9595343d.js"><link rel="prefetch" href="/study-collection/assets/js/147.a604997a.js"><link rel="prefetch" href="/study-collection/assets/js/148.7f7d54e2.js"><link rel="prefetch" href="/study-collection/assets/js/149.c8dd0964.js"><link rel="prefetch" href="/study-collection/assets/js/15.2acdb3ee.js"><link rel="prefetch" href="/study-collection/assets/js/150.ed90b542.js"><link rel="prefetch" href="/study-collection/assets/js/151.77d1d657.js"><link rel="prefetch" href="/study-collection/assets/js/152.f791372c.js"><link rel="prefetch" href="/study-collection/assets/js/153.d237cb15.js"><link rel="prefetch" href="/study-collection/assets/js/154.a47770a2.js"><link rel="prefetch" href="/study-collection/assets/js/155.1ca8c583.js"><link rel="prefetch" href="/study-collection/assets/js/156.a51e5527.js"><link rel="prefetch" href="/study-collection/assets/js/157.25721247.js"><link rel="prefetch" href="/study-collection/assets/js/158.1ba2b2d5.js"><link rel="prefetch" href="/study-collection/assets/js/159.49937756.js"><link rel="prefetch" href="/study-collection/assets/js/16.8f060e68.js"><link rel="prefetch" href="/study-collection/assets/js/160.6d121690.js"><link rel="prefetch" href="/study-collection/assets/js/161.625cd04c.js"><link rel="prefetch" href="/study-collection/assets/js/162.1da391d0.js"><link rel="prefetch" href="/study-collection/assets/js/163.c0ce885f.js"><link rel="prefetch" href="/study-collection/assets/js/164.49e37883.js"><link rel="prefetch" href="/study-collection/assets/js/165.d90e290d.js"><link rel="prefetch" href="/study-collection/assets/js/166.7b0e06d2.js"><link rel="prefetch" href="/study-collection/assets/js/167.f95e3902.js"><link rel="prefetch" href="/study-collection/assets/js/168.f1a0346e.js"><link rel="prefetch" href="/study-collection/assets/js/169.ed100207.js"><link rel="prefetch" href="/study-collection/assets/js/17.14552ee1.js"><link rel="prefetch" href="/study-collection/assets/js/170.e8cc3bb9.js"><link rel="prefetch" href="/study-collection/assets/js/171.880417d8.js"><link rel="prefetch" href="/study-collection/assets/js/172.b000c45a.js"><link rel="prefetch" href="/study-collection/assets/js/173.3a4f6855.js"><link rel="prefetch" href="/study-collection/assets/js/174.bcb3d35a.js"><link rel="prefetch" href="/study-collection/assets/js/175.07d3c2cf.js"><link rel="prefetch" href="/study-collection/assets/js/176.db0cc2dd.js"><link rel="prefetch" href="/study-collection/assets/js/177.61636c99.js"><link rel="prefetch" href="/study-collection/assets/js/178.fdd62de4.js"><link rel="prefetch" href="/study-collection/assets/js/179.edc9a8d7.js"><link rel="prefetch" href="/study-collection/assets/js/18.6c32614a.js"><link rel="prefetch" href="/study-collection/assets/js/19.ccd76e20.js"><link rel="prefetch" href="/study-collection/assets/js/20.1e4d5388.js"><link rel="prefetch" href="/study-collection/assets/js/21.20283d28.js"><link rel="prefetch" href="/study-collection/assets/js/22.30dc43fd.js"><link rel="prefetch" href="/study-collection/assets/js/23.d23a7b98.js"><link rel="prefetch" href="/study-collection/assets/js/24.58cb377b.js"><link rel="prefetch" href="/study-collection/assets/js/25.a24e546d.js"><link rel="prefetch" href="/study-collection/assets/js/26.62a45f76.js"><link rel="prefetch" href="/study-collection/assets/js/27.639ea471.js"><link rel="prefetch" href="/study-collection/assets/js/28.aa1e66d3.js"><link rel="prefetch" href="/study-collection/assets/js/29.81d3e5bc.js"><link rel="prefetch" href="/study-collection/assets/js/3.84a2d408.js"><link rel="prefetch" href="/study-collection/assets/js/30.8b0e6f9b.js"><link rel="prefetch" href="/study-collection/assets/js/31.03860287.js"><link rel="prefetch" href="/study-collection/assets/js/32.2f6b42b4.js"><link rel="prefetch" href="/study-collection/assets/js/33.59192bd2.js"><link rel="prefetch" href="/study-collection/assets/js/34.167f0ee4.js"><link rel="prefetch" href="/study-collection/assets/js/35.b6366b86.js"><link rel="prefetch" href="/study-collection/assets/js/36.51854031.js"><link rel="prefetch" href="/study-collection/assets/js/37.af7fdf7f.js"><link rel="prefetch" href="/study-collection/assets/js/38.5bc14fc1.js"><link rel="prefetch" href="/study-collection/assets/js/39.5f355151.js"><link rel="prefetch" href="/study-collection/assets/js/4.52ba1d38.js"><link rel="prefetch" href="/study-collection/assets/js/40.d368d580.js"><link rel="prefetch" href="/study-collection/assets/js/41.11beff23.js"><link rel="prefetch" href="/study-collection/assets/js/42.89844662.js"><link rel="prefetch" href="/study-collection/assets/js/43.4fef29cb.js"><link rel="prefetch" href="/study-collection/assets/js/44.6a576bb2.js"><link rel="prefetch" href="/study-collection/assets/js/45.b9e44b27.js"><link rel="prefetch" href="/study-collection/assets/js/46.ca47957e.js"><link rel="prefetch" href="/study-collection/assets/js/47.fe37cefc.js"><link rel="prefetch" href="/study-collection/assets/js/48.fe8612dd.js"><link rel="prefetch" href="/study-collection/assets/js/49.63ea19fc.js"><link rel="prefetch" href="/study-collection/assets/js/50.b985a4c3.js"><link rel="prefetch" href="/study-collection/assets/js/51.05f134f6.js"><link rel="prefetch" href="/study-collection/assets/js/52.f5752a71.js"><link rel="prefetch" href="/study-collection/assets/js/53.4cafd88c.js"><link rel="prefetch" href="/study-collection/assets/js/54.3e47b941.js"><link rel="prefetch" href="/study-collection/assets/js/55.54b6a8aa.js"><link rel="prefetch" href="/study-collection/assets/js/56.577752fb.js"><link rel="prefetch" href="/study-collection/assets/js/57.9e7a21d7.js"><link rel="prefetch" href="/study-collection/assets/js/58.fff02f68.js"><link rel="prefetch" href="/study-collection/assets/js/59.6c090068.js"><link rel="prefetch" href="/study-collection/assets/js/6.3db93405.js"><link rel="prefetch" href="/study-collection/assets/js/60.477344e5.js"><link rel="prefetch" href="/study-collection/assets/js/61.17820ec0.js"><link rel="prefetch" href="/study-collection/assets/js/62.c1933a99.js"><link rel="prefetch" href="/study-collection/assets/js/63.c9335574.js"><link rel="prefetch" href="/study-collection/assets/js/64.d0a9ffbd.js"><link rel="prefetch" href="/study-collection/assets/js/65.da7cb4b4.js"><link rel="prefetch" href="/study-collection/assets/js/66.b56e1e5b.js"><link rel="prefetch" href="/study-collection/assets/js/67.6e203129.js"><link rel="prefetch" href="/study-collection/assets/js/68.e9d9faca.js"><link rel="prefetch" href="/study-collection/assets/js/69.e6ad30d2.js"><link rel="prefetch" href="/study-collection/assets/js/7.e5576656.js"><link rel="prefetch" href="/study-collection/assets/js/70.e529b11c.js"><link rel="prefetch" href="/study-collection/assets/js/71.ee6f67da.js"><link rel="prefetch" href="/study-collection/assets/js/72.c53f7c57.js"><link rel="prefetch" href="/study-collection/assets/js/73.dddbdfbb.js"><link rel="prefetch" href="/study-collection/assets/js/74.1df982da.js"><link rel="prefetch" href="/study-collection/assets/js/75.fbfe3a30.js"><link rel="prefetch" href="/study-collection/assets/js/76.b200f265.js"><link rel="prefetch" href="/study-collection/assets/js/77.bb13ac73.js"><link rel="prefetch" href="/study-collection/assets/js/78.814d891e.js"><link rel="prefetch" href="/study-collection/assets/js/79.2cf068cf.js"><link rel="prefetch" href="/study-collection/assets/js/8.5a749143.js"><link rel="prefetch" href="/study-collection/assets/js/80.a452842c.js"><link rel="prefetch" href="/study-collection/assets/js/81.33f7059e.js"><link rel="prefetch" href="/study-collection/assets/js/82.43d5287c.js"><link rel="prefetch" href="/study-collection/assets/js/83.af592b36.js"><link rel="prefetch" href="/study-collection/assets/js/84.8a9a7d6f.js"><link rel="prefetch" href="/study-collection/assets/js/85.29280fc3.js"><link rel="prefetch" href="/study-collection/assets/js/86.4ba0c0a3.js"><link rel="prefetch" href="/study-collection/assets/js/87.1b717c01.js"><link rel="prefetch" href="/study-collection/assets/js/88.9c8efca0.js"><link rel="prefetch" href="/study-collection/assets/js/89.14c42929.js"><link rel="prefetch" href="/study-collection/assets/js/9.4dfc86ed.js"><link rel="prefetch" href="/study-collection/assets/js/90.ddb1a215.js"><link rel="prefetch" href="/study-collection/assets/js/91.9d2ce618.js"><link rel="prefetch" href="/study-collection/assets/js/92.aa0ea11a.js"><link rel="prefetch" href="/study-collection/assets/js/93.ce34dfda.js"><link rel="prefetch" href="/study-collection/assets/js/94.d5075931.js"><link rel="prefetch" href="/study-collection/assets/js/95.8e1ca184.js"><link rel="prefetch" href="/study-collection/assets/js/96.e7792d98.js"><link rel="prefetch" href="/study-collection/assets/js/97.8081588e.js"><link rel="prefetch" href="/study-collection/assets/js/98.85e44e46.js"><link rel="prefetch" href="/study-collection/assets/js/99.6b7cfe0c.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.69cdfe8d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>TDD By Example</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>카프카 스트림즈 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/kafka-streams-in-action/01.html" class="sidebar-link">1장 카프카 스트림즈에 오신 것을 환영합니다</a></li><li><a href="/study-collection/book/kafka-streams-in-action/02.html" class="sidebar-link">2장 빠르게 살펴보는 카프카</a></li><li><a href="/study-collection/book/kafka-streams-in-action/03.html" class="sidebar-link">3장 카프카 스트림즈 개발</a></li><li><a href="/study-collection/book/kafka-streams-in-action/04.html" class="active sidebar-link">4장 스트림과 상태</a></li><li><a href="/study-collection/book/kafka-streams-in-action/05.html" class="sidebar-link">5장 KTable API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/06.html" class="sidebar-link">6장 프로세서 API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/07.html" class="sidebar-link">7장 모니터링과 성능</a></li><li><a href="/study-collection/book/kafka-streams-in-action/08.html" class="sidebar-link">8장 카프카 스트림즈 어플리케이션 테스트</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>모던 자바 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>객체지향의 사실과 오해</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>뇌를 자극하는 윈도우즈 시스템 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링5를 활용한 리액티브 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>코틀린 완벽 가이드</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>끄적끄적</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4강"><a href="#_4강" class="header-anchor">#</a> 4강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-이벤트">1. 이벤트</a><ul><li><a href="#_1-1-스트림은-상태가-필요하다">1-1. 스트림은 상태가 필요하다</a></li></ul></li><li><a href="#_2-카프카-스트림즈에-상태를-가진-작업-적용하기">2. 카프카 스트림즈에 상태를 가진 작업 적용하기</a><ul><li><a href="#_2-1-transformvalues-프로세서">2-1. transformValues 프로세서</a></li><li><a href="#_2-2-고객-보상의-상태-유지">2-2. 고객 보상의 상태 유지</a></li><li><a href="#_2-3-값-변환기-초기화">2-3. 값 변환기 초기화</a></li><li><a href="#_2-4-상태를-사용해-purchase-객체를-rewardaccumulator에-매핑하기">2-4. 상태를 사용해 Purchase 객체를 RewardAccumulator에 매핑하기</a></li><li><a href="#_2-5-보상-프로세서-업데이트">2-5. 보상 프로세서 업데이트</a></li></ul></li><li><a href="#_3-조회와-이전에-본-데이터에-상태-저장소-사용하기">3. 조회와 이전에 본 데이터에 상태 저장소 사용하기</a><ul><li><a href="#_3-1-데이터-지역성">3-1. 데이터 지역성</a></li><li><a href="#_3-2-실패-복구와-내결함성">3-2. 실패 복구와 내결함성</a></li><li><a href="#_3-3-카프카-스트림즈에서-상태-저장소-사용하기">3-3. 카프카 스트림즈에서 상태 저장소 사용하기</a></li><li><a href="#_3-4-추가적인-키-값-저장소-공급자">3-4. 추가적인 키/값 저장소 공급자</a></li><li><a href="#_3-5-상태-저장소의-내결함성">3-5. 상태 저장소의 내결함성</a></li><li><a href="#_3-6-변경로그-토픽-설정하기">3-6. 변경로그 토픽 설정하기</a></li></ul></li><li><a href="#_4-추가적인-통찰을-위해-스트림-조인하기">4. 추가적인 통찰을 위해 스트림 조인하기</a><ul><li><a href="#_4-1-데이터-설정">4-1. 데이터 설정</a></li><li><a href="#_4-2-조인을-수행하기-위해-고객-id를-포함한-키-생성하기">4-2. 조인을 수행하기 위해 고객 ID를 포함한 키 생성하기</a></li><li><a href="#_4-3-조인-구성하기">4-3. 조인 구성하기</a></li><li><a href="#_4-4-그-밖의-조인-옵션">4-4. 그 밖의 조인 옵션</a></li></ul></li><li><a href="#_5-카프카-스트림즈의-타임-스탬프">5. 카프카 스트림즈의 타임 스탬프</a><ul><li><a href="#_5-1-제공된-timestampextractor-구현">5-1. 제공된 TimestampExtractor 구현</a></li><li><a href="#_5-2-wallclocktimestampextractor">5-2. WallclockTimestampExtractor</a></li><li><a href="#_5-3-사용자-정의-timestampextractor">5-3. 사용자 정의 TimestampExtractor</a></li><li><a href="#_5-4-timestampextractor-명시하기">5-4. TimestampExtractor 명시하기</a></li></ul></li><li><a href="#요약">요약</a></li></ul></div><p></p> <h2 id="_1-이벤트"><a href="#_1-이벤트" class="header-anchor">#</a> 1. 이벤트</h2> <h3 id="_1-1-스트림은-상태가-필요하다"><a href="#_1-1-스트림은-상태가-필요하다" class="header-anchor">#</a> 1-1. 스트림은 상태가 필요하다</h3> <ul><li>스트림 처리에서 추가된 문맥은 상태(state) 라고 부른다.</li> <li>상태와 스트림 처리의 개념이 서로 상충되는 것처럼 보일 수 있지만, 스트림 처리는 서로 관련이 없으며 발생했을 때 처리될 필요가 있는 개별 이벤트의 지속적인 흐름을 의미한다.</li> <li>상태의 개념은 데이터베이스 테이블 같은 정적 리소스 이미지를 생각하면 된다.</li></ul> <h2 id="_2-카프카-스트림즈에-상태를-가진-작업-적용하기"><a href="#_2-카프카-스트림즈에-상태를-가진-작업-적용하기" class="header-anchor">#</a> 2. 카프카 스트림즈에 상태를 가진 작업 적용하기</h2> <ul><li>기존 구조는 다음과 같다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_1.f7602017.jpg" alt="ks"></p> <ul><li>위의 그림에서, 보상은 단일 트랜잭션에 대한 보상만 처리해서 결과를 전달해 준다.</li> <li>프로세서에 상태를 추가한 경우 보상 포인트의 누적 수의 추적이 가능하다.</li> <li>transformValues를 사용해 상태가 없는 보상 프로세서를 상태가 있는 프로세서로 변환해 보면 된다.</li> <li>컨슈머에게 더 많은 정보를 주기 위해, 총 보너스 포인트와 구매간 걸린 시간을 추적한다.</li></ul> <h3 id="_2-1-transformvalues-프로세서"><a href="#_2-1-transformvalues-프로세서" class="header-anchor">#</a> 2-1. transformValues 프로세서</h3> <ul><li>가장 기본적인 상태 유지 함수는 KStream.transformValues 이다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_2.59710c49.jpg" alt="ks"></p> <ul><li>transformValues 프로세서는 로컬 상태에 저장된 정보를 사용하여 들어오는 레코드를 업데이트한다.</li> <li>위의 경우 고객 ID는 주어진 레코드의 상태를 검색하고 저장하는 데 사용한다.</li> <li>이 메소드는 의미상으론 KStream.mapValues()와 동일하지만, transformValues가 StateStore 인스턴스에 접근해 작업을 완료하는 차이접이 있다.</li></ul> <h3 id="_2-2-고객-보상의-상태-유지"><a href="#_2-2-고객-보상의-상태-유지" class="header-anchor">#</a> 2-2. 고객 보상의 상태 유지</h3> <ul><li>기존의 보상 프로세서는, KStream.mapValues() 메소드를 사용해 들어오는 Purchase 객체를 RewardAccumulator 객체로 매핑했다.</li> <li>RewardAccumulator 객체는 원래 트랜잭션의 고객 ID와 구매 총계라는 2개의 필드로 구성됐다.</li> <li>요구사항이 변경 되었으니, 포인트는 지마트 보상 프로그램과 연관된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RewardAccumulator</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> customerId<span class="token punctuation">;</span> <span class="token comment">// 고객 ID</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> puchaseTotal<span class="token punctuation">;</span> <span class="token comment">// 총 구매 금액</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentRewardPoints<span class="token punctuation">;</span> <span class="token comment">// 현재 보상 포인트</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>어플리케이션이 보상 토픽에서 레코드를 읽으면 컨슈머 어플리케이션은 보상을 분배하기 위해 총 포인트가 임곗값을 초과하는지 여부만 확인해 주면 된다.</li> <li>2개의 필드 totalRewardPoint와 daysFromLastPurchase를 추가해준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RewardAccumulator</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> customerId<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">double</span> puchaseTotal<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentRewardPoints<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">int</span> daysFromLastPurchase<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> totalRewardPoints<span class="token punctuation">;</span> <span class="token comment">// 총점을 추적하기 위해 추가된 필드</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>토폴로지 전체 구조는 따로 바뀌지 않지만, KStream.mapValues() 메소드 대신 KStream.transformValues() 메소드를 사용한다.</li> <li>두 가지 단계를 수행한다.
<ul><li>값 변환기를 초기화 한다.</li> <li>상태를 사용해 Purchase객체를 RewardAccumulator로 매핑힌다.</li></ul></li></ul> <h3 id="_2-3-값-변환기-초기화"><a href="#_2-3-값-변환기-초기화" class="header-anchor">#</a> 2-3. 값 변환기 초기화</h3> <ul><li>첫 번째 단계는 변환기의 init() 메소드에서 인스턴스 변수를 설정하거나 생성하는 것.</li> <li>init() 메소드에서 처리 토폴로지를 만들 때 생성된 상태 저장소를 찾는다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">KeyValueStore</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> stateStore<span class="token punctuation">;</span> <span class="token comment">// 인스턴스 변수</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> storeName<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">ProcessorContext</span> context<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token comment">// ProcessorContext에 로컬 참조 설정</span>
    stateStore <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getStateStore</span><span class="token punctuation">(</span>storeName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// storeName 변수로 StateStore 인스턴스를 찾음</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>변환기 클래스에서 KeyValueStore 타입으로 형 변환한다.</li></ul> <h3 id="_2-4-상태를-사용해-purchase-객체를-rewardaccumulator에-매핑하기"><a href="#_2-4-상태를-사용해-purchase-객체를-rewardaccumulator에-매핑하기" class="header-anchor">#</a> 2-4. 상태를 사용해 Purchase 객체를 RewardAccumulator에 매핑하기</h3> <ul><li>프로세서를 초기화 했으므로 상태를 사용해 Purchase 객체를 변환할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 고객 ID 별로 누적된 포인트가 있는지 확인한다<span class="token punctuation">.</span>
<span class="token number">2.</span> 현재 거래에 대한 포인트를 합산하고 합계를 표시한다<span class="token punctuation">.</span>
<span class="token number">3.</span> <span class="token class-name">RewardAccumulator</span> 의 보상 포인트를 새로운 총 보상 포인트로 설정한다<span class="token punctuation">.</span>
<span class="token number">4.</span> 고객 ID 별로 새 총점을 로컬 상태 저장소에 저장한다<span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RewardAccumulator</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Purchase</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RewardAccumulator</span> rewardAccumulator <span class="token operator">=</span>
        <span class="token class-name">RewardAccumulator</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// purchase에서 RewardAccumulator 객체 만들기</span>
    <span class="token class-name">Integer</span> accumulatedSoFar <span class="token operator">=</span>
        stateStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rewardAccumulator<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 고객 ID로 최신 누적 보상 포인트 가져오기</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>accumulatedSoFar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      rewardAccumulator<span class="token punctuation">.</span><span class="token function">addRewardPoints</span><span class="token punctuation">(</span>accumulatedSoFar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 누적된 숫자가 있으면 현재 합계에 추가</span>
    <span class="token punctuation">}</span>
    stateStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rewardAccumulator<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rewardAccumulator<span class="token punctuation">.</span><span class="token function">getTotalRewardPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 새로운 누적 포인트를 stateStore에 저장</span>

    <span class="token keyword">return</span> rewardAccumulator<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>transform() 메소드에서 먼저 Purchase 객체를 RewardAccumulator 로 매핑한다.</li> <li>이후에 변환 과정에서 상태가 들어가게 되는데, 키(고객ID)로 조회를 수행하고, 누적된 포인트에 현재 포인트를 추가해준다.</li> <li>이후 추가된 총포인트를 상태 저장소에 저장해 준다.</li> <li>이제 보상 프로세서를 업데이트 해줘야 하는데, 시작하기 전에 고객 ID로 모든 판매에 접근하고 있다는 사실을 고려해야 한다.</li> <li>주어진 고객에 대한 판매별 정보를 수집한다는 것은 해당 고객에 대한 모든 트랜잭션이 동일한 파티션에 있음을 의미한다.</li> <li>그런데 처음 카프카로 데이터가 들어갈 때 키가 없이 들어가, 라운드 로빈으로 데이터를 카프카로 할당해 줘서 꼬이는 문제가 발생 할 수 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_3.5d54f1ad.jpg" alt="ks"></p> <ul><li>즉 토픽이 한개가 아니라면, 키가 채워지지 않은 레코드가 라운드 로빈으로 카프카에 할당이 되고, 주어진 고객에 대한 트랜잭션이 동일한 파티션에 들어가지 않음을 의미한다.</li> <li>상태 저장소의 ID로 레코드를 조회해야 하기 때문에 동일한 파티션에 동일한 ID로 고객 거래를 배치해야 한다.</li> <li>그렇지 않으면 여러 파티션에 동일한 ID를 가진 고객이 분산되므로 동일한 고객을 여러 상태 저장소에서 조회해야 한다.</li> <li>헷갈리면 안되는게, 각 파티션에 자체 상태 저장소가 있는게 아니라 약간 각 파티션마다 저장소 할당영역이 있다고 생각하면 된다.</li> <li>위의 문제를 해결하는 방법으로는, 고객 ID로 데이터를 다시 분할해 준다.</li></ul> <h4 id="데이터-리파티셔닝"><a href="#데이터-리파티셔닝" class="header-anchor">#</a> 데이터 리파티셔닝</h4> <p><img src="/study-collection/assets/img/ks_4_4.3c3342d7.jpg" alt="ks"></p> <ul><li>레코드를 리파티셔닝하려면 먼저 원본 레코드의 키를 변경학거나 바꾼 다음 레코드를 새로운 토픽에 쓴다.</li> <li>이후에 해당 레코드를 다시 소비해준다.</li> <li>리파티셔닝의 결과로 해당 레코드가 원래 있던 곳과 다른 파티션애서 올 수도 있다.</li></ul> <h4 id="카프카-스트림즈의-리파티셔닝"><a href="#카프카-스트림즈의-리파티셔닝" class="header-anchor">#</a> 카프카 스트림즈의 리파티셔닝</h4> <p><img src="/study-collection/assets/img/ks_4_5.9571fdac.jpg" alt="ks"></p> <ul><li>카프카 스트림즈에서 리파티셔닝은 KStream.through()를 사용해 쉽게 수행할 수 있다.</li> <li>KStream.through()는 중간 토픽을 생성하고 현재 KSteam 인스턴스는 해당 토픽에 레코드를 기록한다.</li> <li>새로운 KStream 인스턴스는 해당 소스에 대해 동일한 중간 토픽을 사용해 through() 메소드 호출로 반환된다.</li> <li>중간 토픽을 사용하기 위해 내부적으로 싱크 노드와 소스노드를 만든다.</li> <li>싱크노드는 기존 KStream 인스턴스가 호출하는 자식 프로세서이고, 새로운 KStream 인스턴스는 레코드의 소스로 새로운 소스 노드를 사용한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RewardStreamPartitioner</span> streamPartitioner <span class="token operator">=</span> 
                <span class="token keyword">new</span> <span class="token class-name">RewardStreamPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// StreamPartitioner를 구현한 인스턴스 초기화</span>

<span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> transByCustomerStream <span class="token operator">=</span> 
                purchaseKStream<span class="token punctuation">.</span><span class="token function">through</span><span class="token punctuation">(</span><span class="token string">&quot;customer_transactions&quot;</span><span class="token punctuation">,</span>
                                        <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
                                                      purchaseSerde<span class="token punctuation">,</span>
                                                      streamPartitioner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// KStream.through로 KStream을 생성</span>
</code></pre></div><h4 id="streampartitioner-사용하기"><a href="#streampartitioner-사용하기" class="header-anchor">#</a> StreamPartitioner 사용하기</h4> <ul><li>일반적으로 파티션 할당은 객체의 해시값을 구해 파티션 수로 모듈러 연산을 한다.</li> <li>위의 경우는 Purchase 객체에 있는 고객 ID를 이용해 특정 고객의 모든 데이터가 동일한 상태저장소에 저장되어야 한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RewardsStreamPartitioner</span> <span class="token keyword">implements</span>
      <span class="token class-name">StreamPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span>
        <span class="token class-name">Purchase</span> value<span class="token punctuation">,</span>
        <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
      <span class="token comment">// 고객 ID로 파티션을 결정해 준다.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>이러한 간단한 데모를 보고 리파티셔닝을 남용하면 안된다. 리파티셔닝이 가끔 팔요하긴 하지만, 데이터가 중복되거나 프로세싱 오버헤드가 발생한다. 가능하면 mapValues(), transformValues(), 또는 flatMapValues()의 사용을 권장한다. map(), transform(), flatMap()은 자동으로 리파티셔닝을 유발할 수 있기 때문이다.</p></div> <h3 id="_2-5-보상-프로세서-업데이트"><a href="#_2-5-보상-프로세서-업데이트" class="header-anchor">#</a> 2-5. 보상 프로세서 업데이트</h3> <ul><li>위처럼 작업을 하고나면, 구매 객체를 고객 ID별로 분할된 토픽에 기록하는 새로운 처리노드를 생성한다.</li> <li>이 새로운 토픽은 곧 업데이트 되는 보상 프로세서의 소스가 된다.</li> <li>이제 동일한 아이디를 가진 고객은 같은 상태 저장소를 사용하게 된다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_6.99c4ce7b.jpg" alt="ks"></p> <ul><li>KStream.through()를 통해 생성된 새로운 Stream 인스턴스를 사용해 다음 코드로 보상 프로세서를 업데이트하고 상태를 가진 변환 접근법을 사용한다.</li> <li>즉 순서대로 보면, 마스킹 후에 들어오는 데이터를 쓰루 프로세서를 통해 리파티셔닝을 해서 같은 고객은 같은 파티션으로 모아주고, 보상 프로세서에서 이전 포인트 정보를 알기위해 로컬 스테이트를 추가해 준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RewardAccumulator</span><span class="token punctuation">&gt;</span></span> statefulRewardAccumulator <span class="token operator">=</span>
    transByCustomerStream<span class="token punctuation">.</span><span class="token function">transformValues</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">PurchaseRewardTransformer</span><span class="token punctuation">(</span>rewardsStateStoreName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        rewardsStateStoreName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 상태를 가진 변환 사용</span>
statefulRewardAccumulator<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;rewards&quot;</span><span class="token punctuation">,</span>
                              <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
                                       rewardAccumulatorSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 결과를 토픽에 기록</span>
</code></pre></div><ul><li>KStream.transformValues()를 사용해 상태가 없는 노드에 상태를 가진 프로세싱을 추가해 준다.</li></ul> <h2 id="_3-조회와-이전에-본-데이터에-상태-저장소-사용하기"><a href="#_3-조회와-이전에-본-데이터에-상태-저장소-사용하기" class="header-anchor">#</a> 3. 조회와 이전에 본 데이터에 상태 저장소 사용하기</h2> <h3 id="_3-1-데이터-지역성"><a href="#_3-1-데이터-지역성" class="header-anchor">#</a> 3-1. 데이터 지역성</h3> <ul><li>키 조회는 일반적으로 매우 빠르지만 원격 저장소를 사용하면 규모가 커지면 병목 현상이 발생해 대기시간이 길어진다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_7.51b22705.jpg" alt="ks"></p> <ul><li>위의 그림에서 외부 저장소와 네트워크 통신을 하는 것 보다, 로컬에서 데이터를 가져오기 위한 호출이 훨씬 더 빠르다.</li> <li>스트리밍 데이터는 수백만, 수억 개의 레코드를 처리하기 때문에 네트워크 지연이 발생할 가능성이 있으면 문제가 심해질 수 있다.</li> <li>어플리케이션의 각 서버나 노드는 개별 데이터 저장소가 있어야 한다.</li></ul> <h3 id="_3-2-실패-복구와-내결함성"><a href="#_3-2-실패-복구와-내결함성" class="header-anchor">#</a> 3-2. 실패 복구와 내결함성</h3> <ul><li>분산 어플리케이션의 경우 장애는 불가피하다.</li> <li>실패를 예방하기보단 실패나 재시작에서조차 신속하게 복구하는 데 중점을 둔다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_8.3662d83e.jpg" alt="ks"></p> <ul><li>위의 그림을 보면 각 프로세서에는 로컬 데이터 저장소가 있으며, 변경 로그 토픽은 상태 저장소를 백업하는 데 사용한다.</li></ul> <h3 id="_3-3-카프카-스트림즈에서-상태-저장소-사용하기"><a href="#_3-3-카프카-스트림즈에서-상태-저장소-사용하기" class="header-anchor">#</a> 3-3. 카프카 스트림즈에서 상태 저장소 사용하기</h3> <ul><li>상태 저장소를 추가하는 것은 Stores 클래스에서 정적 팩토리 메소드 중 하나를 사용해 StoreSupplier 인스턴스를 생성하는 작업</li> <li>상태 저장소를 사용자 정의하기 위한 두 가지 추가적인 클래스가 존재하는데, Materialized와 StoreBuilder 클래스이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> rewardStateStoreName <span class="token operator">=</span> <span class="token string">&quot;rewardsPointsStore&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">KeyValueBytesStoreSupplier</span> storeSupplier <span class="token operator">=</span> 
    <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">inMemoryKeyValueStore</span><span class="token punctuation">(</span>rewardsStateStroeName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// StateStore 공급자를 생성한다.</span>

<span class="token class-name">StoreBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> storeBuilder <span class="token operator">=</span> 
    <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">keyValueStoreBuilder</span><span class="token punctuation">(</span>storeSupplier<span class="token punctuation">,</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// StoreBuilder를 생성하고 키와 값의 타입 명시</span>

builder<span class="token punctuation">.</span><span class="token function">addStateStore</span><span class="token punctuation">(</span>storeBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 상태 저장소를 토폴로지에 추가한다. </span>
</code></pre></div><ul><li>먼저 인메모리 키/값 저장소를 제공하는 StoreSupplier를 생성한다.</li> <li>StoreBuilder를 생성하기 위한 매개변수로 StoreSupplier를 제공하고, 키 / 값 타입을 명시한다.</li> <li>StoreBuilder를 StreamBuilder에 제공해 토폴로지에 StateStore를 추가한다.</li> <li>rewardsPointStoreName 이라는 이름을 사용해 프로세서에서 상태를 사용할 수 있다.</li></ul> <h3 id="_3-4-추가적인-키-값-저장소-공급자"><a href="#_3-4-추가적인-키-값-저장소-공급자" class="header-anchor">#</a> 3-4. 추가적인 키/값 저장소 공급자</h3> <ul><li>Stores.inMemoryKeyValueStore 말고도 저장소 공급자를 추가할 수 있는 정적 메소드가 있다.</li> <li>Stores.persistentKeyValueStore</li> <li>Stores.persistentWindowStore</li> <li>Stores.lruMap</li> <li>Stores.persistentSessionStore</li> <li>모든 영구 StateStore 인스턴스가 록스DB를 사용해 로컬 스토리지를 제공한다.</li></ul> <h3 id="_3-5-상태-저장소의-내결함성"><a href="#_3-5-상태-저장소의-내결함성" class="header-anchor">#</a> 3-5. 상태 저장소의 내결함성</h3> <ul><li>모든 StateStoreSupplier 타입은 기본적으로 로깅이 활성화되어 있다.</li> <li>이 문맥에서 로깅은 저장소의 값을 백업하고 내결함성을 제공하기 위한 변경로그로 사용되는 카프카 토픽을 의미</li> <li>예를 들어, 카프카 스트림즈를 실행하는 머신이 실패했다고 가정하면, 서버를 복구하고 카프카 스트림즈 어플리케이션을 다시 시작하면 해당 인스턴스의 상태 저장소가 원래 내용으로 복원된다.</li></ul> <h3 id="_3-6-변경로그-토픽-설정하기"><a href="#_3-6-변경로그-토픽-설정하기" class="header-anchor">#</a> 3-6. 변경로그 토픽 설정하기</h3> <ul><li>상태 저장소에 대한 변경로그는 withLoggingEnabled(Map&lt;String, String&gt; config) 메소드를 통해 설정한다.</li> <li>맵 안에서 토픽에 대한 가능한 모든 설정 매개변수를 사용할 수 있다.</li> <li>상태 저장소에 대한 변경로그의 설정은 매우 중요하므로, 잘 알아 두어야 한다.</li> <li>하지만 카프카 스트림즈가 병경로그 토픽을 자동으로 생성해 주기때문에, 변경로그 토픽을 생성할 필요는 전혀없다.</li></ul> <hr> <ul><li>카프카 토픽을 사용하면 로그 세그먼트의 데이터 보존에 대한 기본 설정은 일주일이고 크기는 무제한이다.</li> <li>기본 클린업 정책은 delete</li> <li>변경로그 토픽이 10GB의 보존 크기와 2일간의 보존 기간을 갖도록 수정을 하는 코드는 다음과 같다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changeLogConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retention.ms&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;172800000&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retention.bytes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10000000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// StoreBuilder 를 사용할 때</span>
storeBuilder<span class="token punctuation">.</span><span class="token function">withLoggingEnabled</span><span class="token punctuation">(</span>changeLogConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Materialized 를 사용할 때</span>
<span class="token class-name">Materialized</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">inMemoryKeyValueStore</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">withLoggingEnabled</span><span class="token punctuation">(</span>changeLogConfigs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>클린업 정책을 compact로 바꾸고 싶다면 설정을 해주면 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changeLogConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retention.ms&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;172800000&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retention.bytes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10000000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cleanup.policy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compact,delete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-추가적인-통찰을-위해-스트림-조인하기"><a href="#_4-추가적인-통찰을-위해-스트림-조인하기" class="header-anchor">#</a> 4. 추가적인 통찰을 위해 스트림 조인하기</h2> <ul><li>새로운 이벤트를 만들기 위해 동일한 키를 이용해 스트림 2개에서 각기 다른 이벤트를 가져와 결합을 할 수 있다.</li> <li>이전에 했던 카페와 전자제품 프로세서 브랜치로 나눈 그림이다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_9.560d7d5a.jpg" alt="ks"></p> <ul><li>여기에 추가적인 기능을 넣어서, 커피를 사고 전자제품 상점에서 구매한 고객을 확인해 20분 내에 구매를 했으면, 두 번째 거래 직후 쿠폰을 지급하려고 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_10.52fa777c.jpg" alt="ks"></p> <ul><li>이러한 쿠폰 발행을 하고 발행 시기를 결정하기 위해선 전자제품 상점의 판매와 카페의 판매를 조인해야 한다.</li></ul> <h3 id="_4-1-데이터-설정"><a href="#_4-1-데이터-설정" class="header-anchor">#</a> 4-1. 데이터 설정</h3> <p><img src="/study-collection/assets/img/ks_4_11.91d47a66.jpg" alt="ks"></p> <ul><li>이전에 설정했던 분기 코드를 다시 사용한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> coffeePurchase <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    purchase<span class="token punctuation">.</span><span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;coffee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> electronicPurchase <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    purchase<span class="token punctuation">.</span><span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;electronics&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token keyword">int</span> COFFEE_PURCHASE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> ELECTRONICS_PURCHASE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> branchedTransactions <span class="token operator">=</span>
    transactionStream<span class="token punctuation">.</span><span class="token function">branch</span><span class="token punctuation">(</span>coffeePurchase<span class="token punctuation">,</span> electronicPurchase<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-2-조인을-수행하기-위해-고객-id를-포함한-키-생성하기"><a href="#_4-2-조인을-수행하기-위해-고객-id를-포함한-키-생성하기" class="header-anchor">#</a> 4-2. 조인을 수행하기 위해 고객 ID를 포함한 키 생성하기</h3> <ul><li>키를 생성하려면 스트림의 구매 데이터에서 고객 ID를 선택한다.</li> <li>원본 KStream 인스턴스(transactionStream)를 업데이트하고 해당 노드와 분기 노드사이에 다른 처리노드를 생성해야 한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> branchesStream <span class="token operator">=</span> 
    transactionStream<span class="token punctuation">.</span><span class="token function">selectKey</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> 
    v<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">branch</span><span class="token punctuation">(</span>coffePurchase<span class="token punctuation">,</span> electronicPurchase<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// selectKey 처리 노드 삽입.</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_4_12.8040cb82.jpg" alt="ks"></p> <ul><li>리파티셔닝을 따로 해주지 않았는데, 카프카 스트림즈에서 새로운 키를 생성하게 하는 메소드(selectKey, map, transform)를 호출할 때마다 내부 bool플래그가 true로 설정된다.</li> <li>새로운 KStream 인스턴스가 리파티셔닝이 필요하다는 사실을 알려주고, 이 부울 플래그를 사용해 조인, 리듀스 또는 집계 연산을 수행하면 자동으로 리파티셔닝을 처리한다.</li> <li>branch로 분기작업을 진행해도 각 KStream에도 리파티셔닝 플래그가 마찬가지로 설정된다.</li></ul> <h3 id="_4-3-조인-구성하기"><a href="#_4-3-조인-구성하기" class="header-anchor">#</a> 4-3. 조인 구성하기</h3> <ul><li>분기된 스트림 2개를 가져와서 KStream.join() 메소드로 조인한다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_13.4e190a9f.jpg" alt="ks"></p> <ul><li>조인 프로세서는 상태 저장소 2개를 사용해 다른 스트림의 레코드와 일치하는 항목을 검색한다.</li></ul> <h4 id="구매-레코드-조인하기"><a href="#구매-레코드-조인하기" class="header-anchor">#</a> 구매 레코드 조인하기</h4> <ul><li>조인된 레코드를 만들려면 ValueJoiner&lt;V1, V2, R&gt; 의 인스턴스를 생성해야 한다.</li> <li>ValueJoiner는 동일한 타입이거나 아닐 수도 있는 객체 2개를 사용하며, 타입이 다를 수 있는 단일 객체를 반환한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PurchaseJoiner</span>
      <span class="token keyword">implements</span> <span class="token class-name">ValueJoiner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Purchase</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">,</span> <span class="token class-name">CorrelatedPurchase</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CorrelatedPurchase</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Purchase</span> purchase<span class="token punctuation">,</span> <span class="token class-name">Purchase</span> otherPurchase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">CorrelatedPurchase</span><span class="token punctuation">.</span><span class="token class-name">Builder</span> builder <span class="token operator">=</span>
          <span class="token class-name">CorrelatedPurchase</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">Date</span> purchaseDate <span class="token operator">=</span>
          purchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> purchase<span class="token punctuation">.</span><span class="token function">getPurchaseDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token class-name">Double</span> price <span class="token operator">=</span> purchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> purchase<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> itemPurchased <span class="token operator">=</span>
          purchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> purchase<span class="token punctuation">.</span><span class="token function">getItemPurchased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token class-name">Date</span> otherPurchaseDate <span class="token operator">=</span>
          otherPurchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> otherPurchase<span class="token punctuation">.</span><span class="token function">getPurchaseDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token class-name">Double</span> otherPrice <span class="token operator">=</span>
          otherPurchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> otherPurchase<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

      <span class="token class-name">String</span> otherItemPurchased <span class="token operator">=</span>
          otherPurchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> otherPurchase<span class="token punctuation">.</span><span class="token function">getItemPurchased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> purchasedItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>itemPurchased <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        purchasedItems<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemPurchased<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>otherItemPurchased <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        purchasedItems<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>otherItemPurchased<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token class-name">String</span> customerId <span class="token operator">=</span>
          purchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> purchase<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token class-name">String</span> otherCustomerId <span class="token operator">=</span>
          otherPurchase <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> otherPurchase<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      builder<span class="token punctuation">.</span><span class="token function">withCustomerId</span><span class="token punctuation">(</span>customerId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> customerId <span class="token operator">:</span> otherCustome
          rId<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">withFirstPurchaseDate</span><span class="token punctuation">(</span>purchaseDate<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">withSecondPurchaseDate</span><span class="token punctuation">(</span>otherPurchaseDate<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">withItemsPurchased</span><span class="token punctuation">(</span>purchasedItems<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">withTotalAmount</span><span class="token punctuation">(</span>price <span class="token operator">+</span> otherPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>새로운 CorrelatedPurchase 빌더를 만들어서, 각각의 Purchase 객체 정보를 가져와 빌더로 합쳐서 조인시킨다.</li></ul> <h4 id="조인-구현하기"><a href="#조인-구현하기" class="header-anchor">#</a> 조인 구현하기</h4> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> coffeeStream <span class="token operator">=</span>
      branchesStream<span class="token punctuation">[</span>COFFEE_PURCHASE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 분기된 스트림 호출</span>
  <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> electronicsStream <span class="token operator">=</span>
      branchesStream<span class="token punctuation">[</span>ELECTRONICS_PURCHASE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token class-name">ValueJoiner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Purchase</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">,</span> <span class="token class-name">CorrelatedPurchase</span><span class="token punctuation">&gt;</span></span> purchaseJoiner <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">PurchaseJoiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">JoinWindows</span> twentyMinuteWindow <span class="token operator">=</span> <span class="token class-name">JoinWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CorrelatedPurchase</span><span class="token punctuation">&gt;</span></span> joinedKStream <span class="token operator">=</span>
      coffeeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>electronicsStream<span class="token punctuation">,</span>
          purchaseJoiner<span class="token punctuation">,</span>
          twentyMinuteWindow<span class="token punctuation">,</span>
          <span class="token class-name">Joined</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
              purchaseSerde<span class="token punctuation">,</span>
              purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 조인 구성</span>

  joinedKStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;joinedStream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>KStream.join 메소드에 4개의 매개변수를 제공한다.
<ul><li>electronicsStream : 조인할 전자 구매 스트림</li> <li>purchaseJoiner : ValueJoiner&lt;V1, V2, R&gt; 인터페이스의 구현.</li> <li>twentyMinuteWindow : JoinWindows 인스턴스. JoinWindows.of 메소드는 조인에 포함될 두 값 사이의 최대 시간 차이를 지정한다.</li> <li>Joined 인스턴스 : 조인을 수행하기 위한 선택적 매개변수 제공.</li></ul></li> <li>구매가 20분이내에 이뤄져야 하는 상황인데, 순서를 따로 정하려면 2개의 추가 메소드 설정이 필요하다.
<ul><li>JoinWindows.after : streamA.join(streamB, ..., twentyMinuteWindow.after(5000), ...) -&gt; streamB 가 A의 5초뒤까지 타임스탬프가 찍혀야 된다고 설정해주는 것</li> <li>JoinWIndows.befeor : 반대로 A 스트림이 B 5초 이전에 타임스탬프가 찍혀야 한다</li></ul></li></ul> <h4 id="코파티셔닝"><a href="#코파티셔닝" class="header-anchor">#</a> 코파티셔닝</h4> <ul><li>카프카 스트림즈에서 조인을 수행하려면 모든 조인 참가자가 코파티셔닝되어 있음을 보장해야 한다.</li> <li>같은 수의 참가자가 있고 같은 타입의 키가 있음을 말한다.</li></ul> <h3 id="_4-4-그-밖의-조인-옵션"><a href="#_4-4-그-밖의-조인-옵션" class="header-anchor">#</a> 4-4. 그 밖의 조인 옵션</h3> <h4 id="외부-조인"><a href="#외부-조인" class="header-anchor">#</a> 외부 조인</h4> <ul><li>외부 조인은 항상 레코드를 출력하며, 전달된 조인 레코드는 조인에서 명시한 두 이벤트 모두가 포함되지 않을 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>coffeeStream<span class="token punctuation">.</span><span class="token function">outerJoin</span><span class="token punctuation">(</span>electronicsStream<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_4_14.fd8602de.jpg" alt="ks"></p> <h4 id="왼쪽-외부-조인"><a href="#왼쪽-외부-조인" class="header-anchor">#</a> 왼쪽 외부 조인</h4> <ul><li>흔히 아는 left outer join.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>coffeeStream<span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>electronicsStream<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_4_15.dbde8dfa.jpg" alt="ks"></p> <h2 id="_5-카프카-스트림즈의-타임-스탬프"><a href="#_5-카프카-스트림즈의-타임-스탬프" class="header-anchor">#</a> 5. 카프카 스트림즈의 타임 스탬프</h2> <ul><li>타임스탬프는 카프카 스트림즈 기능의 핵심 영역에서 다음과 같은 역할 담당
<ul><li>스트림 조인</li> <li>변경로그 업데이트(KTable API)</li> <li>Processor.punctuate() 메소드가 언제 작동할지 결정</li></ul></li> <li>스트림 처리에서 타임스탬프를 3가지 범주로 나눌 수 있다.
<ul><li>이벤트 시간 : 이벤트가 발생했을 때 설정한 타임스탬프. 예제에선 ProducerRecord를 생성할 때 타임스탬프</li> <li>인제스트 시간 : 데이터가 처음 데이터 처리 파이프라인에 들어갈 때 설정되는 타임스탬프. 카프카 브로커가 설정한 타임스탬프라고 보면됨</li> <li>처리 시간 : 데이터나 이벤트 레코드가 처음 처리 파이프라인을 통과하기 시작할 때 설정된 타임스탬프</li></ul></li></ul> <p><img src="/study-collection/assets/img/ks_4_16.ea47c1a2.jpg" alt="ks"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>클라이언트와 브로커가 동일한 시간대가 아닐 수 있으므로, 타임스탬프를 사용하는 경우 UTC 표준 시간대 등으로 표준화 하는것이 안전하다.</p></div> <ul><li>타임스탬프 처리 시맨틱의 세 가지 경우를 고려해보자
<ul><li>실제 이벤트나 메세지 객체에 포함된 타임스탬프 (이벤트 시간 시맨틱)</li> <li>ProducerRecord(이벤트 시간 시맨틱)를 생성할 때 레코드 메타데이터에 설정된 타임 스팀프 사용</li> <li>카프카 스트림즈 어플리케이션이 레코드를 인제스트할 때 현재 타임스탬프(현재 로컬시간)를 사용(처리 시간 시맨틱)</li></ul></li> <li>이벤트 시간 시맨틱은 ProducerRecord에 의해 메타데이터에 배치된 타임스탬프를 사용하는 것으로 충분하지만, 다른 요구가 생길 경우가 있을 수 있다.
<ul><li>메세지 객체에 타임스탬프가 기록된 이벤트로 카프카에 메세지를 보내고 있다. 카프카 프로듀서가 이러한 이벤트 객체를 사용할 수 있게 되는 데 약간의 시간이 소요되므로 메세지 객체에 내장된 타임스탬프만 고려해야 할 수 있다.</li> <li>카프카 스트림즈 어플리케이션이 레코드의 타임스탬프를 사용하는 대신 레코드를 소비하는 시간을 고려하고 싶다.</li></ul></li> <li>위에처럼 다양한 처리 시맨틱을 가능하게 하기 위해 하나의 abstract 구현과 네 가지 구현체가 잇는 TimestampExtractor 인터페이스를 제공한다.</li></ul> <h3 id="_5-1-제공된-timestampextractor-구현"><a href="#_5-1-제공된-timestampextractor-구현" class="header-anchor">#</a> 5-1. 제공된 TimestampExtractor 구현</h3> <ul><li>제공된 TimestampExtractor는 거의 모든 부분은 메세지 메타데이터에 있는 프로듀서나 브로커가 설정한 타임스탬프를 다룬다.</li> <li>그러므로 이벤트 시간 처리 시맨틱 (프로듀서가 설정한 타임스탬프) 이나 로그 추가 시간 처리 시맨틱 (브로커가 설정한 타임 스탬프) 을 사용할 수 있다.</li> <li>아래는 ConsumerRecord 객체에서 타임스탬프를 가져오는 그림이다.</li></ul> <p><img src="/study-collection/assets/img/ks_4_17.1fdd8551.jpg" alt="ks"></p> <ul><li>ExtractRecordMetadataTimestamp는 ConsumerRecord에서 메타 데이터 타임 스탬프를 추출하는 기능을 제공하는 추상 클래스</li> <li>ExtractRecordMetadataTimestamp를 확장한 클래스의 목록은 다음과 같다
<ul><li>FailOnInvalidTimestamp : 유효하지 않은 타임스탬프 예외 발생</li> <li>LogAndSkipOnInvalidTimestamp : 유효하지 않은 타임스탬프 예외 발생하고, 레코드가 삭제된다는 경고 메세지 남김</li> <li>UsePreviousTimeOnInvalidTimestamp : 유효하지 않은 타임스탬프의 경우 마지막으로 추출한 유효한 타임스탬프를 반환</li></ul></li></ul> <h3 id="_5-2-wallclocktimestampextractor"><a href="#_5-2-wallclocktimestampextractor" class="header-anchor">#</a> 5-2. WallclockTimestampExtractor</h3> <ul><li>WallclockTimestampExtractor는 처리 시간 시맨틱을 제공하고, 타임스탬프를 추출하진 않지만 System.currentTimeMills() 메소드를 호출해 밀리초 단위의 시간을 반환한다.</li></ul> <h3 id="_5-3-사용자-정의-timestampextractor"><a href="#_5-3-사용자-정의-timestampextractor" class="header-anchor">#</a> 5-3. 사용자 정의 TimestampExtractor</h3> <p><img src="/study-collection/assets/img/ks_4_18.36644d98.jpg" alt="ks"></p> <ul><li>사용자 정의 TimestampExtractor는 ConsumerRecord 객체에서 타임스탬프를 뽑아내는 위치를 안다.</li> <li>사용자 정의 TimestampExtractor는 ConsumerRecord 객체에 포함된 값을 기반으로 타임스탬프를 제공한다.</li> <li>이 타임스탬프는 기존 값이거나, 값 객체에 포함된 속성에서 계산된 타임스탬프</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionTimestampExtractor</span> <span class="token keyword">implements</span> <span class="token class-name">TimestampExtractor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span>
        <span class="token keyword">long</span> previousTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Purchase</span> purchaseTransaction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Purchase</span><span class="token punctuation">)</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 카프카에 보내진 키/값 쌍에서 Purchase 객체를 찾는다.</span>
      <span class="token keyword">return</span> purchaseTransaction<span class="token punctuation">.</span><span class="token function">getPurchaseDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 구매 시점에 기록된 타임스탬프 반환</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-4-timestampextractor-명시하기"><a href="#_5-4-timestampextractor-명시하기" class="header-anchor">#</a> 5-4. TimestampExtractor 명시하기</h3> <ul><li>어플리케이션에 어떠한 TimestampExtractor를 사용할 지 알려주어야 한다.</li> <li>첫 번째 방법은 카프카 스트림즈 어플리케이션을 설정할 때 속성에 전역 타임스탬프 추출기를 넣어주는 방법이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>DEFAULT_TIMESTAMP_EXTRACTOR_CLASS_CONFIG<span class="token punctuation">,</span>
    <span class="token class-name">TransactionTimestampExtractor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>두 번째 방법은 Consumed 객체를 통해 TimestampExtractor 인스턴스를 제공해준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">withTimestampExtractor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionTimestampExtractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>두 번째 방법은 입력 소스마다 원하는 TimestampExtractor를 설정해 줄 수있다.</li></ul> <h2 id="요약"><a href="#요약" class="header-anchor">#</a> 요약</h2> <ul><li>스트림 처리는 상태가 필요하다. 때로는 이벤트가 독자적으로 진행될 수 있지만, 보통 좋은 결정을 내리기 위해서는 추가 정보가 필요하다.</li> <li>카프카 스트림즈는 조인을 포함해 상태 변환에 유용한 추상화를 제공</li> <li>카프카 스트림즈의 상태 저장소는 데이터 지역성과 내결함성 같은 스트림 처리에 필요한 상태 유형을 제공</li> <li>타임스탬프는 카프카 스트림즈에서 데이터 흐름을 제어. 타임스탬프 소스의 선택은 신중하게 고려</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/kafka-streams-in-action/03.html" class="prev">3장 카프카 스트림즈 개발</a></span> <span class="next"><a href="/study-collection/book/kafka-streams-in-action/05.html">5장 KTable API</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.c868891f.js" defer></script><script src="/study-collection/assets/js/2.18806e4e.js" defer></script><script src="/study-collection/assets/js/5.ae8549cb.js" defer></script>
  </body>
</html>
