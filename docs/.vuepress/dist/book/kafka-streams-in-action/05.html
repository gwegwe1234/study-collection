<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.48760978.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.65d03ea7.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.f504b8bc.js" as="script"><link rel="preload" href="/study-collection/assets/js/7.bf4d57cc.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.41791bdb.js"><link rel="prefetch" href="/study-collection/assets/js/100.3a5883ac.js"><link rel="prefetch" href="/study-collection/assets/js/101.db21ac59.js"><link rel="prefetch" href="/study-collection/assets/js/102.e73dc207.js"><link rel="prefetch" href="/study-collection/assets/js/103.441a913e.js"><link rel="prefetch" href="/study-collection/assets/js/104.7a705b88.js"><link rel="prefetch" href="/study-collection/assets/js/105.9a17fa3f.js"><link rel="prefetch" href="/study-collection/assets/js/106.f6292fb6.js"><link rel="prefetch" href="/study-collection/assets/js/107.2d3d76e6.js"><link rel="prefetch" href="/study-collection/assets/js/108.d5d0f45b.js"><link rel="prefetch" href="/study-collection/assets/js/109.77437451.js"><link rel="prefetch" href="/study-collection/assets/js/11.caa8ceaa.js"><link rel="prefetch" href="/study-collection/assets/js/110.adcbee07.js"><link rel="prefetch" href="/study-collection/assets/js/111.f7cc14f4.js"><link rel="prefetch" href="/study-collection/assets/js/112.62dbe207.js"><link rel="prefetch" href="/study-collection/assets/js/113.08d9a8c3.js"><link rel="prefetch" href="/study-collection/assets/js/114.cd885318.js"><link rel="prefetch" href="/study-collection/assets/js/115.0072620f.js"><link rel="prefetch" href="/study-collection/assets/js/116.921e42e4.js"><link rel="prefetch" href="/study-collection/assets/js/117.81ac7ea3.js"><link rel="prefetch" href="/study-collection/assets/js/118.e5fadc3f.js"><link rel="prefetch" href="/study-collection/assets/js/119.a6cb9093.js"><link rel="prefetch" href="/study-collection/assets/js/12.7912686e.js"><link rel="prefetch" href="/study-collection/assets/js/120.197b75bc.js"><link rel="prefetch" href="/study-collection/assets/js/121.855786de.js"><link rel="prefetch" href="/study-collection/assets/js/122.32b23b66.js"><link rel="prefetch" href="/study-collection/assets/js/13.6662360c.js"><link rel="prefetch" href="/study-collection/assets/js/14.48818be1.js"><link rel="prefetch" href="/study-collection/assets/js/15.79be0a3f.js"><link rel="prefetch" href="/study-collection/assets/js/16.738ed49a.js"><link rel="prefetch" href="/study-collection/assets/js/17.c63720b3.js"><link rel="prefetch" href="/study-collection/assets/js/18.fc8a1bc3.js"><link rel="prefetch" href="/study-collection/assets/js/19.3966bd0d.js"><link rel="prefetch" href="/study-collection/assets/js/20.0e4f7e23.js"><link rel="prefetch" href="/study-collection/assets/js/21.74f821a8.js"><link rel="prefetch" href="/study-collection/assets/js/22.006d7492.js"><link rel="prefetch" href="/study-collection/assets/js/23.bc6125f8.js"><link rel="prefetch" href="/study-collection/assets/js/24.bea7de70.js"><link rel="prefetch" href="/study-collection/assets/js/25.963bf479.js"><link rel="prefetch" href="/study-collection/assets/js/26.8a64689d.js"><link rel="prefetch" href="/study-collection/assets/js/27.235380e9.js"><link rel="prefetch" href="/study-collection/assets/js/28.1f1c72b6.js"><link rel="prefetch" href="/study-collection/assets/js/29.58e051c5.js"><link rel="prefetch" href="/study-collection/assets/js/3.f7bb52fb.js"><link rel="prefetch" href="/study-collection/assets/js/30.56915c0a.js"><link rel="prefetch" href="/study-collection/assets/js/31.bdc1e66f.js"><link rel="prefetch" href="/study-collection/assets/js/32.3cda140b.js"><link rel="prefetch" href="/study-collection/assets/js/33.7e8cb48a.js"><link rel="prefetch" href="/study-collection/assets/js/34.ff8ddf04.js"><link rel="prefetch" href="/study-collection/assets/js/35.ebb2c76d.js"><link rel="prefetch" href="/study-collection/assets/js/36.271f97b6.js"><link rel="prefetch" href="/study-collection/assets/js/37.b8217726.js"><link rel="prefetch" href="/study-collection/assets/js/38.46be2fc6.js"><link rel="prefetch" href="/study-collection/assets/js/39.5c1f2525.js"><link rel="prefetch" href="/study-collection/assets/js/4.be408479.js"><link rel="prefetch" href="/study-collection/assets/js/40.1239d9d7.js"><link rel="prefetch" href="/study-collection/assets/js/41.8723ba9a.js"><link rel="prefetch" href="/study-collection/assets/js/42.c9ec46a4.js"><link rel="prefetch" href="/study-collection/assets/js/43.96289944.js"><link rel="prefetch" href="/study-collection/assets/js/44.7481c1c9.js"><link rel="prefetch" href="/study-collection/assets/js/45.94122945.js"><link rel="prefetch" href="/study-collection/assets/js/46.5c443226.js"><link rel="prefetch" href="/study-collection/assets/js/47.b414e5a9.js"><link rel="prefetch" href="/study-collection/assets/js/48.b6312261.js"><link rel="prefetch" href="/study-collection/assets/js/49.792a269b.js"><link rel="prefetch" href="/study-collection/assets/js/5.9a3d93a0.js"><link rel="prefetch" href="/study-collection/assets/js/50.f7732566.js"><link rel="prefetch" href="/study-collection/assets/js/51.ed4523d7.js"><link rel="prefetch" href="/study-collection/assets/js/52.f77b286c.js"><link rel="prefetch" href="/study-collection/assets/js/53.d969fac2.js"><link rel="prefetch" href="/study-collection/assets/js/54.16e6404a.js"><link rel="prefetch" href="/study-collection/assets/js/55.d7bc2f95.js"><link rel="prefetch" href="/study-collection/assets/js/56.9906ceb8.js"><link rel="prefetch" href="/study-collection/assets/js/57.4826cb9d.js"><link rel="prefetch" href="/study-collection/assets/js/58.53810a11.js"><link rel="prefetch" href="/study-collection/assets/js/59.597a6568.js"><link rel="prefetch" href="/study-collection/assets/js/6.d972300e.js"><link rel="prefetch" href="/study-collection/assets/js/60.bba2fc52.js"><link rel="prefetch" href="/study-collection/assets/js/61.cc2592b0.js"><link rel="prefetch" href="/study-collection/assets/js/62.59a4b1e8.js"><link rel="prefetch" href="/study-collection/assets/js/63.9f90cff7.js"><link rel="prefetch" href="/study-collection/assets/js/64.fcab4508.js"><link rel="prefetch" href="/study-collection/assets/js/65.06cd00a9.js"><link rel="prefetch" href="/study-collection/assets/js/66.59798667.js"><link rel="prefetch" href="/study-collection/assets/js/67.9b570a86.js"><link rel="prefetch" href="/study-collection/assets/js/68.f285d15a.js"><link rel="prefetch" href="/study-collection/assets/js/69.59f2b82a.js"><link rel="prefetch" href="/study-collection/assets/js/70.4d509565.js"><link rel="prefetch" href="/study-collection/assets/js/71.380eb6fe.js"><link rel="prefetch" href="/study-collection/assets/js/72.19e9c587.js"><link rel="prefetch" href="/study-collection/assets/js/73.a7a308b0.js"><link rel="prefetch" href="/study-collection/assets/js/74.c221c038.js"><link rel="prefetch" href="/study-collection/assets/js/75.617d2890.js"><link rel="prefetch" href="/study-collection/assets/js/76.22584d85.js"><link rel="prefetch" href="/study-collection/assets/js/77.ce32320b.js"><link rel="prefetch" href="/study-collection/assets/js/78.2730a58a.js"><link rel="prefetch" href="/study-collection/assets/js/79.2a59303d.js"><link rel="prefetch" href="/study-collection/assets/js/8.281855fd.js"><link rel="prefetch" href="/study-collection/assets/js/80.b8321bde.js"><link rel="prefetch" href="/study-collection/assets/js/81.a01aef60.js"><link rel="prefetch" href="/study-collection/assets/js/82.ec1772b3.js"><link rel="prefetch" href="/study-collection/assets/js/83.64090e4a.js"><link rel="prefetch" href="/study-collection/assets/js/84.80a36bcf.js"><link rel="prefetch" href="/study-collection/assets/js/85.46dd6640.js"><link rel="prefetch" href="/study-collection/assets/js/86.aacce767.js"><link rel="prefetch" href="/study-collection/assets/js/87.4401214c.js"><link rel="prefetch" href="/study-collection/assets/js/88.988e6cca.js"><link rel="prefetch" href="/study-collection/assets/js/89.1c0abc67.js"><link rel="prefetch" href="/study-collection/assets/js/9.1d201326.js"><link rel="prefetch" href="/study-collection/assets/js/90.40c5c586.js"><link rel="prefetch" href="/study-collection/assets/js/91.21207215.js"><link rel="prefetch" href="/study-collection/assets/js/92.929ab16d.js"><link rel="prefetch" href="/study-collection/assets/js/93.0c2f8a47.js"><link rel="prefetch" href="/study-collection/assets/js/94.a0557841.js"><link rel="prefetch" href="/study-collection/assets/js/95.8ccd9537.js"><link rel="prefetch" href="/study-collection/assets/js/96.713dd8f7.js"><link rel="prefetch" href="/study-collection/assets/js/97.2c7e8281.js"><link rel="prefetch" href="/study-collection/assets/js/98.916f6105.js"><link rel="prefetch" href="/study-collection/assets/js/99.c759b84e.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.48760978.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>카프카 스트림즈 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/kafka-streams-in-action/01.html" class="sidebar-link">1장 카프카 스트림즈에 오신 것을 환영합니다</a></li><li><a href="/study-collection/book/kafka-streams-in-action/02.html" class="sidebar-link">2장 빠르게 살펴보는 카프카</a></li><li><a href="/study-collection/book/kafka-streams-in-action/03.html" class="sidebar-link">3장 카프카 스트림즈 개발</a></li><li><a href="/study-collection/book/kafka-streams-in-action/04.html" class="sidebar-link">4장 스트림과 상태</a></li><li><a href="/study-collection/book/kafka-streams-in-action/05.html" class="active sidebar-link">5장 KTable API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/06.html" class="sidebar-link">6장 프로세서 API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/07.html" class="sidebar-link">7장 모니터링과 성능</a></li><li><a href="/study-collection/book/kafka-streams-in-action/08.html" class="sidebar-link">8장 카프카 스트림즈 어플리케이션 테스트</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>모던 자바 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>객체지향의 사실과 오해</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_5강"><a href="#_5강" class="header-anchor">#</a> 5강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-스트림과-테이블의-관계">1. 스트림과 테이블의 관계</a><ul><li><a href="#_1-1-레코드스트림">1-1. 레코드스트림</a></li><li><a href="#_1-2-레코드-및-변경로그-업데이트">1-2. 레코드 및 변경로그 업데이트</a></li><li><a href="#_1-3-이벤트-스트림과-업데이트-스트림-비교">1-3. 이벤트 스트림과 업데이트 스트림 비교</a></li></ul></li><li><a href="#_2-레코드-업데이트와-ktable-구성">2. 레코드 업데이트와 KTable 구성</a><ul><li><a href="#_2-1-캐시-버퍼-크기-설정하기">2-1. 캐시 버퍼 크기 설정하기</a></li><li><a href="#_2-2-커밋-주기-설정하기">2-2. 커밋 주기 설정하기</a></li></ul></li><li><a href="#_3-집계와-윈도-작업">3. 집계와 윈도 작업</a><ul><li><a href="#_3-1-업계별-거래량-집계">3-1. 업계별 거래량 집계</a></li><li><a href="#_3-2-윈도-연산">3-2. 윈도 연산</a></li><li><a href="#_3-3-kstream과-ktable-조인하기">3-3. KStream과 KTable 조인하기</a></li><li><a href="#_3-4-globalktable">3-4. GlobalKTable</a></li><li><a href="#_3-5-쿼리-가능-상태">3-5. 쿼리 가능 상태</a></li></ul></li><li><a href="#요약">요약</a></li></ul></div><p></p> <h2 id="_1-스트림과-테이블의-관계"><a href="#_1-스트림과-테이블의-관계" class="header-anchor">#</a> 1. 스트림과 테이블의 관계</h2> <h3 id="_1-1-레코드스트림"><a href="#_1-1-레코드스트림" class="header-anchor">#</a> 1-1. 레코드스트림</h3> <ul><li>일련의 주가 업데이트를 본다고 가정하자.</li></ul> <p><img src="/study-collection/assets/img/ks_5_1.564c224e.jpg" alt="ks"></p> <ul><li>각각의 주가 시세는 개별 이벤트이고 서로 관련이 없다.</li> <li>같은 회사의 시세 정보가 다수 차지하더라도, 한 번에 하나씩만 보고 있다.</li> <li>이 이벤트 뷰는 KStream이 작동하는 방식인 레코드의 스트림이다.</li> <li>이제 이 개념이 데이터베이스 테이블과 관련지어보면 아래와 같이 나온다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_2.f0b6f40e.jpg" alt="ks"></p> <ul><li>표에서 행은 키/값 쌍으로 재구성 할 수 있다.</li> <li>이제 이 레코드 스트림과 표를 같이 표현해보자.</li> <li>각 레코드는 독립적으로 있기 때문에 테이블에 삽입하는 것으로 스트림을 표현해 준다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_3.4c3c5afa.jpg" alt="ks"></p> <ul><li>테이블 삽입과 이벤트 스트림을 같은 색상으로 함께 볼 수 있다는 것인데, 이벤트를 처리하는 스트림 사용에 대해 더 깊이 이해할 수 있다.</li></ul> <h3 id="_1-2-레코드-및-변경로그-업데이트"><a href="#_1-2-레코드-및-변경로그-업데이트" class="header-anchor">#</a> 1-2. 레코드 및 변경로그 업데이트</h3> <ul><li>여기에 동일한 고객 거래 스트림을 가져와 보자.</li> <li>다만, 이제는 시간 흐름에 따른 활동을 추적한다.</li> <li>고객 ID 키를 추가한다면 구매 이벤트는 각기 다른 이벤트와 연관시킬 수 있고, 이벤트 스트림과는 다른 업데이트 스트림을 갖게 된다.</li> <li>이 스트림을 로그처럼 간주한다면, 이 이벤트 스트림은 변경로그 같은 업데이트 스트림으로 취급할 수 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_4.1dfcc3bb.jpg" alt="ks"></p> <ul><li>Stock_ID를 프라이머리 키로 사용한다면, 이후 이벤트는 같은 키로 변경로그를 업데이트한다.</li> <li>이러한 경우, 한 회사마다 1개, 즉 레코드 2개만 남게 된다.</li> <li>같은 회사에서 더 많은 레코드가 유입될 수 잇지만, 레코드에 누적되지는 않는다.</li> <li>즉 이벤트는 4번 발생했지만, 변경 로그는 2개만 남게 된다.</li></ul> <hr> <ul><li>여기서 업데이트 스트림과 데이터베이스 테이블 사이의 관계를 알 수 있다.</li> <li>로그와 변경로그 둘 다 파일의 긑에 추가된 유입 레코드를 의미한다.</li> <li>로그의 경우 모든 레코드를 볼 수 있지만, 변경로그의 경우 주어진 어던 키에 대한 최신 레코드만 유지한다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>로그와 변경로그에서 레코드는 입력되는 파일의 끝에 추가된다. 로그에서는 모든 로그가 필요하고, 변경로그에서는 각 키에 대한 최신 레코드만 필요하다는 점이 다르다.</p></div> <ul><li>키별로 최신 레코드를 유지하는 동안 로그를 줄이기 위해 로그 압축을 사용하면 된다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_5.ef03598b.jpg" alt="ks"></p> <h3 id="_1-3-이벤트-스트림과-업데이트-스트림-비교"><a href="#_1-3-이벤트-스트림과-업데이트-스트림-비교" class="header-anchor">#</a> 1-3. 이벤트 스트림과 업데이트 스트림 비교</h3> <p><img src="/study-collection/assets/img/ks_5_6.4c776691.jpg" alt="ks"></p> <ul><li>위의 예시를 보면, KStream은 총 9번의 레코드를 출력하지만, KTable은 이전 레코드를 덮어써서 3건의 레코드만 출력한다.</li> <li>당연히 마지막 업데이트 값은 KStream이나 KTable이나 동일하다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>위의 예시를 보면, KTable 에서 업데이트가 작동하는 방식을 보여준다. 암묵적으로 추정했던 방식이 명로해 졌다. KTable을 사용하면 키/값 쌍에 있는 키를 레코드에 넣어야한다. KTable이 작동하기 위해서는 이 키가 필수이다.</p></div> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 주식 알림 프로그램 소스</span>
<span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockTickerData</span><span class="token punctuation">&gt;</span></span> stockTickerTable <span class="token operator">=</span> 
    builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>STOCK_TICKER_TABLE_TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KTable 인스턴스 생성</span>
<span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockTickerData</span><span class="token punctuation">&gt;</span></span> stockTickerStream <span class="token operator">=</span> 
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>STOCK_TICKER_STREAM_TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KStream 인스턴스 생성</span>

stockTickerTable<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockTickerData</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withLable</span><span class="token punctuation">(</span><span class="token string">&quot;Stocks-KTable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KTable이 콘솔에 결과출력</span>

stockTickerStream
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockTickerData</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withLable</span><span class="token punctuation">(</span><span class="token string">&quot;Stocks-KStream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KStream이 콘솔에 결과 출력</span>
</code></pre></div><h2 id="_2-레코드-업데이트와-ktable-구성"><a href="#_2-레코드-업데이트와-ktable-구성" class="header-anchor">#</a> 2. 레코드 업데이트와 KTable 구성</h2> <ul><li>KTable의 기능을 이해하기 위해 두 가지 질문을 해보자
<ul><li>레코드를 어디에 저장하는가?</li> <li>KTable은 레코드를 내보내는 결정을 어떻게 하는가?</li></ul></li> <li>위 질문에 대한 답은 aggregation과 reducing 작업을 할 때 필요하다.</li> <li>첫 질문에 대한 답을 위해 KTable을 생성하는 다음 줄을 봐보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>STOCK_TICKER_TABLE_TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>이 단순한 한줄에서 StreamBuilder는 KTable 인스턴스를 만들고 동시에 그 내부에 스트림 상태를 추적하는 상태 저장소를 만들어 업데이트 스트림을 만든다.</li> <li>이 방식으로 생성된 상태 저장소는 내부적인 이름을 갖기 때문에 대화형 쿼리에서는 사용할 수 없다.</li> <li>첫 질문에 대한 답은 KTable은 카프카 스트림즈와 통합된 로컬 상태 저장소를 저장 공간으로 사용한다는 것이다.(Rocks DB)</li></ul> <hr> <ul><li>두 번째 질문인 KTable이 업데이트를 다운스트림 프로세서로 내보내는 시점에 관한 질문을 봐보자.</li> <li>이 질문을 해결하기 위해선 다음과 같은 부분이 고려되어야 한다.
<ul><li>어플리케이션에 유입되는 레코드 수, 높은 데이터 유입률은 업데이트된 레코드를 내보내는 비율을 높일 수 있다.</li> <li>데이터에 구별되는 키가 얼마나 많은가? 구별되는 키 개수가 많다면 다운스트림에 더 많은 업데이트를 보내게 된다.</li> <li>cache.max.bytes.buffering과 commit.interval.ms 구성 매개변수</li></ul></li></ul> <h3 id="_2-1-캐시-버퍼-크기-설정하기"><a href="#_2-1-캐시-버퍼-크기-설정하기" class="header-anchor">#</a> 2-1. 캐시 버퍼 크기 설정하기</h3> <ul><li>KTable 캐시는 같은 키가 있는 레코드의 중복을 의미한다.</li> <li>이러한 중복 제거는 처리할 데이터의 총량을 줄이기 위해 모든 업데이트 대신 가장 최근 업데이트만 자식 노드에 제공한다.</li> <li>이렇게 가장 최신 데이터만 저장히기 때믄에, 영구 상태 저장소를 사용할 때 성능이 매우 좋아진다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_7.26b2fd5d.jpg" alt="ks"></p> <ul><li>KTable 캐시는 같은 키가 있는 레코드 업데이트의 중복을 제거해, 토폴로지에 있는 KTable의 자식 노드에 연속적인 업데이트가 흐르는걸 방지한다.</li></ul> <h3 id="_2-2-커밋-주기-설정하기"><a href="#_2-2-커밋-주기-설정하기" class="header-anchor">#</a> 2-2. 커밋 주기 설정하기</h3> <ul><li>commit.interval.ms 매개변수를 통해 프로세서의 상태를 얼마나 자주 저장할지 결정한다.</li> <li>프로세서 상태를 커밋할 때, 캐시를 강제로 비우고 중복 제거된 마지막 업데이트 레코드를 다운스트림에 전송한다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_8.9b76709e.jpg" alt="ks"></p> <ul><li>레코드를 다운스트림으로 보내는 방법은 2가지가 있다.</li> <li>커밋하거나 캐시가 최대 크기가 도달하면 레코드를 다운스트림으로 전달한다.</li> <li>캐시를 비활성화하면 중복된 키를 포함한 모든 레코드를 다운스트림에 전송한다.</li> <li>KTable을 쓸거면 캐시를 활성화 하는게 좋다.</li></ul> <h2 id="_3-집계와-윈도-작업"><a href="#_3-집계와-윈도-작업" class="header-anchor">#</a> 3. 집계와 윈도 작업</h2> <h3 id="_3-1-업계별-거래량-집계"><a href="#_3-1-업계별-거래량-집계" class="header-anchor">#</a> 3-1. 업계별 거래량 집계</h3> <ul><li>스트리밍 데이터를 다루다 보면 집계와 그룹화는 필수</li> <li>예제는 데이 트레이더 역할을 맡아서 선택한 산업 목록 전체에 걸쳐 회사의 거래량을 추적한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 원시 주식 거래 정보가 입력된 토픽으로부터 소스를 만든다<span class="token punctuation">.</span> <span class="token class-name">StockTransaction</span> 객체를
<span class="token class-name">ShareVolume</span> 객체에 매핑해야 한다<span class="token punctuation">.</span> <span class="token class-name">StockTransaction</span> 객체는 거래와 관련된 메타데이터를 갖고 있지만<span class="token punctuation">,</span> 
거래와관련된 거래량<span class="token punctuation">(</span><span class="token class-name">ShareVolume</span><span class="token punctuation">)</span>만 필요하다<span class="token punctuation">.</span>

<span class="token number">2.</span> 종목 코드로 <span class="token class-name">ShareVolume</span> 그룹을 만든다<span class="token punctuation">.</span> 이 코드로 그룹을 만들면<span class="token punctuation">,</span> 전체 주식 거래량에서 그룹별 거래량으로
데이터를 줄일 수 있다<span class="token punctuation">.</span> 여기서 <span class="token class-name">KStream</span><span class="token punctuation">.</span>groupBy를 호출하면<span class="token punctuation">,</span> <span class="token class-name">KGroupedStream</span> 인스턴스를 반환하는데<span class="token punctuation">,</span> 
<span class="token class-name">KGroupedStream</span><span class="token punctuation">.</span>reduce를 호출하면 <span class="token class-name">KTable</span> 인스턴스를 얻게 된다<span class="token punctuation">.</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>KGroupedStream은 KStream.groupBy나 KStream.groupByKey를 사용하면 반환되는 인스턴스로, 키별로 그룹화한 이벤트 스트림의 중간 표현일 뿐, 직접 작업하기 위한 것은 아니다. 대신 KGroupedStream은 집계 작업을 수행하기 위해 필요하며 항상 KTable이 된다.</p></div> <p><img src="/study-collection/assets/img/ks_5_9.dbbf8cdc.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ShareVolume</span><span class="token punctuation">&gt;</span></span> shareVolume <span class="token operator">=</span> 
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>STOCK_TRANSACTIONS_TOPIC<span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> 
    stockTransactionSerde<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withOffsetResetPolicy</span><span class="token punctuation">(</span>EARLIEST<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// StockTransaction 객체를 SHareVolume 객체로 매핑</span>
    <span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>st <span class="token operator">-&gt;</span> <span class="token class-name">ShareVolume</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token comment">// 주식 종목 코드에 따른 ShareVolume 객체 그룹화</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> v<span class="token punctuation">.</span><span class="token function">getSymbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> shareVolumeSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 거래량 롤링 집계하기 위한 ShareVolume 객체 리듀스</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">ShareVolume</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">reduce</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>GroupBy와 GroupByKey는 둘다 KGroupedStream을 반환하지만, GroupByKey는 KStream이 이미 null 이 아닌 키를 갖고 잇을 경우에 사용하고, GroupBy 메소드는 그룹화를 위한 키가 변경될 수 있다고 가정한다.
GroupByKey는 리파티셔닝 필요 플래그가 설정되지 않고, GroupBy는 호출하면 조인 집계 등이 자동으로 리파티셔닝 된다.</p></div> <ul><li>ShareVolume의 sum() 메소드를 살펴보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ShareVolume</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">ShareVolume</span> csv1<span class="token punctuation">,</span> <span class="token class-name">ShareVolume</span> csv2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Builder</span> builder <span class="token operator">=</span> <span class="token function">newBuilder</span><span class="token punctuation">(</span>csv1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>shares <span class="token operator">=</span> csv1<span class="token punctuation">.</span>shares <span class="token operator">+</span> csv2<span class="token punctuation">.</span>shares<span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ShareVolue.sum()은 전체 거래량 집계를 제공하고, 전체 프로세싱 체인의 결과는 KTable&lt;String, ShareVolume&gt; 객체이다.</li> <li>ShareVolume 객체가 들어오면 연관된 KTable은 가장 최근 업데이트를 유지한다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>집계 대신 리듀스를 사요앟는 이유는, 리듀스 작업은 같은 유형의 객체를 반환하지만, 집계는 다른 유형의 객체를 반환할 수 있기 때문이다.</p></div> <ul><li>이제 이 KTable을 가져와서 상위 5개 집계(점유율에 의한)의 요약을 수행하는데 사용해 본다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 산업별로 <span class="token class-name">ShareVolume</span> 객체를 그룹화하는 또 다른 groupBy 작업을 수행하자<span class="token punctuation">.</span>

<span class="token number">2.</span> <span class="token class-name">ShareVolume</span> 객체를 추가하자<span class="token punctuation">.</span> 이때 집계 객체는 고정 크기의 우선순위 큐다<span class="token punctuation">.</span> 고정 크기 큐는
거래량에 의한 상위 <span class="token number">5</span>개 회사만 유지한다<span class="token punctuation">.</span>

<span class="token number">3.</span> 이 큐를 문자열로 매핑하고<span class="token punctuation">,</span> 거래량에 따른 산업별 상위 <span class="token number">5</span>개 주식만 결과에 포함한다<span class="token punctuation">.</span>

<span class="token number">4.</span> 문자열 결과를 토픽에 쓴다<span class="token punctuation">.</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_5_10.6af8ea29.jpg" alt="ks"></p> <ul><li>위의 토폴로지는 산업별로 그룹화하고, 상위 5개만 집계해서 큐에 있는 상위 5개를 문자열로 매핑한 다음, 싱크 프로세서에서 토픽에 문자를 쓴다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShareVolume</span><span class="token punctuation">&gt;</span></span> comparator <span class="token operator">=</span>
 <span class="token punctuation">(</span>sv1<span class="token punctuation">,</span> sv2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> sv2<span class="token punctuation">.</span><span class="token function">getShares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sv1<span class="token punctuation">.</span><span class="token function">getShares</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token class-name">FixedSizePriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShareVolume</span><span class="token punctuation">&gt;</span></span> fixedQueue <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">FixedSizePriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>comparator<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

shareVolume<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">KeyValue</span><span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getIndustry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> shareVolumeSerde<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 산업별 그룹화하고 필요한 serdes를 제공</span>
  <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> fixedQueue<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> agg<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> agg<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 집계의 메소드가 새 업데이트를 추가</span>
            <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> agg<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> agg<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 집계의 remove 메소드가 기존 업데이트를 제거</span>
            <span class="token class-name">Materialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> fixedSizePriorityQueueSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>valueMapper<span class="token punctuation">)</span> <span class="token comment">// ValueMapper 인스턴스는 집계를 리포팅에 사용되는 문자열로 변환</span>
  <span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stock volume by industry {} {}&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;stock-volume-by-company&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>집계는 KTable 과 마찬가지로 같은 키로 업데이트된 레코드를 유일하게 만들어 준다.</li> <li>같은 키가 있는 가장 최근 레코드를 집계한다.</li> <li>레코드가 도착하면 이 레코드를 FixedSizePriorityQueue에 add 메소드로 추가하지만, 같은 키의 다른 레코드가 있다면 remove 메소드로 기존 레코드를 제거한다.</li> <li>위의 예제를 보면 로컬 상태 저장소가 중요한지 알 수 있다. (로컬 상태는 이미 봤던 레코드를 추적 할 수 있게 한다.)</li> <li>리듀스나 집계 연산을 실행할 때마다, 상태 저장소의 이름이 필요하다.</li> <li>리듀스와 집계 연산은 KTable 인스턴스를 반환하고, 이 KTable은 기존 결과를 새 결과로 교체하기 위해 상태 저장소를 사용한다.</li> <li>계속 본 것처럼 모든 업데이트가 다운스트림에 전달되는 것은 아니며, 집계 연산이 요약 정보를 모은다는 사실이 중요하다.</li> <li>로컬 상태를 사용하지 않는다면, KTable은 모든 집계와 리듀스 결과를 전달 할 수밖에 없다.</li></ul> <h3 id="_3-2-윈도-연산"><a href="#_3-2-윈도-연산" class="header-anchor">#</a> 3-2. 윈도 연산</h3> <ul><li>어떠한 경우에는 주어진 시간 범위에 대해서만 작업을 수행할 필요도 있다.</li></ul> <h4 id="고객별-주식-거래량-집계"><a href="#고객별-주식-거래량-집계" class="header-anchor">#</a> 고객별 주식 거래량 집계</h4> <ul><li>예제는 소수 거래자의 주식 거래를 추적해 볼 것이다.</li> <li>추적을 위한 절차는 다음과 같다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 주식 거래 토픽을 읽어서 스트림을 만든다<span class="token punctuation">.</span>

<span class="token number">2.</span> 고객 ID와 주식 종목 코드별 유입 레코드를 그룹화한다<span class="token punctuation">.</span> groupBy 호출은 <span class="token class-name">KGroupedStream</span> 인스턴스를 반환
한다<span class="token punctuation">.</span>

<span class="token number">3.</span> 윈도 스트림을 반환하기 위해 <span class="token class-name">KGroupedStream</span><span class="token punctuation">.</span>windowedBy 메소드를 사용하면<span class="token punctuation">,</span> 특정 유형의 윈도 집계를
수행할 수 있다<span class="token punctuation">.</span> 제공한 윈도 타입에 따라 <span class="token class-name">TimeWindowedKStream</span> 또는 <span class="token class-name">SessionWindowedKStream</span>을 반환
받을 것이다<span class="token punctuation">.</span>

<span class="token number">4.</span> 집계 연산을 위해 계산을 수행한다<span class="token punctuation">.</span> 윈도 스트림은 레코드를 이 계산에 포함할 것인지를 결정한다<span class="token punctuation">.</span>

<span class="token number">5.</span> 이 결과를 특정 토픽에 쓰거나<span class="token punctuation">,</span> 개발 중에는 콘솔에 결과를 출력한다<span class="token punctuation">.</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_5_11.deada5c0.jpg" alt="ks"></p> <h4 id="윈도-유형"><a href="#윈도-유형" class="header-anchor">#</a> 윈도 유형</h4> <ul><li>카프카 스트림즈에선 3가지 유형의 윈도를 사용할 수 있다.
<ul><li>세션 윈도</li> <li>텀블링 윈도</li> <li>슬라이딩 또는 호핑 윈도</li></ul></li></ul> <h4 id="세션-윈도"><a href="#세션-윈도" class="header-anchor">#</a> 세션 윈도</h4> <ul><li>시간에 엄격하게 제한받지 않고 사용자 활동과 관련이 이싿.</li> <li>비활성화 기간으로 세션 윈도를 설명한다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_12.d3434af0.jpg" alt="ks"></p> <ul><li>더 작은 세션은 비활성 구간이 짧기 때문에 왼쪽에 있는 세션에 병합될 것이다.</li> <li>오른쪽에 있는 세션은 넓은 비활성 간격이 있으서 새로운 새션으로 분할 될 거싱다.</li></ul> <h4 id="주식-거래-추적을-위한-세션-윈도-사용"><a href="#주식-거래-추적을-위한-세션-윈도-사용" class="header-anchor">#</a> 주식 거래 추적을 위한 세션 윈도 사용</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringSerde <span class="token operator">=</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> transactionSerde <span class="token operator">=</span>
 <span class="token class-name">StreamsSerdes</span><span class="token punctuation">.</span><span class="token class-name">StockTransactionSerde</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span></span> transactionKeySerde <span class="token operator">=</span>
 <span class="token class-name">StreamsSerdes</span><span class="token punctuation">.</span><span class="token class-name">TransactionSummarySerde</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">long</span> twentySeconds <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> fifteenMinutes <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Windowed</span><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span>
    customerTransactionCounts <span class="token operator">=</span> <span class="token comment">// groupBy와 count 호출로 생성된 KTable</span>
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>STOCK_TRANSACTIONS_TOPIC<span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
    transactionSerde<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withOffsetResetPolicy</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noKey<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    <span class="token class-name">TransactionSummary</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TransactionSummary 객체에 저장된 고객 ID와 주식 종목으로 레코드를 그룹화</span>
    <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>transactionKeySerde<span class="token punctuation">,</span> transactionSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span><span class="token class-name">SessionWindows</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>twentySeconds<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">until</span><span class="token punctuation">(</span>fifteenMinutes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 비활성 시간 20초, 유지시간 15분의 SessionWindow로 그룹을 윈도 처리한 다음, count()와 같은 집계를 수행</span>


customerTransactionCounts<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Windowed</span><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;Customer Transaction Counts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>groupBy 연산을 할 때마다 일반적으로 일종의 집계 작업(집계, 리듀스, 카운트)을 수행한다.</li> <li>이전 결과가 계속 축적되는 누적 집계를 수행하거나 지정된 시간 윈도 동안 레코드를 병합하는 윈도 집계를 수행할 수 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_13.730db07c.jpg" alt="ks"></p> <ul><li>windowedBy(SessionWindows.with(twentySeconds).until(fifteenMinutes))를 호출해 비활성 간격은 20초이고 유지 기간은 15분인 세션 윈도를 만든다.</li> <li>20초의 비활성 시간은 현재 세션이 종료되거나 현재(활성) 세션 내의 시작 시간부터 20초 내에 도달하는 레코드를 어플리케이션이 포함한다는 뜻이다.</li> <li>만약 들어오는 레코드가 비활성화 간격을 넘어선다면, 이 어플리케이션은 새 세션을 만든다.</li> <li>세셔의 비활성화 기간 밖에 있더라도 병합이 가능한 경우라면 늦게 도착한 데이터도 병합을 허용한다.</li></ul> <table><thead><tr><th>도착순서</th> <th>키</th> <th>타임스탬프</th></tr></thead> <tbody><tr><td>1</td> <td>{123-345-654,FFBE}</td> <td>00:00:00</td></tr> <tr><td>2</td> <td>{123-345-654,FFBE}</td> <td>00:00:15</td></tr> <tr><td>3</td> <td>{123-345-654,FFBE}</td> <td>00:00:50</td></tr> <tr><td>4</td> <td>{123-345-654,FFBE}</td> <td>00:00:05</td></tr></tbody></table> <ul><li>레코드가 들어올 때, 같은 키가 있는 기존 세션이면서 '현재 타임스탬프 - 비활성 간격' 보다 작은 종료 시간을 갖고, '현재 타임스탬프 + 비활성 간격' 보다 더 큰 시작 시간을 갖는 세션을 찾는다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 레코드 <span class="token number">1</span>은 첫 레코드이며<span class="token punctuation">,</span> 시작과 끝 시간은 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 이다<span class="token punctuation">.</span>

<span class="token number">2.</span> 레코드 <span class="token number">2</span>가 도착하면 가장 이른 종료 시간 <span class="token number">23</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">55</span>와 가장 늦은 시작 시간 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">35</span>를 가진 시간을 
찾는다<span class="token punctuation">.</span> 레코드 <span class="token number">1</span>을 찾았기 때문에 세션 <span class="token number">1</span>과 <span class="token number">2</span>는 병합한다<span class="token punctuation">.</span> 세션 <span class="token number">1</span> 시작 시간<span class="token punctuation">(</span>가장 이른 시간<span class="token punctuation">)</span>과 세션 <span class="token number">2</span> 종료
시간 <span class="token punctuation">(</span>최근<span class="token punctuation">)</span>을 유지하므로<span class="token punctuation">,</span> 하나의 세션은 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span>으로 시작해서 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">15</span>로 끝난다<span class="token punctuation">.</span>

<span class="token number">3.</span> 레코드 <span class="token number">3</span>이 도착하면<span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">30</span>부터 <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">10</span> 사이으 ㅣ세션을 찾아봐도 해당하는 세션이 없다<span class="token punctuation">.</span>
<span class="token number">123</span><span class="token operator">-</span><span class="token number">345</span><span class="token operator">-</span><span class="token number">654</span> 키로 두 번째 세션을 추가하는데<span class="token punctuation">,</span> FFBE는 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">50</span>에 끝난다<span class="token punctuation">.</span>

<span class="token number">4.</span> 레코드 <span class="token number">4</span>가 도착하면 <span class="token number">23</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">45</span>와 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">25</span> 사이의 세션을 검색한다<span class="token punctuation">.</span> 이번에는 세션 <span class="token number">1</span>과 <span class="token number">2</span> 둘 다 
찾는다<span class="token punctuation">.</span> 시작 시간이 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span>이고 종료 시간이 <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token operator">!</span><span class="token number">5</span>인 <span class="token number">3</span>개의 세션 모두 한 세션으로 병합된다<span class="token punctuation">.</span>
</code></pre></div><ul><li>세션은 고정 크기 윈도가 아니다. 오히려 세션의 크기는 주어진 시간 프레임 내의 총 활성화 시간에 의해 결정된다.</li> <li>데이터에 있어서 타임스탬프는 이벤트가 기존 세션에 맞는지 또는 비활성화 간격으로 나뉘는지 결정한다.</li></ul> <h4 id="텀블링-윈도"><a href="#텀블링-윈도" class="header-anchor">#</a> 텀블링 윈도</h4> <ul><li>고정 또는 텀블링 윈도는 지정한 기간 내의 이벤트를 추적한다.</li> <li>특정 회사의 전체 주식 거래를 20초마다 추적해야 하고, 그 시간 동안 모든 이베트를 수집한다고 하자.</li> <li>20초가 경과하면 윈도는 다음 20초 감시주기로 '텀블링'한다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_14.68309696.jpg" alt="ks"></p> <ul><li>이 윈도는 최근 20초 동안 들어온 개별 이벤트가 포함됐다. 새 윈도는 지정한 시간 후에 생성됐다.</li> <li>지정된 기간 후에 텀블링 윈도는 초기화된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Windowed</span><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> customerTransactionCounts <span class="token operator">=</span>
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>STOCK_TRANSACTIONS_TOPIC<span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
                                                            transactionSerde<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withOffsetResetPolicy</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noKey<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">TransactionSummary</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>transactionKeySerde<span class="token punctuation">,</span> transactionSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span><span class="token class-name">TimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>twentySeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>TimeWindows.of 를 호출하면 텀블링 윈도를 사용할 수 있다.</li></ul> <h4 id="슬라이딩-또는-호핑-윈도"><a href="#슬라이딩-또는-호핑-윈도" class="header-anchor">#</a> 슬라이딩 또는 호핑 윈도</h4> <ul><li>텀블링 윈도와의 차이는 최근 이벤트를 처리할 새 윈도를 시작하기 전에 그 윈도 전체 시간을 기다리지 않는다.</li> <li>슬라이딩 윈도는 전체 윈도 유지 기간보다는 더 짧은 간격 동안 기다린 후 새 연산을 수행한다.</li></ul> <p><img src="/study-collection/assets/img/ks_5_15.562830ae.jpg" alt="ks"></p> <ul><li>왼쪽 박스는 첫 20초 윈도인데, 이 윈도는 새 윈도를 시작하기 위해 5초 뒤에 슬라이드하거나 업데이트 한다.</li> <li>여기서는 겹쳐지는 이벤트를 보게 된다.</li> <li>윈도 1은 [100, 200, 500, 400] 윈도 2는 [500, 400, 350, 600] 윈도 3은 [350,600,50,2500] 이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Windowed</span><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> customerTransactionCounts <span class="token operator">=</span>
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>STOCK_TRANSACTIONS_TOPIC<span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>
    transactionSerde<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withOffsetResetPolicy</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noKey<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">TransactionSummary</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>transactionKeySerde<span class="token punctuation">,</span> transactionSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span><span class="token class-name">TimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>twentySeconds<span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>fiveSeconds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span>fifteenMinutes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5초마다 이동하는 20초 간격의 호핑 윈도 사용</span>
</code></pre></div><ul><li>advanceBy() 메소드로 텀블링 윈도를 호핑 윈도로 변환할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 세션 윈도는 시간에 의해 고정되지 않고<span class="token punctuation">,</span> 사용자 활동으로 유도된다<span class="token punctuation">.</span>

<span class="token number">2.</span> 텀플링 윈도는 지정된 시간 프레임 내에서 이벤트의 상황을 보게 한다<span class="token punctuation">.</span>

<span class="token number">3.</span> 호핑 윈도는 고정 길이이지만<span class="token punctuation">,</span> 자주 업데이트되며<span class="token punctuation">,</span> 개별 윈도에 겹치는 레코드가 들어 있을 수 있다<span class="token punctuation">.</span>
</code></pre></div><h3 id="_3-3-kstream과-ktable-조인하기"><a href="#_3-3-kstream과-ktable-조인하기" class="header-anchor">#</a> 3-3. KStream과 KTable 조인하기</h3> <ul><li>주식 거래 카운트를 가져와서 관련 산업 분야의 금융 뉴스와 조인해 보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 주식 거래 카운트 <span class="token class-name">KTable</span>을 키가 주식 종목인 산업별 카운트로 변경한 <span class="token class-name">KStream</span>에 변환해 넣는다<span class="token punctuation">.</span>

<span class="token number">2.</span> 금융 관련 토픽 뉴스를 읽어 <span class="token class-name">KTable</span>을 만든다<span class="token punctuation">.</span> 새 <span class="token class-name">KTable</span>은 산업별로 분류될 것이다<span class="token punctuation">.</span>

<span class="token number">3.</span> 이 뉴스 업데이트를 산업별 주식 거래 카운트와 조인한다<span class="token punctuation">.</span>
</code></pre></div><h4 id="ktable을-kstream으로-변환하기"><a href="#ktable을-kstream으로-변환하기" class="header-anchor">#</a> KTable을 KStream으로 변환하기</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> <span class="token class-name">KTable</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 메소드를 호출한다<span class="token punctuation">.</span>

<span class="token number">2.</span> 키를 산업명으로 바꾸기 위해 <span class="token class-name">KStream</span><span class="token punctuation">.</span>map 호출을 이용하고 윈도 인스턴스로부터 <span class="token class-name">TransactionSummary</span>
객체를 추출한다<span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// KTable을 KStream으로 변환하기</span>
<span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span></span> countStream <span class="token operator">=</span> 
    customerTransactionCounts<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// toStream 후 바로 map 호출</span>
        <span class="token class-name">TransactionSummary</span> transactionSummary <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> newKey <span class="token operator">=</span> transactionSummary<span class="token punctuation">.</span><span class="token function">getIndustry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 키를 주식 구매의 산업 분야로 설정</span>
        transactionSummary<span class="token punctuation">.</span><span class="token function">setSummaryCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">KeyValue</span><span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>newKey<span class="token punctuation">,</span> transactionSummary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// KStream을 위한 새 KeyValue 쌍 반환</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="금융-뉴스-ktable-만들기"><a href="#금융-뉴스-ktable-만들기" class="header-anchor">#</a> 금융 뉴스 KTable 만들기</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> financialNews <span class="token operator">=</span> 
    builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">&quot;financial-news&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>EARLIEST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EARLIEST 속성을 사용해 financial-news 토픽으로 KTable 만듬</span>
</code></pre></div><h4 id="뉴스-업데이트를-트랜잭션-카운트와-조인하기"><a href="#뉴스-업데이트를-트랜잭션-카운트와-조인하기" class="header-anchor">#</a> 뉴스 업데이트를 트랜잭션 카운트와 조인하기</h4> <ul><li>조인은 다음과 같이 진행한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ValueJoiner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSummary</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> valueJoiner <span class="token operator">=</span>
    <span class="token punctuation">(</span>txnct<span class="token punctuation">,</span> news<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%d shares purchased %s related news [%s]&quot;</span><span class="token punctuation">,</span>
    txnct<span class="token punctuation">.</span><span class="token function">getSummaryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txnct<span class="token punctuation">.</span><span class="token function">getStockTicker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> news<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ValueJoiner는 조인 결과로부터 값을 결합한다.</span>

    <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> joined <span class="token operator">=</span>
    countStream<span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>financialNews<span class="token punctuation">,</span> valueJoiner<span class="token punctuation">,</span>
    <span class="token class-name">Joined</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> transactionKeySerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// countStream KStream과 금융 뉴스 KTable 조인</span>

    joined<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;Transactions and News&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-4-globalktable"><a href="#_3-4-globalktable" class="header-anchor">#</a> 3-4. GlobalKTable</h3> <ul><li>조인을 할 경우에, 키를 새 타입이나 값으로 매핑할 때 스트림 리파티셔닝이 필요하다.</li></ul> <h4 id="리파티셔닝-비용"><a href="#리파티셔닝-비용" class="header-anchor">#</a> 리파티셔닝 비용</h4> <ul><li>리파티셔닝은 오버헤드가 있고, 다른 토픽에 중복 데이터를 저장하는 중간 토픽을 만들어 다른 토픽에서 읽어서 쓰기 때문에 지연 시간을 증가시킨다.</li></ul> <h4 id="더-작은-데이터-집합과-조인하기"><a href="#더-작은-데이터-집합과-조인하기" class="header-anchor">#</a> 더 작은 데이터 집합과 조인하기</h4> <ul><li>어떤 경우 조인하려는 룩업 데이터는 비교적 작아서 이 조회 데이터 전체 사본을 개별 노드의 로컬에 배치할 수 있다.</li> <li>조회 데이터가 상당히 작을 경우 카프카 스트림즈는 GlobalKTable을 사용할 수 있다.</li> <li>어플리케이션이 모든 데이터를 각 노드에 동이하게 복제하기 때문에 GlobalKTable은 모두 같은 데이터를 갖는다.</li> <li>전체 데이터가 개별 노드에 있기 때문에 이벤트 스트림은 모든 파티션에 데이터를 공급하기 위해 조회할 데이터 키로 파티셔닝할 필요가 없다.</li> <li>또한 GlobalKTable은 키없는 조인이 가능하다.</li></ul> <h4 id="globalktable로-kstream-조인하기"><a href="#globalktable로-kstream-조인하기" class="header-anchor">#</a> GlobalKTable로 KStream 조인하기</h4> <ul><li>countStream을 사용해 두 GlobalKTable과 조인하는 예시</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 세션 윈도를 사용한 주식 거래 집계</span>
<span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span></span> countStream <span class="token operator">=</span>
    builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span> STOCK_TRANSACTIONS_TOPIC<span class="token punctuation">,</span>
        <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> transactionSerde<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withOffsetResetPolicy</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noKey<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    <span class="token class-name">TransactionSummary</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Serialized</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>transactionSummarySerde<span class="token punctuation">,</span> transactionSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span><span class="token class-name">SessionWindows</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>twentySeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>transactionMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>두 개의 GlobalKTable을 정의한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">GlobalKTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> publicCompanies <span class="token operator">=</span>
    builder<span class="token punctuation">.</span><span class="token function">globalTable</span><span class="token punctuation">(</span>COMPANIES<span class="token punctuation">.</span><span class="token function">topicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">GlobalKTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clients <span class="token operator">=</span>
    builder<span class="token punctuation">.</span><span class="token function">globalTable</span><span class="token punctuation">(</span>CLIENTS<span class="token punctuation">.</span><span class="token function">topicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>countStream<span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>publicCompanies<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> txn<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    txn<span class="token punctuation">.</span><span class="token function">getStockTicker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">TransactionSummary</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">withCompanyName</span><span class="token punctuation">)</span> <span class="token comment">// 주식 종목 코드를 키로 하는 publicCompanies와 leftJoin을 설정하고, 회사 이름이 추가된 transactionSummary 반환</span>
            <span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>clients<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> txn<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    txn<span class="token punctuation">.</span><span class="token function">getCustomerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransactionSummary</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">withCustomerName</span><span class="token punctuation">)</span> <span class="token comment">// 고객 ID를 키로 하는 clients 테이블과 leftJoin을 설정하고, 고객 이름이 추가된 transactionSummary 반환 </span>
            <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TransactionSummary</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;Resolved Transaction Summaries&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>위의 조인을 실행하면</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span>customerId<span class="token operator">=</span><span class="token string">'074-09-3705'</span><span class="token punctuation">,</span> stockTicker<span class="token operator">=</span><span class="token string">'GUTM'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">17</span>
<span class="token punctuation">{</span>customerId<span class="token operator">=</span><span class="token string">'037-34-5184'</span><span class="token punctuation">,</span> stockTicker<span class="token operator">=</span><span class="token string">'CORK'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span>
</code></pre></div><ul><li>이랬던 결과가</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span>customer<span class="token operator">=</span><span class="token string">'Barney, Smith'</span> company<span class="token operator">=</span><span class="token string">&quot;Exxon&quot;</span><span class="token punctuation">,</span> transactions<span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>이렇게 보기 좋게 나온다.</li></ul> <hr> <ul><li>카프카 스트림즈의 조인은 다음과 같다</li></ul> <table><thead><tr><th>왼쪽 조인</th> <th>내부 조인</th> <th>외부 조인</th></tr></thead> <tbody><tr><td>KStream - KStream</td> <td>KStream - KStream</td> <td>KStream - KStream</td></tr> <tr><td>KStream - KTable</td> <td>KStream - KTable</td> <td>N/A</td></tr> <tr><td>KTable - KTable</td> <td>KTable - KTable</td> <td>KTable - KTable</td></tr> <tr><td>KStream - GlobalKTable</td> <td>KStream - GlobalKTable</td> <td>N/A</td></tr></tbody></table> <h3 id="_3-5-쿼리-가능-상태"><a href="#_3-5-쿼리-가능-상태" class="header-anchor">#</a> 3-5. 쿼리 가능 상태</h3> <ul><li>토픽에서 데이터를 읽는 것은 구체화된 뷰(materialized view)의 한 형태로 생각해 볼 수 있다.</li> <li>카프카 스트림즈는 상태 저장소로부터 대화형 쿼리도 제공하는데, 이러한 구체화된 뷰에서 직접 데이터를 읽는 기능을 제공한다.</li> <li>상태 저장소는 읽기 전용이므로, 읽기 전용 쿼리를 만들면 어플리케이션이 데이터를 연속적으로 처리하는 동안 상태 불일치 발생은 걱정할 필요가 없다.</li> <li>상태 저장소를 쿼리 가능하게 만드는 것은 상당히 중요하다.</li> <li>카프카 컨슈머에서 데이터를 소비하지 않고도 대시보드 어플리케이션을 만들 수 있다.</li> <li>데이터를 다시 쓰지도 않아서 효율성도 증가한다.
<ul><li>이 데이터는 로컬에 있기 때문에 매우 빠르게 접근할 수 있다.</li> <li>외부 저장소로 복사하지 않으므로 데이터 중복을 피할 수 있다.</li></ul></li> <li>상태 저장소에 직접 쿼리한다는 것은 코드양을 줄이고(컨슈머가 필요 없음) 필요한 소프트웨어 개수를 줄인다는 (결과를 저장할 디비가 필요 없음) 의미가 된다.</li></ul> <h2 id="요약"><a href="#요약" class="header-anchor">#</a> 요약</h2> <ul><li>KStream은 데이터베이스에 삽입하는 것과 비슷한 이벤트 스트림을 나타낸다. KTable은 업데이트 스트림이고 데이터베이스에 변경하는 것과 비슷하다. KTable 크기는 계속 증가하지 않으며, 기존 레코드는 새 레코드로 교체된다.</li> <li>KTable은 집계 작업이 필요하다.</li> <li>윈도 연산으로 시간 버킷에 데이터를 집계해서 넣을 수 있다.</li> <li>GlobalKTable은 파티션에 대한 고려 없이 어플리케이션 전체에 걸쳐 조회 데이터를 제공한다.</li> <li>KStream, KTable, GLobalTable과 서로서로 조인 할 수 있다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/kafka-streams-in-action/04.html" class="prev">4장 스트림과 상태</a></span> <span class="next"><a href="/study-collection/book/kafka-streams-in-action/06.html">6장 프로세서 API</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.65d03ea7.js" defer></script><script src="/study-collection/assets/js/2.f504b8bc.js" defer></script><script src="/study-collection/assets/js/7.bf4d57cc.js" defer></script>
  </body>
</html>
