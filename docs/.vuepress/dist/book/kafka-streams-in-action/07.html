<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.48760978.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.dcf2fe1f.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.8cb4673f.js" as="script"><link rel="preload" href="/study-collection/assets/js/10.dc1dec1b.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/100.c9ba4264.js"><link rel="prefetch" href="/study-collection/assets/js/101.094d7695.js"><link rel="prefetch" href="/study-collection/assets/js/102.06bea5e9.js"><link rel="prefetch" href="/study-collection/assets/js/103.e5514c96.js"><link rel="prefetch" href="/study-collection/assets/js/104.28f7d29c.js"><link rel="prefetch" href="/study-collection/assets/js/105.88873864.js"><link rel="prefetch" href="/study-collection/assets/js/106.bbd3643c.js"><link rel="prefetch" href="/study-collection/assets/js/107.22ca02ce.js"><link rel="prefetch" href="/study-collection/assets/js/11.87b8aa76.js"><link rel="prefetch" href="/study-collection/assets/js/12.c88d51c8.js"><link rel="prefetch" href="/study-collection/assets/js/13.4bc2d3e8.js"><link rel="prefetch" href="/study-collection/assets/js/14.043c2b53.js"><link rel="prefetch" href="/study-collection/assets/js/15.aa1f9004.js"><link rel="prefetch" href="/study-collection/assets/js/16.02f52c09.js"><link rel="prefetch" href="/study-collection/assets/js/17.050a511d.js"><link rel="prefetch" href="/study-collection/assets/js/18.34d9a1bd.js"><link rel="prefetch" href="/study-collection/assets/js/19.a5273176.js"><link rel="prefetch" href="/study-collection/assets/js/20.a0e7a369.js"><link rel="prefetch" href="/study-collection/assets/js/21.7d377e8e.js"><link rel="prefetch" href="/study-collection/assets/js/22.b645a4da.js"><link rel="prefetch" href="/study-collection/assets/js/23.2e18b17b.js"><link rel="prefetch" href="/study-collection/assets/js/24.92822bdb.js"><link rel="prefetch" href="/study-collection/assets/js/25.66eff9b5.js"><link rel="prefetch" href="/study-collection/assets/js/26.44014bb7.js"><link rel="prefetch" href="/study-collection/assets/js/27.9d5742a6.js"><link rel="prefetch" href="/study-collection/assets/js/28.3783b2ca.js"><link rel="prefetch" href="/study-collection/assets/js/29.99446af9.js"><link rel="prefetch" href="/study-collection/assets/js/3.e2f862cf.js"><link rel="prefetch" href="/study-collection/assets/js/30.396b7875.js"><link rel="prefetch" href="/study-collection/assets/js/31.d5e3072c.js"><link rel="prefetch" href="/study-collection/assets/js/32.e7fa62ce.js"><link rel="prefetch" href="/study-collection/assets/js/33.f252e943.js"><link rel="prefetch" href="/study-collection/assets/js/34.1b8b8b7d.js"><link rel="prefetch" href="/study-collection/assets/js/35.887d9a3a.js"><link rel="prefetch" href="/study-collection/assets/js/36.46bab2e0.js"><link rel="prefetch" href="/study-collection/assets/js/37.9154949f.js"><link rel="prefetch" href="/study-collection/assets/js/38.7f897027.js"><link rel="prefetch" href="/study-collection/assets/js/39.7b1adc06.js"><link rel="prefetch" href="/study-collection/assets/js/4.49421fb5.js"><link rel="prefetch" href="/study-collection/assets/js/40.6bc886da.js"><link rel="prefetch" href="/study-collection/assets/js/41.54b92efa.js"><link rel="prefetch" href="/study-collection/assets/js/42.0b3b822e.js"><link rel="prefetch" href="/study-collection/assets/js/43.12361872.js"><link rel="prefetch" href="/study-collection/assets/js/44.a183a055.js"><link rel="prefetch" href="/study-collection/assets/js/45.c75b7519.js"><link rel="prefetch" href="/study-collection/assets/js/46.1b634c79.js"><link rel="prefetch" href="/study-collection/assets/js/47.a4a0e8ba.js"><link rel="prefetch" href="/study-collection/assets/js/48.fcf3b093.js"><link rel="prefetch" href="/study-collection/assets/js/49.a298a0c9.js"><link rel="prefetch" href="/study-collection/assets/js/5.08cc2f0a.js"><link rel="prefetch" href="/study-collection/assets/js/50.0b0f1852.js"><link rel="prefetch" href="/study-collection/assets/js/51.081391a6.js"><link rel="prefetch" href="/study-collection/assets/js/52.91ee3992.js"><link rel="prefetch" href="/study-collection/assets/js/53.9a10a611.js"><link rel="prefetch" href="/study-collection/assets/js/54.483f4e0e.js"><link rel="prefetch" href="/study-collection/assets/js/55.c86b5258.js"><link rel="prefetch" href="/study-collection/assets/js/56.62bbcc3e.js"><link rel="prefetch" href="/study-collection/assets/js/57.ef18fcc9.js"><link rel="prefetch" href="/study-collection/assets/js/58.57bea0f4.js"><link rel="prefetch" href="/study-collection/assets/js/59.f19432e1.js"><link rel="prefetch" href="/study-collection/assets/js/6.a7ef61aa.js"><link rel="prefetch" href="/study-collection/assets/js/60.58ed89a6.js"><link rel="prefetch" href="/study-collection/assets/js/61.9b8d0ccf.js"><link rel="prefetch" href="/study-collection/assets/js/62.a464bcc7.js"><link rel="prefetch" href="/study-collection/assets/js/63.0505ef66.js"><link rel="prefetch" href="/study-collection/assets/js/64.60c3958b.js"><link rel="prefetch" href="/study-collection/assets/js/65.38d4bcb3.js"><link rel="prefetch" href="/study-collection/assets/js/66.1f583136.js"><link rel="prefetch" href="/study-collection/assets/js/67.d0383252.js"><link rel="prefetch" href="/study-collection/assets/js/68.71d2075d.js"><link rel="prefetch" href="/study-collection/assets/js/69.4083a53c.js"><link rel="prefetch" href="/study-collection/assets/js/7.db028af0.js"><link rel="prefetch" href="/study-collection/assets/js/70.b9ac1d89.js"><link rel="prefetch" href="/study-collection/assets/js/71.833574dd.js"><link rel="prefetch" href="/study-collection/assets/js/72.77f557ea.js"><link rel="prefetch" href="/study-collection/assets/js/73.4d35b082.js"><link rel="prefetch" href="/study-collection/assets/js/74.1811a779.js"><link rel="prefetch" href="/study-collection/assets/js/75.3dbf6c23.js"><link rel="prefetch" href="/study-collection/assets/js/76.0fe7f950.js"><link rel="prefetch" href="/study-collection/assets/js/77.99ad015f.js"><link rel="prefetch" href="/study-collection/assets/js/78.1fb9c53b.js"><link rel="prefetch" href="/study-collection/assets/js/79.887c20f5.js"><link rel="prefetch" href="/study-collection/assets/js/8.2f7f9edd.js"><link rel="prefetch" href="/study-collection/assets/js/80.d6939b92.js"><link rel="prefetch" href="/study-collection/assets/js/81.851853e4.js"><link rel="prefetch" href="/study-collection/assets/js/82.f0adf533.js"><link rel="prefetch" href="/study-collection/assets/js/83.62d3204c.js"><link rel="prefetch" href="/study-collection/assets/js/84.396ff2c4.js"><link rel="prefetch" href="/study-collection/assets/js/85.a785a5e1.js"><link rel="prefetch" href="/study-collection/assets/js/86.f7a2b2ac.js"><link rel="prefetch" href="/study-collection/assets/js/87.8931b294.js"><link rel="prefetch" href="/study-collection/assets/js/88.48c08d9f.js"><link rel="prefetch" href="/study-collection/assets/js/89.e7d15202.js"><link rel="prefetch" href="/study-collection/assets/js/9.e53f28f0.js"><link rel="prefetch" href="/study-collection/assets/js/90.0a28681f.js"><link rel="prefetch" href="/study-collection/assets/js/91.5408d043.js"><link rel="prefetch" href="/study-collection/assets/js/92.2c5490d0.js"><link rel="prefetch" href="/study-collection/assets/js/93.bc93b1d7.js"><link rel="prefetch" href="/study-collection/assets/js/94.f73b32cf.js"><link rel="prefetch" href="/study-collection/assets/js/95.17eca345.js"><link rel="prefetch" href="/study-collection/assets/js/96.042ccbd5.js"><link rel="prefetch" href="/study-collection/assets/js/97.0a93dccc.js"><link rel="prefetch" href="/study-collection/assets/js/98.1b87b167.js"><link rel="prefetch" href="/study-collection/assets/js/99.0d3b50e4.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.48760978.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>카프카 스트림즈 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/kafka-streams-in-action/01.html" class="sidebar-link">1장 카프카 스트림즈에 오신 것을 환영합니다</a></li><li><a href="/study-collection/book/kafka-streams-in-action/02.html" class="sidebar-link">2장 빠르게 살펴보는 카프카</a></li><li><a href="/study-collection/book/kafka-streams-in-action/03.html" class="sidebar-link">3장 카프카 스트림즈 개발</a></li><li><a href="/study-collection/book/kafka-streams-in-action/04.html" class="sidebar-link">4장 스트림과 상태</a></li><li><a href="/study-collection/book/kafka-streams-in-action/05.html" class="sidebar-link">5장 KTable API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/06.html" class="sidebar-link">6장 프로세서 API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/07.html" class="active sidebar-link">7장 모니터링과 성능</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>모던 자바 인 액션</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_7강"><a href="#_7강" class="header-anchor">#</a> 7강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-기본적인-카프카-모니터링">1. 기본적인 카프카 모니터링</a><ul><li><a href="#_1-1-컨슈머와-프로듀서-성능-측정">1-1. 컨슈머와 프로듀서 성능 측정</a></li><li><a href="#_1-2-컨슈머-지연-확인하기">1-2. 컨슈머 지연 확인하기</a></li><li><a href="#_1-3-프로듀서와-컨슈머-가로채기">1-3. 프로듀서와 컨슈머 가로채기</a></li></ul></li><li><a href="#_2-어플리케이션-메트릭">2. 어플리케이션 메트릭</a><ul><li><a href="#_2-1-메트릭-구성">2-1. 메트릭 구성</a></li><li><a href="#_2-2-수집한-메트릭-확인-방법">2-2. 수집한 메트릭 확인 방법</a></li><li><a href="#_2-3-jmx-사용">2-3. JMX 사용</a></li><li><a href="#_2-4-메트릭-조회">2-4. 메트릭 조회</a></li></ul></li><li><a href="#_3-추가적인-카프카-스트림즈-디버깅-기술">3. 추가적인 카프카 스트림즈 디버깅 기술</a><ul><li><a href="#_3-1-어플리케이션-쿠조-조회">3-1. 어플리케이션 쿠조 조회</a></li><li><a href="#_3-2-다양한-어플리케이션-상태-알림-받기">3-2. 다양한 어플리케이션 상태 알림 받기</a></li><li><a href="#_3-3-statelistener-사용">3-3. StateListener 사용</a></li><li><a href="#_3-4-상태-리스토어-리스너">3-4. 상태 리스토어 리스너</a></li><li><a href="#_3-5-uncaught-예외-핸들러">3-5. uncaught 예외 핸들러</a></li></ul></li><li><a href="#요약">요약</a></li></ul></div><p></p> <h2 id="_1-기본적인-카프카-모니터링"><a href="#_1-기본적인-카프카-모니터링" class="header-anchor">#</a> 1. 기본적인 카프카 모니터링</h2> <h3 id="_1-1-컨슈머와-프로듀서-성능-측정"><a href="#_1-1-컨슈머와-프로듀서-성능-측정" class="header-anchor">#</a> 1-1. 컨슈머와 프로듀서 성능 측정</h3> <p><img src="/study-collection/assets/img/ks_7_1.fc1152dd.jpg" alt="ks"></p> <ul><li>프로듀서와 컨슈머의 성능은 처리량과 관련이 있다.</li> <li>프로듀서의 경우 얼마나 빠르게 브로커로 메세지를 보내느냐가 가장 중요하다.</li> <li>컨슈머의 경우 브로커에서 얼마나 빠르게 메세지를 읽을 수 있느냐가 성능에 영향을 준다.</li> <li>그러나 컨슈머 성능을 측정하는 또 다른 방법으로 컨슈머 지연이 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_2.49190869.jpg" alt="ks"></p> <ul><li>프로듀서가 브로커에 기록하는 속도와 컨슈머가 메세지를 읽는 속도 차이를 컨슈머지연이라 부른다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_3.9604608d.jpg" alt="ks"></p> <ul><li>컨슈머 지연은 프로듀서가 쓴 오프셋과 컨슈머가 커밋한 오프셋 차이</li></ul> <h3 id="_1-2-컨슈머-지연-확인하기"><a href="#_1-2-컨슈머-지연-확인하기" class="header-anchor">#</a> 1-2. 컨슈머 지연 확인하기</h3> <ul><li>kafka-consumer-groups.sh 을 사용해 확인해 본다.</li></ul> <div class="language-zsh extra-class"><pre class="language-text"><code>bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list
</code></pre></div><p><img src="/study-collection/assets/img/ks_7_4.3809c0d8.png" alt="ks"></p> <ul><li>컨슈머 그룹 이름을 선택해 다음 명령어를 실행해 준다.</li></ul> <div class="language-zsh extra-class"><pre class="language-text"><code>bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group console-consumer-35834 --describe
</code></pre></div><p><img src="/study-collection/assets/img/ks_7_5.e7523a4f.png" alt="ks"></p> <ul><li>이런식으로 컨슈머 지연이 몇건 인지 알 수 있다.</li> <li>컨슈머 지연이 많아지면 결과적으로 성능에 문제가 생길 수 있다.</li> <li>이런 문제를 해결하기 위해선 파티션 수를 늘려 토픽에서 소비하는 작업에 스레드 수를 늘릴 수 있다.</li> <li>또는 메세지를 읽은 후 처리가 너무 무거울 수도 있다.</li> <li>메세지를 소비한 후에 비동기 큐에 전달해 다른 스레드가 메세지를 처리하게 할 수도 있다.</li></ul> <h3 id="_1-3-프로듀서와-컨슈머-가로채기"><a href="#_1-3-프로듀서와-컨슈머-가로채기" class="header-anchor">#</a> 1-3. 프로듀서와 컨슈머 가로채기</h3> <h4 id="컨슈머-인터셉터"><a href="#컨슈머-인터셉터" class="header-anchor">#</a> 컨슈머 인터셉터</h4> <ul><li>컨슈머 인터셉터는 가로채기를 위해 두 가지 접근점을 제공한다.</li> <li>첫번째는 ConsumerInterceptor.onConsume()인데, 브로커에서 조회한 시점과 Consumer.poll() 메소드가 메시지를 반환하기 전에 ConsumerRecords에서 읽는다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>consuming records <span class="token comment">// 브로커에서 새 레코드를 가져온다.</span>
   <span class="token keyword">return</span> interceptors<span class="token punctuation">.</span><span class="token function">onConsume</span><span class="token punctuation">(</span>consumerRecords<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 인터셉터 체인을 통해 레코드를 실행하고 결과 반환</span>
</code></pre></div><ul><li>인터셉터는 Consumer.poll() 메소드 내에서 브로커에서 반환된 ConsumerRecords를 수락하고 KafkaConsumer가 폴링 메소드에서 레코드를 반환하기 전에 필터링 또는 수정을 포함한 모든 작업을 수행할 기회를 갖는다.</li> <li>ConsumerInterceptor는 ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG를 통해 하나 이상의 ConsumerInterceptor 구현자 클래스(implements class)의 컬렉션으로 지정된다.</li> <li>ConsumerInterceptor는 ConsumerRecords 인스턴스를 받은 후 반환한다.</li> <li>다중 인터셉터가 있는 경우, 하나의 인터셉터에서 반환된 ConsumerRecords는 체인의 다음 인터셉터에 대한 입력 매개변수로 사용된다.</li> <li>따라서 하나의 인터셉터에 의해 만들어진 모든 수정사항은 인터셉터 체인의 다음 인터셉터로 전달된다.</li> <li>인터셉터는 인터셉터 체인의 이전 인터셉터에 의해 수정된 ConsumerRecords가 에러가 나면 내용이 꼬일 수 있어서, 이전 ConsumerRecords에 의존하지 않는것이 좋다.</li></ul> <hr> <ul><li>두 번째 가로채기 지점은 ConsumerInterceptor.onCommit() 메소드이다.</li> <li>컨슈머가 브로커에게 오프셋을 커밋하면 브로커는 토픽, 파티션 및 커밋된 오프셋과 관련된 메타데이터 (시간 등)와 함께 정보가 포함된 Map&lt;TopicPartition, OffsetAndMetadata&gt;를 반환한다.</li> <li>커밋 정보는 추적 용도로 쓰기 좋다.</li> <li>아래는 로깅 목적으로 사용되는 간단한 ConsumerInterceptor의 예이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockTransactionConsumerInterceptor</span> <span class="token keyword">implements</span>
 <span class="token class-name">ConsumerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">// 잡다한 정보 상세내역 생략</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span>
    <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">StockTransactionConsumerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">StockTransactionConsumerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;StockTransactionConsumerInterceptor 생성&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 1번 방법</span>
    <span class="token keyword">public</span> <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span>
        <span class="token function">onConsume</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumerRecords {} 인터셉터됨&quot;</span><span class="token punctuation">,</span>
                 <span class="token function">buildMessage</span><span class="token punctuation">(</span>consumerRecords<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 레코드가 처리되기 전에 컨슈머 레코드와 메타데이터를 로깅</span>
        <span class="token keyword">return</span> consumerRecords<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 2번 방법</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCommit</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Commit information {}&quot;</span><span class="token punctuation">,</span>  map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 카프카 스트림즈 컨슈머가 브로커에 오프셋을 커밋할 때 커밋 정보를 로깅한다.</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="프로듀서-인터셉터"><a href="#프로듀서-인터셉터" class="header-anchor">#</a> 프로듀서 인터셉터</h4> <ul><li>ProducerInterceptor도 비슷하게 작동한다.</li> <li>ProducerInterceptor.onSend() 및 ProducerInterceptor.onAcknowledgement()의 두가지 접근 지점이 있다.</li> <li>onSend 메소드를 사용하면 인터셉터가 ProducerRecord를 변형하는 것을 포함해 어떠한 작업이든 수행할 수 있다.</li> <li>체인상에 있는 각 프로듀서 인터셉터는 이전 인터셉터에서 반환된 객체를 받는다.</li> <li>브로커가 레코드를 확인하면 ProducerInterceptor.onAcknowledgement() 메소드가 호출된다.</li> <li>레코드 전송이 실패하면 그 시점에서도 onAcknowledgement가 호출된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZMartProducerInterceptor</span> <span class="token keyword">implements</span>
 <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// some details left out for clarity</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span>
    <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ZMartProducerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span>
    <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ProducerRecord being sent out {} &quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 메세지를 브로커에 전송하기 바로 전에 로깅</span>
        <span class="token keyword">return</span> record<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered producing record {}&quot;</span><span class="token punctuation">,</span>
        exception<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 브로커 수신 확인 또는 생산 단계 동안 브로커 측에서 오류가 발생했는지 로깅</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;record has been acknowledged {} &quot;</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>ProducerInterceptor는 ProducerConfig.INTERCEPTOR_CLASSES_CONFIG에 지정하고, 하나 이상의 ProducerInterceptor 구현자 클래스의 컬렉션으로 설정한다.</li></ul> <h2 id="_2-어플리케이션-메트릭"><a href="#_2-어플리케이션-메트릭" class="header-anchor">#</a> 2. 어플리케이션 메트릭</h2> <ul><li>3장에서 사용한 고급 지마트 어플리케이션에서 작성한 어플리케이션 예시를 사용한다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_6.715797ca.jpg" alt="ks"></p> <ul><li>메트릭 카테고리를 살펴본다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>스레드 메트릭
    <span class="token operator">-</span> 평균 커밋<span class="token punctuation">,</span> 폴링<span class="token punctuation">,</span> 처리<span class="token punctuation">,</span> 작업시간
    <span class="token operator">-</span> 초당 생성한 태스크 수<span class="token punctuation">,</span> 초당 종료된 태스크 수

태스크 메트릭
    <span class="token operator">-</span> 초당 평균 커밋 횟수
    <span class="token operator">-</span> 평균 커밋 시간

프로세서 노드 메트릭
    <span class="token operator">-</span> 평균 및 최대 처리 시간
    <span class="token operator">-</span> 초당 평균 처리 작업 수
    <span class="token operator">-</span> 포워드 레이트

상태 저장소 메트릭
    <span class="token operator">-</span> put<span class="token punctuation">,</span> get<span class="token punctuation">,</span> flush 작업의 평균 실행 시간
    <span class="token operator">-</span> put<span class="token punctuation">,</span> get<span class="token punctuation">,</span> flush 작업의 초당 평균 실행 횟수
</code></pre></div><ul><li>좀더 자세한 메트릭은 confluent에서 확인 필요</li></ul> <h3 id="_2-1-메트릭-구성"><a href="#_2-1-메트릭-구성" class="header-anchor">#</a> 2-1. 메트릭 구성</h3> <ul><li>카프카 스트림즈는 이미 성능 메트릭을 수집하는 메커니즘을 제공한다.</li> <li>대부분의 경우 일부 설정값만 제공하면 된다.</li> <li>메트릭 수집에는 성능 비용이 발생하기 때문에 INFO와 DEBUG의 두 가지 레벨이 있다.</li></ul> <table><thead><tr><th>메트릭 카테고리</th> <th>DEBUG</th> <th>INFO</th></tr></thead> <tbody><tr><td>스레드</td> <td>O</td> <td>O</td></tr> <tr><td>태스크</td> <td>O</td> <td></td></tr> <tr><td>프로세서 노드</td> <td>O</td> <td></td></tr> <tr><td>상태 저장소</td> <td>O</td> <td></td></tr> <tr><td>레코드 캐시</td> <td>O</td> <td></td></tr></tbody></table> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Properties</span> <span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>CLIENT_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;metrics-client-id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;metrics-group-id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>APPLICATION_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;metrics-app-id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>METRICS_RECORDING_LEVEL_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;DEBUG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 이 메트릭을 DEBUG 레벨로 기록하도록 설정</span>
    props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-2-수집한-메트릭-확인-방법"><a href="#_2-2-수집한-메트릭-확인-방법" class="header-anchor">#</a> 2-2. 수집한 메트릭 확인 방법</h3> <ul><li>JMX를 기본 지공해준다.</li></ul> <h3 id="_2-3-jmx-사용"><a href="#_2-3-jmx-사용" class="header-anchor">#</a> 2-3. JMX 사용</h3> <ul><li>JConsole을 사용하면 설치 없이 바로 사용이 가능하다.</li></ul> <h4 id="jconsole-시작하기"><a href="#jconsole-시작하기" class="header-anchor">#</a> JConsole 시작하기</h4> <ul><li>JConsole은 JDK와 함께 제공되서 따로 설치할 필요가 없다.</li> <li>JConsole을 시작하려면 명령 프롬프트에서 jconsole을 실행하면 된다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_7.8226487e.jpg" alt="ks"></p> <h4 id="실행-중인-프로그램-모니터링-시작하기"><a href="#실행-중인-프로그램-모니터링-시작하기" class="header-anchor">#</a> 실행 중인 프로그램 모니터링 시작하기</h4> <ul><li>JConsole GUI의 중앙을 보면 새 연결 대화상자가 표시된다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_8.cfc01145.jpg" alt="ks"></p> <ul><li>로컬에선 ssl 무시를 선택한다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_9.58b5b641.jpg" alt="ks"></p> <h4 id="정보-조회"><a href="#정보-조회" class="header-anchor">#</a> 정보 조회</h4> <ul><li>연결을 하게 되면 그림과 같은 GUI 화면이 나타난다.</li> <li>JConsole은 실행 중인 어플리케이션 내부를 들여다볼 수 있는 몇 가지 편리한 옵션을 제공한다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_10.d6c8393a.jpg" alt="ks"></p> <h3 id="_2-4-메트릭-조회"><a href="#_2-4-메트릭-조회" class="header-anchor">#</a> 2-4. 메트릭 조회</h3> <p><img src="/study-collection/assets/img/ks_7_11.1683773f.jpg" alt="ks"></p> <ul><li>위의 그림은 밀리초당 처리되는 평균 레코드 수를 알려주는 process-rate 메트릭을 보여준다.</li> <li>JConsole에서 프로듀서 및 컨슈머 메트릭스도 볼 수 있다.</li></ul> <h2 id="_3-추가적인-카프카-스트림즈-디버깅-기술"><a href="#_3-추가적인-카프카-스트림즈-디버깅-기술" class="header-anchor">#</a> 3. 추가적인 카프카 스트림즈 디버깅 기술</h2> <h3 id="_3-1-어플리케이션-쿠조-조회"><a href="#_3-1-어플리케이션-쿠조-조회" class="header-anchor">#</a> 3-1. 어플리케이션 쿠조 조회</h3> <ul><li>어플리케이션이 실행된 후 디버깅을 해야하는 상황이 발생할 수 있다.</li> <li>Topology.describe() 메소드는 어플리케이션 구조에 관한 일반적인 정보를 제공한다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_12.5aaf13fc.jpg" alt="ks"></p> <ul><li>위와같이 보기 좋게 잘 출력해 준다.</li></ul> <h3 id="_3-2-다양한-어플리케이션-상태-알림-받기"><a href="#_3-2-다양한-어플리케이션-상태-알림-받기" class="header-anchor">#</a> 3-2. 다양한 어플리케이션 상태 알림 받기</h3> <ul><li>태스크를 할당하거나 재분배하는 절차를 리밸런싱이라고 한다.</li> <li>리밸런싱 한다는것은 카프카 스트림즈가 자동으로 스케일을 올리고 내릴 수 있음을 의미한다.</li> <li>기존 어플리케이션이 이미 실행 중일 때 새 어플리케이션 인스턴스를 추가하면 리밸런싱 프로세스가 워크로드를 재분배 한다.</li></ul> <h3 id="_3-3-statelistener-사용"><a href="#_3-3-statelistener-사용" class="header-anchor">#</a> 3-3. StateListener 사용</h3> <ul><li>카프카 스트림즈 어플리케이션은 언제든 여섯 가지 상태 중 하나가 될 수 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_13.57722fcb.jpg" alt="ks"></p> <ul><li>이러한 상태 변경을 캡처하려면 KafakaStreams.setStateListener 메소드를 사용한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">StateListener</span> stateListener <span class="token operator">=</span> <span class="token punctuation">(</span>newState<span class="token punctuation">,</span> oldState<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>RUNNING <span class="token operator">&amp;&amp;</span>
                oldState <span class="token operator">==</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>REBALANCING<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// REBALANCING에서 RUNNING으로 상태 전환 확인</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application has gone from REBALANCING to RUNNING &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Topology Layout {}&quot;</span><span class="token punctuation">,</span>
        streamsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>어플리케이션이 리밸런싱 상태가 될 때 어떤 신호를 보이는지 예제를 확인 할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">StateListener</span> stateListener <span class="token operator">=</span> <span class="token punctuation">(</span>newState<span class="token punctuation">,</span> oldState<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>RUNNING <span class="token operator">&amp;&amp;</span>
        oldState <span class="token operator">==</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>REBALANCING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application has gone from REBALANCING to RUNNING &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Topology Layout {}&quot;</span><span class="token punctuation">,</span> streamsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>REBALANCING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application is entering REBALANCING phase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 리밸런싱 단계에 들어갈 때 액션을 추가해 준다.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>위의 내용의 핵심은 카프카 스트림즈 어플리케이션의 현재 상태에 연결해 블랙박스 작업을 줄이는대 있다.</li></ul> <h3 id="_3-4-상태-리스토어-리스너"><a href="#_3-4-상태-리스토어-리스너" class="header-anchor">#</a> 3-4. 상태 리스토어 리스너</h3> <ul><li>카프카 스트림즈는 실패할 경우에 대비해 상태 저장소를 백업하는 것이 중요하다.</li> <li>카프카 스트림즈에서는 상태 저장소의 백업으로 변경로그(changelog) 토픽을 사용한다.</li></ul> <p><img src="/study-collection/assets/img/ks_7_14.b4704b5b.jpg" alt="ks"></p> <ul><li>변경로그는 변경이 발생한 상태 저장소의 업데이트를 기록한다.</li> <li>카프카 스트림즈 어플리케이션이 실패하거나 재시작할 때, 상태 저장소는 로컬 상태 파일에서 복구할 수 있다.</li> <li>하지만 만약 메소스같은 스테이트리스 환경에서 카프카 스트림즈가 완전히 맛이가거나 로컬 디스크 파일이 삭제되면, 변경로그로부터 상태 저장소를 완전히 복구해야 할 수도 있다.</li> <li>위의 그림에서 처럼 변경로그에 있는 레코드는 시작시에 소비되고, 상태 저장소를 복구하는데 사용한다.</li> <li>상태 저장소는 백업 토픽이나 변경로그에서 완전히 복원된다.</li> <li>StateListener와 매우 흡사한 StateRestoreListener 인터페이스는 어플리케이션 내부에서 일어나는 일들에 대한 알림을 허용한다.</li> <li>StateRestoreListener에는 onRestoreStart, onBatchRestored, onRestoreEnd 세가지 메소드를 지원한다.</li> <li>KafkaStreams.setGlobalRestoreListener 메소드는 사용할 글로벌 리스토어 리스너를 지정하는데 사용된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingStateRestoreListener</span> <span class="token keyword">implements</span> <span class="token class-name">StateRestoreListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggingStateRestoreListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> totalToRestore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 복원 진행을 추적하기 위해 ConcurrentHashMap 인스턴스를 만든다.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> restoredSoFar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRestoreStart</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> topicPartition<span class="token punctuation">,</span> <span class="token class-name">String</span> store<span class="token punctuation">,</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> toRestore <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
        totalToRestore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> toRestore<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 복원할 주어진 TopicPartition의 총량을 저장</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;복구 시작 대상 저장소 {} 토픽 파티션 {} 복원할 총 레코드수 {}&quot;</span><span class="token punctuation">,</span> store<span class="token punctuation">,</span> topicPartition<span class="token punctuation">,</span> toRestore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>복원을 추적하기 위해 2개의 CuoncurrentHashMap 인스턴스를 작성한다.</li> <li>onRestoreStart 메소드에서 복원해야 하는 총 레코드 수를 저장하고 복원 시작 상태를 기록한다.</li> <li>복원된 각 배치를 처리하는 코드는 다음과 같다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBatchRestored</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> topicPartition<span class="token punctuation">,</span> <span class="token class-name">String</span> store<span class="token punctuation">,</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> batchCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">NumberFormat</span> formatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">&quot;#.##&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">long</span> currentProgress <span class="token operator">=</span> batchCompleted <span class="token operator">+</span>
        restoredSoFar<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 복원된 전체 레코드 개수 계산</span>
   <span class="token keyword">double</span> percentComplete <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> currentProgress <span class="token operator">/</span> totalToRestore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 복원이 완료된 백분율을 결정</span>

   LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Completed {} for {}% of total restoration for {} on {}&quot;</span><span class="token punctuation">,</span>
                batchCompleted<span class="token punctuation">,</span>
                formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>percentComplete <span class="token operator">*</span> <span class="token number">100.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                store<span class="token punctuation">,</span> topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
   restoredSoFar<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> currentProgress<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 지금까지 복원된 레코드 개수 저장</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>복원 프로세스에서는 내부 컨슈머를 사용해 변경로그 토픽을 읽기 때문에 어플리케이션이 각 consumer.poll() 메소드 호출에서 레코드를 일괄적으로 복원한다.</li> <li>따라서 모든 배치의 최대 크기는 max.poll.records. 설정과 동일하다.</li> <li>복원 프로세스가 최근 배치 상태 저장소에 로드한 후에 onBatchRestored 메소드가 호출된다.</li> <li>먼저 누적된 복원 횟수에 현재 배치 크기를 추가한다.</li> <li>그런 다음 완료된 복원이 백분율을 계산하고 결과를 기록한다.</li> <li>마지막으로 이전에 계산된 새로운 총 레코드 수를 저장한다.</li></ul> <hr> <ul><li>마지막 단계는 복원 프로세스가 완료될 때다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRestoreEnd</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> topicPartition<span class="token punctuation">,</span> <span class="token class-name">String</span> store<span class="token punctuation">,</span> <span class="token keyword">long</span> totalRestored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Restoration completed for {} on topic-partition {}&quot;</span><span class="token punctuation">,</span> store<span class="token punctuation">,</span> topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    restoredSoFar<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TopicPartition 복원의 진행을 추적한다.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>어플리케이션이 복구 프로세스를 완료하면 복원된 마지막 리스너를 총 레코드 수와 함께 호출한다.</li> <li>이 예에서는 완료 상태를 기록하고 전체 복원 횟수 맵을 0으로 업데이트 한다.</li> <li>이제 아래처럼 어플리케이션의 LoggingStaterResotreListener를 사용할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>kafkaStreams<span class="token punctuation">.</span><span class="token function">setGlobalStateRestoreListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingStateRestoreListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-5-uncaught-예외-핸들러"><a href="#_3-5-uncaught-예외-핸들러" class="header-anchor">#</a> 3-5. uncaught 예외 핸들러</h3> <ul><li>예상치 못한 상황이 발생했을 때 알림을 받고 정리할 수 있는 기회를 주는게 좋다.</li> <li>카프카 스트림즈는 이러한 예기치 못한 오류를 처리하기 위해 KafakStreams.setUncaughtExceptionHandler를 제공한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>kafkaStreams<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            CONSOLE_LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Thread [&quot;</span> <span class="token operator">+</span> thread <span class="token operator">+</span> &quot;<span class="token punctuation">]</span>
            encountered <span class="token punctuation">[</span><span class="token string">&quot; + exception.getMessage() +&quot;</span><span class="token punctuation">]</span>&quot;<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="요약"><a href="#요약" class="header-anchor">#</a> 요약</h2> <ul><li>카프카 스트림즈를 모니터링하려면 카프카 브로커도 살펴봐야 한다.</li> <li>어플리케이션의 성능이 어떻게 되는지 보고 싶다면 메트릭 리포팅을 수시로 활성화 해야 한다.</li> <li>내부를 살펴볼 필요가 있으며 가끔 jstack(스레드 덤프)과 jmap/jhat(힙 덤프) 같은 자바에 포함된 명령줄 도구를 사용해 좀 더 저수준에서 어플리케이션 동작을 이해해야 한다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/kafka-streams-in-action/06.html" class="prev">6장 프로세서 API</a></span> <span class="next"><a href="/study-collection/book/modern-java-in-action/01.html">1장 자바 8, 9, 10, 11 : 무슨 일이 일어나고 있는가?</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.dcf2fe1f.js" defer></script><script src="/study-collection/assets/js/2.8cb4673f.js" defer></script><script src="/study-collection/assets/js/10.dc1dec1b.js" defer></script>
  </body>
</html>
