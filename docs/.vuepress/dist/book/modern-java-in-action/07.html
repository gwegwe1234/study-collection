<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.69cdfe8d.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.92abfddd.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.18806e4e.js" as="script"><link rel="preload" href="/study-collection/assets/js/25.fd7e0fb5.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.3d353a55.js"><link rel="prefetch" href="/study-collection/assets/js/100.cf8f42af.js"><link rel="prefetch" href="/study-collection/assets/js/101.c7488893.js"><link rel="prefetch" href="/study-collection/assets/js/102.d65e967d.js"><link rel="prefetch" href="/study-collection/assets/js/103.834dd25d.js"><link rel="prefetch" href="/study-collection/assets/js/104.918e1077.js"><link rel="prefetch" href="/study-collection/assets/js/105.534c6a73.js"><link rel="prefetch" href="/study-collection/assets/js/106.f4dcf55c.js"><link rel="prefetch" href="/study-collection/assets/js/107.eba064ad.js"><link rel="prefetch" href="/study-collection/assets/js/108.252439f9.js"><link rel="prefetch" href="/study-collection/assets/js/109.7c8232f7.js"><link rel="prefetch" href="/study-collection/assets/js/11.2fa3ade4.js"><link rel="prefetch" href="/study-collection/assets/js/110.5047080f.js"><link rel="prefetch" href="/study-collection/assets/js/111.4ae37b59.js"><link rel="prefetch" href="/study-collection/assets/js/112.2e42b973.js"><link rel="prefetch" href="/study-collection/assets/js/113.c5f3ae28.js"><link rel="prefetch" href="/study-collection/assets/js/114.0f6dec01.js"><link rel="prefetch" href="/study-collection/assets/js/115.460ce135.js"><link rel="prefetch" href="/study-collection/assets/js/116.1b5c40e8.js"><link rel="prefetch" href="/study-collection/assets/js/117.fd50b9b6.js"><link rel="prefetch" href="/study-collection/assets/js/118.709b4ca2.js"><link rel="prefetch" href="/study-collection/assets/js/119.50c9c850.js"><link rel="prefetch" href="/study-collection/assets/js/12.170cb357.js"><link rel="prefetch" href="/study-collection/assets/js/120.f12c1741.js"><link rel="prefetch" href="/study-collection/assets/js/121.b739e25b.js"><link rel="prefetch" href="/study-collection/assets/js/122.6bd1bf70.js"><link rel="prefetch" href="/study-collection/assets/js/123.fb31ac26.js"><link rel="prefetch" href="/study-collection/assets/js/124.9eae483e.js"><link rel="prefetch" href="/study-collection/assets/js/125.9c961a16.js"><link rel="prefetch" href="/study-collection/assets/js/126.6cfbb41b.js"><link rel="prefetch" href="/study-collection/assets/js/127.2d6c0e8c.js"><link rel="prefetch" href="/study-collection/assets/js/128.84f7fc4f.js"><link rel="prefetch" href="/study-collection/assets/js/129.1ecc2c2d.js"><link rel="prefetch" href="/study-collection/assets/js/13.9dcc0636.js"><link rel="prefetch" href="/study-collection/assets/js/130.3b66ca81.js"><link rel="prefetch" href="/study-collection/assets/js/131.0dd7f85a.js"><link rel="prefetch" href="/study-collection/assets/js/132.bcc78153.js"><link rel="prefetch" href="/study-collection/assets/js/133.dba830e5.js"><link rel="prefetch" href="/study-collection/assets/js/134.92c14521.js"><link rel="prefetch" href="/study-collection/assets/js/135.e0b98506.js"><link rel="prefetch" href="/study-collection/assets/js/136.b68b0d9d.js"><link rel="prefetch" href="/study-collection/assets/js/137.f038cc4c.js"><link rel="prefetch" href="/study-collection/assets/js/138.f8ad6c5b.js"><link rel="prefetch" href="/study-collection/assets/js/139.5e2700ef.js"><link rel="prefetch" href="/study-collection/assets/js/14.a829a439.js"><link rel="prefetch" href="/study-collection/assets/js/140.571e0151.js"><link rel="prefetch" href="/study-collection/assets/js/141.c6e712f6.js"><link rel="prefetch" href="/study-collection/assets/js/142.9479de33.js"><link rel="prefetch" href="/study-collection/assets/js/143.ddff966a.js"><link rel="prefetch" href="/study-collection/assets/js/144.b5332791.js"><link rel="prefetch" href="/study-collection/assets/js/145.7a9f6f75.js"><link rel="prefetch" href="/study-collection/assets/js/146.6ca346e2.js"><link rel="prefetch" href="/study-collection/assets/js/147.f38804f3.js"><link rel="prefetch" href="/study-collection/assets/js/148.7f7d54e2.js"><link rel="prefetch" href="/study-collection/assets/js/149.fd0dba47.js"><link rel="prefetch" href="/study-collection/assets/js/15.c28c2cf6.js"><link rel="prefetch" href="/study-collection/assets/js/150.4a40e9a7.js"><link rel="prefetch" href="/study-collection/assets/js/151.05cb0a45.js"><link rel="prefetch" href="/study-collection/assets/js/152.b5fe4525.js"><link rel="prefetch" href="/study-collection/assets/js/153.d237cb15.js"><link rel="prefetch" href="/study-collection/assets/js/154.d90620ca.js"><link rel="prefetch" href="/study-collection/assets/js/155.f6ead850.js"><link rel="prefetch" href="/study-collection/assets/js/156.21e6a1e9.js"><link rel="prefetch" href="/study-collection/assets/js/157.4eef5e77.js"><link rel="prefetch" href="/study-collection/assets/js/158.d93e81bf.js"><link rel="prefetch" href="/study-collection/assets/js/159.44ec8873.js"><link rel="prefetch" href="/study-collection/assets/js/16.50fb490a.js"><link rel="prefetch" href="/study-collection/assets/js/160.69764935.js"><link rel="prefetch" href="/study-collection/assets/js/161.594c31dd.js"><link rel="prefetch" href="/study-collection/assets/js/162.1da391d0.js"><link rel="prefetch" href="/study-collection/assets/js/163.07dea66a.js"><link rel="prefetch" href="/study-collection/assets/js/164.3e6571fc.js"><link rel="prefetch" href="/study-collection/assets/js/165.d90e290d.js"><link rel="prefetch" href="/study-collection/assets/js/166.7b0e06d2.js"><link rel="prefetch" href="/study-collection/assets/js/167.992a4fa3.js"><link rel="prefetch" href="/study-collection/assets/js/168.67b277c4.js"><link rel="prefetch" href="/study-collection/assets/js/169.00885b1f.js"><link rel="prefetch" href="/study-collection/assets/js/17.01f22ea4.js"><link rel="prefetch" href="/study-collection/assets/js/170.514d263a.js"><link rel="prefetch" href="/study-collection/assets/js/171.3991b979.js"><link rel="prefetch" href="/study-collection/assets/js/172.2eb007cb.js"><link rel="prefetch" href="/study-collection/assets/js/173.ca2af679.js"><link rel="prefetch" href="/study-collection/assets/js/174.018c23cb.js"><link rel="prefetch" href="/study-collection/assets/js/175.e82a2683.js"><link rel="prefetch" href="/study-collection/assets/js/176.f056d33b.js"><link rel="prefetch" href="/study-collection/assets/js/177.10365952.js"><link rel="prefetch" href="/study-collection/assets/js/178.aa70b739.js"><link rel="prefetch" href="/study-collection/assets/js/18.03dafd6b.js"><link rel="prefetch" href="/study-collection/assets/js/19.9e35b463.js"><link rel="prefetch" href="/study-collection/assets/js/20.0a7b265b.js"><link rel="prefetch" href="/study-collection/assets/js/21.91b533bc.js"><link rel="prefetch" href="/study-collection/assets/js/22.30dc43fd.js"><link rel="prefetch" href="/study-collection/assets/js/23.2b4231a9.js"><link rel="prefetch" href="/study-collection/assets/js/24.1fae6fe0.js"><link rel="prefetch" href="/study-collection/assets/js/26.6add38e5.js"><link rel="prefetch" href="/study-collection/assets/js/27.9b109174.js"><link rel="prefetch" href="/study-collection/assets/js/28.2a00f624.js"><link rel="prefetch" href="/study-collection/assets/js/29.0d4a6e1b.js"><link rel="prefetch" href="/study-collection/assets/js/3.6198a982.js"><link rel="prefetch" href="/study-collection/assets/js/30.193cdcbd.js"><link rel="prefetch" href="/study-collection/assets/js/31.38ca088b.js"><link rel="prefetch" href="/study-collection/assets/js/32.2f6b42b4.js"><link rel="prefetch" href="/study-collection/assets/js/33.f57c38c1.js"><link rel="prefetch" href="/study-collection/assets/js/34.9fc57bc0.js"><link rel="prefetch" href="/study-collection/assets/js/35.f36a1bad.js"><link rel="prefetch" href="/study-collection/assets/js/36.103e7cfd.js"><link rel="prefetch" href="/study-collection/assets/js/37.61332003.js"><link rel="prefetch" href="/study-collection/assets/js/38.5bc14fc1.js"><link rel="prefetch" href="/study-collection/assets/js/39.999f3cca.js"><link rel="prefetch" href="/study-collection/assets/js/4.102da60b.js"><link rel="prefetch" href="/study-collection/assets/js/40.884f34b3.js"><link rel="prefetch" href="/study-collection/assets/js/41.b37290fd.js"><link rel="prefetch" href="/study-collection/assets/js/42.c386fac8.js"><link rel="prefetch" href="/study-collection/assets/js/43.39c9a7d4.js"><link rel="prefetch" href="/study-collection/assets/js/44.293a8492.js"><link rel="prefetch" href="/study-collection/assets/js/45.dce19f95.js"><link rel="prefetch" href="/study-collection/assets/js/46.ca47957e.js"><link rel="prefetch" href="/study-collection/assets/js/47.20338baf.js"><link rel="prefetch" href="/study-collection/assets/js/48.fe8612dd.js"><link rel="prefetch" href="/study-collection/assets/js/49.0b98ea44.js"><link rel="prefetch" href="/study-collection/assets/js/5.b9655e65.js"><link rel="prefetch" href="/study-collection/assets/js/50.8e1df7ec.js"><link rel="prefetch" href="/study-collection/assets/js/51.66b2f2c9.js"><link rel="prefetch" href="/study-collection/assets/js/52.f5752a71.js"><link rel="prefetch" href="/study-collection/assets/js/53.9442d446.js"><link rel="prefetch" href="/study-collection/assets/js/54.d3a26804.js"><link rel="prefetch" href="/study-collection/assets/js/55.54b6a8aa.js"><link rel="prefetch" href="/study-collection/assets/js/56.0aa89cb2.js"><link rel="prefetch" href="/study-collection/assets/js/57.9e7a21d7.js"><link rel="prefetch" href="/study-collection/assets/js/58.fff02f68.js"><link rel="prefetch" href="/study-collection/assets/js/59.599a6e7a.js"><link rel="prefetch" href="/study-collection/assets/js/6.8cccd2f4.js"><link rel="prefetch" href="/study-collection/assets/js/60.3a4cbeb6.js"><link rel="prefetch" href="/study-collection/assets/js/61.aeb3aee7.js"><link rel="prefetch" href="/study-collection/assets/js/62.a9bc5972.js"><link rel="prefetch" href="/study-collection/assets/js/63.7388a8b0.js"><link rel="prefetch" href="/study-collection/assets/js/64.d0a9ffbd.js"><link rel="prefetch" href="/study-collection/assets/js/65.2881207b.js"><link rel="prefetch" href="/study-collection/assets/js/66.b56e1e5b.js"><link rel="prefetch" href="/study-collection/assets/js/67.4f395ad2.js"><link rel="prefetch" href="/study-collection/assets/js/68.baad494e.js"><link rel="prefetch" href="/study-collection/assets/js/69.11160851.js"><link rel="prefetch" href="/study-collection/assets/js/7.58d17014.js"><link rel="prefetch" href="/study-collection/assets/js/70.e529b11c.js"><link rel="prefetch" href="/study-collection/assets/js/71.65e841d5.js"><link rel="prefetch" href="/study-collection/assets/js/72.2fbe7635.js"><link rel="prefetch" href="/study-collection/assets/js/73.dddbdfbb.js"><link rel="prefetch" href="/study-collection/assets/js/74.1df982da.js"><link rel="prefetch" href="/study-collection/assets/js/75.6f7871a8.js"><link rel="prefetch" href="/study-collection/assets/js/76.19c4218e.js"><link rel="prefetch" href="/study-collection/assets/js/77.312f4bb6.js"><link rel="prefetch" href="/study-collection/assets/js/78.36ff6369.js"><link rel="prefetch" href="/study-collection/assets/js/79.8aa8820c.js"><link rel="prefetch" href="/study-collection/assets/js/8.d0722ebf.js"><link rel="prefetch" href="/study-collection/assets/js/80.f0238cf8.js"><link rel="prefetch" href="/study-collection/assets/js/81.106bc336.js"><link rel="prefetch" href="/study-collection/assets/js/82.deda5502.js"><link rel="prefetch" href="/study-collection/assets/js/83.aaeb0174.js"><link rel="prefetch" href="/study-collection/assets/js/84.64544efa.js"><link rel="prefetch" href="/study-collection/assets/js/85.68cab14f.js"><link rel="prefetch" href="/study-collection/assets/js/86.46d830d2.js"><link rel="prefetch" href="/study-collection/assets/js/87.41274d62.js"><link rel="prefetch" href="/study-collection/assets/js/88.91ce37de.js"><link rel="prefetch" href="/study-collection/assets/js/89.00d43b22.js"><link rel="prefetch" href="/study-collection/assets/js/9.c492b108.js"><link rel="prefetch" href="/study-collection/assets/js/90.ddb1a215.js"><link rel="prefetch" href="/study-collection/assets/js/91.4e3fe761.js"><link rel="prefetch" href="/study-collection/assets/js/92.aa0ea11a.js"><link rel="prefetch" href="/study-collection/assets/js/93.acbce9be.js"><link rel="prefetch" href="/study-collection/assets/js/94.8e50d53f.js"><link rel="prefetch" href="/study-collection/assets/js/95.8e1ca184.js"><link rel="prefetch" href="/study-collection/assets/js/96.e7792d98.js"><link rel="prefetch" href="/study-collection/assets/js/97.d5f7a5f5.js"><link rel="prefetch" href="/study-collection/assets/js/98.f83c623f.js"><link rel="prefetch" href="/study-collection/assets/js/99.ed491b80.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.69cdfe8d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>TDD By Example</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>카프카 스트림즈 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>모던 자바 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/modern-java-in-action/01.html" class="sidebar-link">1장 자바 8, 9, 10, 11 : 무슨 일이 일어나고 있는가?</a></li><li><a href="/study-collection/book/modern-java-in-action/02.html" class="sidebar-link">2장 동작 파라미터화 코드 전달하기</a></li><li><a href="/study-collection/book/modern-java-in-action/03.html" class="sidebar-link">3장 람다 표현식</a></li><li><a href="/study-collection/book/modern-java-in-action/04.html" class="sidebar-link">4장 스트림 소개</a></li><li><a href="/study-collection/book/modern-java-in-action/05.html" class="sidebar-link">5장 스트림 활용</a></li><li><a href="/study-collection/book/modern-java-in-action/06.html" class="sidebar-link">6장 스트림으로 데이터 수집</a></li><li><a href="/study-collection/book/modern-java-in-action/07.html" class="active sidebar-link">7장 병렬 데이터 처리와 성능</a></li><li><a href="/study-collection/book/modern-java-in-action/08.html" class="sidebar-link">8장 컬렉션 API 개선</a></li><li><a href="/study-collection/book/modern-java-in-action/09.html" class="sidebar-link">9장 리팩터링, 테스팅, 디버깅</a></li><li><a href="/study-collection/book/modern-java-in-action/10.html" class="sidebar-link">10장 람다를 이용한 도메인 전용 언어</a></li><li><a href="/study-collection/book/modern-java-in-action/11.html" class="sidebar-link">11장 null 대신 Optional 클래스</a></li><li><a href="/study-collection/book/modern-java-in-action/12.html" class="sidebar-link">12장 새로운 냘짜와 시간 API</a></li><li><a href="/study-collection/book/modern-java-in-action/13.html" class="sidebar-link">13장 디폴트 메소드</a></li><li><a href="/study-collection/book/modern-java-in-action/14.html" class="sidebar-link">14장 자바 모듈 시스템</a></li><li><a href="/study-collection/book/modern-java-in-action/15.html" class="sidebar-link">15장 CompletableFuture와 리액티브 프로그래밍 컨셉의 기초</a></li><li><a href="/study-collection/book/modern-java-in-action/16.html" class="sidebar-link">16장 안정적 비동기 프로그래밍</a></li><li><a href="/study-collection/book/modern-java-in-action/17.html" class="sidebar-link">17장 리액티브 프로그래밍</a></li><li><a href="/study-collection/book/modern-java-in-action/18.html" class="sidebar-link">18장 함수형 관점으로 생각하기</a></li><li><a href="/study-collection/book/modern-java-in-action/19.html" class="sidebar-link">19장 함수형 프로그래밍 기법</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>객체지향의 사실과 오해</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>뇌를 자극하는 윈도우즈 시스템 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링5를 활용한 리액티브 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>코틀린 완벽 가이드</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>끄적끄적</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_7강"><a href="#_7강" class="header-anchor">#</a> 7강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-병렬-스트림">1. 병렬 스트림</a><ul><li><a href="#_1-1-순차-스트림을-병렬-스트림으로-변환하기">1-1. 순차 스트림을 병렬 스트림으로 변환하기</a></li><li><a href="#_1-2-스트림-성능-측정">1-2. 스트림 성능 측정</a></li><li><a href="#_1-3-병렬-스트림의-올바른-사용법">1-3. 병렬 스트림의 올바른 사용법</a></li><li><a href="#_1-4-병렬-스트림-효과적으로-사용하기">1-4. 병렬 스트림 효과적으로 사용하기</a></li></ul></li><li><a href="#_2-포크-조인-프레임워크">2. 포크 / 조인 프레임워크</a><ul><li><a href="#_2-1-recursivetask-활용">2-1. RecursiveTask 활용</a></li><li><a href="#_2-2-포크-조인-프레임워크를-제대로-사용하는-방법">2-2. 포크 / 조인 프레임워크를 제대로 사용하는 방법</a></li><li><a href="#_2-3-작업-훔치기">2-3. 작업 훔치기</a></li></ul></li><li><a href="#_3-spliterator-인터페이스">3. Spliterator 인터페이스</a><ul><li><a href="#_3-1-분할-과정">3-1. 분할 과정</a></li><li><a href="#_3-2-커스텀-spliterator-구현하기">3-2. 커스텀 Spliterator 구현하기</a></li></ul></li><li><a href="#_4-마치며">4. 마치며</a></li></ul></div><p></p> <h2 id="_1-병렬-스트림"><a href="#_1-병렬-스트림" class="header-anchor">#</a> 1. 병렬 스트림</h2> <ul><li>스트림 인터페이스를 이용하면 간단하게 요소를 병렬로 처리가 가능하다.</li> <li>컬렉션에 parallelStream을 호출하면 병렬 스트림이 생성된다.</li> <li>병렬 스트림이란 각각의 스레드에서 처리할 수 있도록 스트림 요소를 여러 청크로 분할한 스트림</li> <li>즉 멀티코어에서 각각의 프로세서가 청크를 담당해 처리하도록 해준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// stream 방식 두 수의 합</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">sequentialSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token comment">// 기존 자바 방식 두 수의 합</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">iterativeSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">+=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>여기서 n이 커질 경우, 병렬로 처리하는게 효율이 좋은데 기존 자바 방식은 고민할게 많지만, 스트림은 간단하다.</li></ul> <h3 id="_1-1-순차-스트림을-병렬-스트림으로-변환하기"><a href="#_1-1-순차-스트림을-병렬-스트림으로-변환하기" class="header-anchor">#</a> 1-1. 순차 스트림을 병렬 스트림으로 변환하기</h3> <ul><li>순차 스트림에 parallel 메소드를 호출하면 기존의 함수형 리듀싱 연산이 병렬로 처리된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 병렬 스트림 방식</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">parallelSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>스트림이 여러 청크로 분할되어 계산을 한다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_1.78029e68.jpg" alt="mj"></p> <ul><li>반대 개념으로 sequential을 호출해 병렬을 순차 스트림으로 변경할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sequential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parellel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>스트림의 parallel 메소드에서 병렬로 작업을 수행하는 스레드는 내부적으로 ForkJoinPool을 사용한다. ForkJoinPool은 기본적으로 프로세서수에 상응하는 스레드를 갖는다.</p></div> <h3 id="_1-2-스트림-성능-측정"><a href="#_1-2-스트림-성능-측정" class="header-anchor">#</a> 1-2. 스트림 성능 측정</h3> <ul><li>JMH를 사용해 측정한다.</li> <li>예제 프로그램은 .. 플레인 자바 프로젝트라 생략한다.</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jmh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jmh-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.17.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jmh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jmh-generator-annprocess<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.17.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>build 플러그인 설정도 해준다.</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>finalName</span><span class="token punctuation">&gt;</span></span>benchmarks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>finalName</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span> <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.maven.plugins.shade.
                                     resource.ManifestResourceTransformer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>org.openjdk.jmh.Main<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@BenchmarkMode</span><span class="token punctuation">(</span><span class="token class-name">Mode</span><span class="token punctuation">.</span><span class="token class-name">AverageTime</span><span class="token punctuation">)</span>  <span class="token comment">// 벤치마크 대상 메소드를 실행하는 데 걸리는 평균 시간 측정</span>
<span class="token annotation punctuation">@OutputTimeUnit</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token comment">// 벤치마크 결과를 밀리초 단위로 롤백</span>
<span class="token annotation punctuation">@Fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> jvmArgs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;-Xms4G&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-Xmx4G&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 4Gb의 힙 공간을 제공한 환경에서 두번 실행해서 테스트 신뢰성 확보</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParallelStreamBenchmark</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token class-name">N</span><span class="token operator">=</span> <span class="token number">10_000_000L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Benchmark</span> <span class="token comment">// 벤치마크 대상 메소드</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sequentialSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token class-name">N</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TearDown</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span><span class="token class-name">Invocation</span><span class="token punctuation">)</span> <span class="token comment">// 매 번 벤치마크 실행 후 GC 동작 시도</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>결과는 다음과 같다.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Benchmark                                Mode  Cnt    Score    Error  Units
ParallelStreamBenchmark.sequentialSum    avgt   40  121.843 ±  3.062  ms/op

Benchmark                                Mode  Cnt    Score    Error  Units
ParallelStreamBenchmark.iterativeSum     avgt   40    3.278 ±  0.192  ms/op

Benchmark                                Mode  Cnt    Score    Error  Units
ParallelStreamBenchmark.parallelSum      avgt   40  604.059 ± 55.288  ms/op
</code></pre></div><ul><li>전통적인 for loop이 박싱 언박싱이 필요가 없어서 4배 (40배같은데..) 빠르다.</li> <li>병렬로 하면 쿼드코어 일 때도 순차적인 스트림 보다도 5배나 느리다.</li> <li>이유는 다음과 같다</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 반복 결과로 박싱된 객체가 만들어지므로 숫자를 더하려면 언박싱을 해야 한다<span class="token punctuation">.</span>

<span class="token number">2.</span> 반복 작업은 병렬로 수행할 수 있는 독립 단위로 나누기가 어렵다<span class="token punctuation">.</span>
</code></pre></div><ul><li>2번이 문제인데, 실제로 병렬로 수행할 수 있는 스트림 모델이 있어야 병렬 스트림을 제대로 테스트 해볼 수 있다.</li> <li>iterate 자체가 본질적으로 순차 수행이어서 병렬에 적합하지가 않다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_2.65df903c.jpg" alt="mj"></p> <ul><li>리듀싱 연산이 제대로 수행되지 않는데, 리듀싱 과정을 시작하는 시점에 전체 숫자 리스트가 준비되지 않았으므로 스트림을 병렬로 처리할 수 있도록 청크로 분할할 수 없다.</li> <li>스트림이 병렬로 처리되도록 지시했고 각각의 합계가 다른 스레드에서 수해되었지만, 순차 처리랑 다를바가 없어 결국 스레드를 나누고 할당하는 오버헤드만 증가해 효율이 떨어졌다.</li> <li>병렬을 잘못쓰면 이렇게 망하는 경우가 있으니 잘 이해하고 써야 한다.</li></ul> <h4 id="더-특화된-메소드-사용"><a href="#더-특화된-메소드-사용" class="header-anchor">#</a> 더 특화된 메소드 사용</h4> <ul><li>좀더 효율적으로 합계 연산을 병렬로 처리하려면 LongStream.rangeClosed라는 메소드를 사용해야 한다.
<ul><li>LongStream.rangeClosed는 기본형 long을 직접 사용하므로 박싱과 언박싱 오버헤드가 사라진다.</li> <li>LongStream.rangeClosed는 쉽게 청크로 분할할 수 있는 숫자 범위를 생산한다. 예를 들어 1-20 범위의 숫자를 각각 1-5, 6-10, 11-15, 16-20 범위의 숫자로 분할할 수 있다.</li></ul></li> <li>언박싱에 소비되는 오버헤드를 측정해 보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Benchmark</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">rangedSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>결과</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Benchmark                                Mode  Cnt    Score    Error  Units
ParallelStreamBenchmark.rangedSum        avgt   40    5.315 ±  0.285  ms/op
</code></pre></div><ul><li>iterate 팩토리 메소드로 생성한 순차보다 훨씬 더 빠르다.</li> <li>특화되지 않은 스트림을 처리할 때는 오토박싱, 언박싱 등의 오버헤들르 수반해 느려진다.</li> <li>새로운 버전에 병렬을 적용해 보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Benchmark</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">parallelRangedSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>결과</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Benchmark                                  Mode  Cnt  Score    Error  Units
ParallelStreamBenchmark.parallelRangedSum  avgt   40  2.677 ±  0.214  ms/op
</code></pre></div><ul><li>순차 실행보다 빨라진다.</li></ul> <h3 id="_1-3-병렬-스트림의-올바른-사용법"><a href="#_1-3-병렬-스트림의-올바른-사용법" class="header-anchor">#</a> 1-3. 병렬 스트림의 올바른 사용법</h3> <ul><li>병렬 스트림을 잘못 사용하면서 발생하는 많은 문제는 공유된 상태를 바꾸는 알고리즘을 사용하기 때문에 일어난다.</li> <li>다음은 n까지의 자연수를 더하면서 공유된 누적자를 바꾸는 프로그램을 구현한 코드</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sideEffectSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Accumulator</span> accumulator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>accumulator<span class="token operator">:</span><span class="token operator">:</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> accumulator<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Accumulator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">long</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      total <span class="token operator">+=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>위의 코드는 본질적으로 순차 실행할 수 있도록 구현되어 있으므로 병렬로 실행하면 참사가 일어난다.</li> <li>특히 total에 접근할 때마다 데이터 레이스 문제가 발생한다. (공유데이터 문제)</li> <li>결국 병렬로 만들면 망하는 코드가 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sideEffectParallelSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Accumulator</span> accumulator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>accumulator<span class="token operator">:</span><span class="token operator">:</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> accumulator<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>실행 결과를 출력해보면</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Result: 5959989000692
Result: 7425264100768
Result: 6827235020033
Result: 7192970417739
Result: 6714157975331
Result: 7497810541907
Result: 6435348440385
Result: 6999349840672
Result: 7435914379978
Result: 7715125932481
SideEffect parallel sum done in: 49 msecs
</code></pre></div><ul><li>느린건 둘째치고 값부터 제대로 안나온다.</li> <li>여러 스레드에서 동시에 공유값, total에 접근하다 보니 문제가 발생한다.</li></ul> <h3 id="_1-4-병렬-스트림-효과적으로-사용하기"><a href="#_1-4-병렬-스트림-효과적으로-사용하기" class="header-anchor">#</a> 1-4. 병렬 스트림 효과적으로 사용하기</h3> <ul><li>적절한 벤치마크로 성능 측정 후에 병렬을 사용하자</li> <li>박싱을 주의하자. 방식을 피하도록 특화 스트림인 IntStream, LongStream 등을 잘 활용하자</li> <li>limit 이나 findFirst처럼 요소의 순서에 의존하는 연산은 순차 스트림이 병렬 스트림보다 빠르다.</li> <li>스트림에서 수행하는 전체 파이프라인 연산 비용을 고려해야 한다.</li> <li>소량의 데이터에선 병렬이 후지므로 쓰지 말자</li> <li>스트림을 구성하는 자료구조가 적절한지 확인을 해야한다.</li> <li>최종 연산의 병합과정 비용을 잘 살펴봐야 한다.</li></ul> <table><thead><tr><th>소스</th> <th>분해성</th></tr></thead> <tbody><tr><td>ArrayList</td> <td>굿</td></tr> <tr><td>LinkedList</td> <td>뱃</td></tr> <tr><td>IntStream.range</td> <td>굿</td></tr> <tr><td>Stream.iterate</td> <td>뱃</td></tr> <tr><td>HashSet</td> <td>굿</td></tr> <tr><td>TreeSet</td> <td>굿</td></tr></tbody></table> <h2 id="_2-포크-조인-프레임워크"><a href="#_2-포크-조인-프레임워크" class="header-anchor">#</a> 2. 포크 / 조인 프레임워크</h2> <ul><li>포크 / 조인 프레임워크는 병렬화 할 수 있는 작업을 재귀적으로 작은 작업으로 분할한 다음에 서브태스크 각각의 결과를 합쳐서 전체 결과를 마들도록 설계되었다.</li></ul> <h3 id="_2-1-recursivetask-활용"><a href="#_2-1-recursivetask-활용" class="header-anchor">#</a> 2-1. RecursiveTask 활용</h3> <ul><li>스레드 풀을 이용하려면 RecursiveTask<R> 의 서브클래스를 생성해야 한다.</R></li> <li>RecursiveTask를 정의하려면 추상메소드 compute를 구현해야 한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">R</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>compute 메소드는 태스크를 서브태스크로 분할하는 로직과 더 이상 분할할 수 없을 때 개별 서브태스크의 결과를 생산할 알고리즘을 정의한다.</li> <li>따라서 대부분의 compute 메소드 구현은 다음과 같은 형식을 유지한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>태스크가 충분히 작거나 더 이상 분할할 수 없으면<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    순차적으로 태스크 계산
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    태스크를 두 서브태스크로 분할
    태스크가 다시 서브태스크로 분할되도록 이 메소드를 재귀적으로 호출함
    모든 서브태스크의 연산이 완료될 때까지 기다림
    각 서브태스크의 결과를 합침
<span class="token punctuation">}</span>
</code></pre></div><ul><li>divide &amp; conquer 알고리즘의 병렬화 버전이다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_3.30508c55.jpg" alt="mj"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> chap7<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time</span><span class="token punctuation">.</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">RecursiveTask</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinSumCalculator</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> THRESHOLD <span class="token operator">=</span> <span class="token number">10_000</span><span class="token punctuation">;</span> <span class="token comment">// 이 값 이하의 서브태스크는 분리 불가능</span>

  <span class="token keyword">public</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numbers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>numbers <span class="token operator">=</span> numbers<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ForkJoinSumCalculator</span> leftTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start<span class="token punctuation">,</span> start <span class="token operator">+</span> length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leftTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ForkJoinSumCalculator</span> rightTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start <span class="token operator">+</span> length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rightTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Long</span> rightResult <span class="token operator">=</span> rightTask<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> leftResult <span class="token operator">=</span> leftTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 첫 번째 서브태스크의결과를 읽거나 아직 결과가 없으면 기다린다.</span>

    <span class="token keyword">return</span> leftResult <span class="token operator">+</span> rightResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sum <span class="token operator">+=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>실제 실행 시에 생성자에 원하는 수의 배열을 넘겨줄 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinSumCalculator</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ForkJoinPool에서 실행되는 마지막 invoke 메소드의 반환값은 ForkJoinSumCalculator에서 정의한 태스크의 결과가 된다.</li></ul> <h4 id="forkjoinsumcaclulator-실행"><a href="#forkjoinsumcaclulator-실행" class="header-anchor">#</a> ForkJoinSumCaclulator 실행</h4> <ul><li>ForkJoinSumCaclulator를 ForkJoinPool로 전달하면 풀의 스레드가 ForkJoinSumCaclulator의 compute 메소드를 실행하면서 작업을 수행한다.</li> <li>이후에 Divide &amp; Conquer 로직처럼 분해했다가 다시 합치면서 병렬 계산을 수행한다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_4.cab7ed00.jpg" alt="mj"></p> <h3 id="_2-2-포크-조인-프레임워크를-제대로-사용하는-방법"><a href="#_2-2-포크-조인-프레임워크를-제대로-사용하는-방법" class="header-anchor">#</a> 2-2. 포크 / 조인 프레임워크를 제대로 사용하는 방법</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> join 메소드를 태스크에 호출하면 태스크가 생산하는 결과가 준비될 때까지 호출자를 블록시킨다<span class="token punctuation">.</span>
따라서 두 서브태스크가 모두 시작된 다음에 join을 호출해야 한다<span class="token punctuation">.</span>

<span class="token number">2.</span> <span class="token class-name">RecursiveTask</span> 내에서는 <span class="token class-name">ForkJoinPool</span>의 invoke 메소드를 사용하지 말아야 한다<span class="token punctuation">.</span>
compute나 fork 메소드를 사용하고<span class="token punctuation">,</span> 실제로 병렬 계산을 시작할 때만 invoke를 사용한다<span class="token punctuation">.</span>

<span class="token number">3.</span> 서브트스크에 fork 메소드를 호출해서 <span class="token class-name">ForkJoinPool</span>의 일정을 조절할 수 잇다<span class="token punctuation">.</span>
한쪽은 fork<span class="token punctuation">,</span> 한쪽은 compute 를 호출하는게 효율적이다<span class="token punctuation">.</span>

<span class="token number">4.</span> 포크 <span class="token operator">/</span> 조인 프레임워크를 이용하는 병렬 계산은 디버깅하기 어렵다<span class="token punctuation">.</span>

<span class="token number">5.</span> 포크 <span class="token operator">/</span> 조인 프레임워크를 사용하는게 순차 처리보다 무조건 빠른건 아니다<span class="token punctuation">.</span>
</code></pre></div><h3 id="_2-3-작업-훔치기"><a href="#_2-3-작업-훔치기" class="header-anchor">#</a> 2-3. 작업 훔치기</h3> <ul><li>ForkJoinPool의 모든 스레드를 거의 공정하게 분할한다.</li> <li>각각의 스레드는 자신에게 할당된 태스크를 포함하는 이중 연결 리스트를 참조하면서 작업이 끝날 때마다 큐의 헤드에서 다른 태스크를 가져와서 작업을 처리한다.</li> <li>이때 한 스레드는 다른 스레드보다 자신에게 할당된 태스크를 더 빨리 처리 할 수 있다.</li> <li>이러면 끝난놈은 쉬는게 아니라 다른 스레드 큐의 꼬리에서 작업을 훔쳐온다.</li> <li>계속 안놀고 훔쳐온다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_5.ffa51bbc.jpg" alt="mj"></p> <h2 id="_3-spliterator-인터페이스"><a href="#_3-spliterator-인터페이스" class="header-anchor">#</a> 3. Spliterator 인터페이스</h2> <ul><li>Spliterator란 분할할 수 있는 반복자 라는 뜻</li> <li>Spliterator는 병렬작업에 특화되어 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-분할-과정"><a href="#_3-1-분할-과정" class="header-anchor">#</a> 3-1. 분할 과정</h3> <ul><li>스트림을 여러 스트림으로 분할하는 과정은 재귀적으로 일어난다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_6.f6803589.jpg" alt="mj"></p> <ul><li>trySplit호출 시 null을 반환할 때까지 과정을 반복한다.</li></ul> <h4 id="spliterator-특성"><a href="#spliterator-특성" class="header-anchor">#</a> Spliterator 특성</h4> <ul><li>Spliterator는 characteristics라는 추상 메소드도 정의한다.</li> <li>Characteristics 메소드는 Spliterator 자체의 특성 집합을 포함하는 int를 반환한다.</li></ul> <table><thead><tr><th>특성</th> <th>의미</th></tr></thead> <tbody><tr><td>ORDERED</td> <td>리스트처럼 요소에 정해진 순서가 있으므로 Spliterator는 요소를 탐색하고 분할 할 때 이 순서에 유의해야 한다.</td></tr> <tr><td>DISTICT</td> <td>x, y 두 요소를 방문했을 때 x.equals(y)는 항상 false를 반환한다.</td></tr> <tr><td>SORTED</td> <td>탐색된 요소는 미리 정의된 정렬 순서를 따른다.</td></tr> <tr><td>SIZED</td> <td>크기가 알려진 소스로 Spliterator를 생성했으므로 estimatedSize()는 정확한 값을 반환한다.</td></tr> <tr><td>NON-NULL</td> <td>탐색하는 모든 요소는 null이 아니다.</td></tr> <tr><td>IMMUTABLE</td> <td>이 Spliterator의 소스는 불변이다. 즉 요소를 탐색하는 동안 요소를 추가하거나, 삭제하거나, 고칠 수 없다.</td></tr> <tr><td>CONCURRENT</td> <td>동기화 없이 Spliterator의 소스를 여러 스레드에서 동시에 고칠 수 있다.</td></tr> <tr><td>SUBSIZED</td> <td>이 Spliterator 그리고 분할되는 모든 Spliterator는 SIZED 특성을 갖는다.</td></tr></tbody></table> <h3 id="_3-2-커스텀-spliterator-구현하기"><a href="#_3-2-커스텀-spliterator-구현하기" class="header-anchor">#</a> 3-2. 커스텀 Spliterator 구현하기</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">countWordsIteratively</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> lastSpace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c <span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastSpace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastSpace<span class="token punctuation">)</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>
        lastSpace <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>잘 작동한다.</li> <li>이걸 함수형을 이용해 수정해 보자</li></ul> <h4 id="함수형으로-단어-수를-세는-메소드-재구현하기"><a href="#함수형으로-단어-수를-세는-메소드-재구현하기" class="header-anchor">#</a> 함수형으로 단어 수를 세는 메소드 재구현하기</h4> <ul><li>String을 스트림으로 변환해야 하는데, 기본형이 없으니 Stream<Character> 를 쓰자.</Character></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SENTENCE<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>SENTENCE<span class="token operator">:</span><span class="token operator">:</span><span class="token function">charAt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCounter</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> counter<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> lastSpace<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span><span class="token keyword">int</span> counter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> lastSpace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> counter<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastSpace <span class="token operator">=</span> lastSpace<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">WordCounter</span> <span class="token function">accumulate</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> lastSpace <span class="token operator">?</span>
          <span class="token keyword">this</span> <span class="token operator">:</span>
          <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> lastSpace <span class="token operator">?</span>
          <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span>
          <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">WordCounter</span> <span class="token function">combine</span><span class="token punctuation">(</span><span class="token class-name">WordCounter</span> wordCounter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> wordCounter<span class="token punctuation">.</span>counter<span class="token punctuation">,</span>
        wordCounter<span class="token punctuation">.</span>lastSpace<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>accumulate 메소드는 WordCounter의 상태를 어떻게 바꿀 것인지, 또는 엄밀히 WordCounter는 불변 클래스이므로 새로운 WordCounter클래스를 어떤 상태로 생성할 것인지 정의한다.</li> <li>아래는 accumulate에서 새로운 문자를 탐색했을 때 WordCounter의 상태 변이를 보여준다.</li></ul> <p><img src="/study-collection/assets/img/mj_7_7.81540fb6.jpg" alt="mj"></p> <ul><li>combine 메소드는 문자열 서브 스트림을 처리한 WordCounter의 결과를 합친다.</li> <li>즉 combine은 WordCounter의 내부 counter 값을 서로 합친다.</li> <li>이제 이거로 문자스트림의 리듀싱 연산을 구현해 볼 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">countWords</span><span class="token punctuation">(</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WordCounter</span> wordCounter <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">WordCounter</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">accumulate</span><span class="token punctuation">,</span> <span class="token class-name">WordCounter</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">combine</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> wordCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="wordcounter-병렬로-수행하기"><a href="#wordcounter-병렬로-수행하기" class="header-anchor">#</a> WordCounter 병렬로 수행하기</h4> <ul><li>이걸 병렬로 해보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">countWords</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>11이 나와야 되는데 37이 나온다.</li> <li>순차 스트림을 병렬 스트림으로 바꿀 때 스트림 분할 위치에 따라 잘못된 결과가 나올 수 있다.</li> <li>이걸 해결하기 위해선 문자열을 임의의 위치에서 분할하지 말고 단어가 끝나는 위치에서만 분할하는 방법으로 해결할 수 있다.</li> <li>요럴때 필요한게 Spliterator</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> chap7<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Spliterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function</span><span class="token punctuation">.</span><span class="token class-name">Consumer</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCounterSpliterator</span> <span class="token keyword">implements</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> string<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> currentChar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">WordCounterSpliterator</span><span class="token punctuation">(</span><span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>string <span class="token operator">=</span> string<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>currentChar<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 현재 문자를 소비한다.</span>
    <span class="token keyword">return</span> currentChar <span class="token operator">&lt;</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 소비할 문자가 남아있으면 true를 반환</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> currentSize <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentChar<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSize <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> splitPos <span class="token operator">=</span> currentSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> currentChar<span class="token punctuation">;</span> splitPos <span class="token operator">&lt;</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> splitPos<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>splitPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> spliterator <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">WordCounterSpliterator</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentChar<span class="token punctuation">,</span> splitPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentChar <span class="token operator">=</span> splitPos<span class="token punctuation">;</span>
        <span class="token keyword">return</span> spliterator<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentChar<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ORDERED <span class="token operator">+</span> SIZED <span class="token operator">+</span> SUBSIZED <span class="token operator">+</span> NONNULL <span class="token operator">+</span> IMMUTABLE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="wordcounterspliterator-활용"><a href="#wordcounterspliterator-활용" class="header-anchor">#</a> WordCounterSpliterator 활용</h4> <ul><li>이제 병렬로 문자 카운팅이 가능해 진다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> spliterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WordCounterSpliterator</span><span class="token punctuation">(</span>SENTENCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> parallelStream <span class="token operator">=</span> <span class="token class-name">StreamSupport</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> parallelWordCount <span class="token operator">=</span> <span class="token function">countWords</span><span class="token punctuation">(</span>parallelStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>parallelWordCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>결과 잘 나옴</li></ul> <h2 id="_4-마치며"><a href="#_4-마치며" class="header-anchor">#</a> 4. 마치며</h2> <ul><li>내부 반복을 이용하면 명시적으로 다른 스레드를 사용하지 않고도 스트림을 병렬로 처리할 수 있다.</li> <li>간단하게 스트림을 병렬로 처리할 수 있지만, 항상 병렬이 빠른게 아니므로 성능을 직접 측정해 보아야 한다.</li> <li>병렬 스트림으로 데이터 집합을 병렬 실행할 때 특히 처리해야 할 데이터가 아주 많거나 각 요소를 처리하는 데 오랜 시간이 걸릴 때 성능을 높일 수 있다.</li> <li>가능하면 기본형 특화 스트림을 사용하는 등 올바른 자료구조 선택이 어떤 연산을 병렬로 처리하는 것보다 성능적으로 더 큰 영향을 미칠 수 있다.</li> <li>포크/조인 프레임워크에서는 병렬화할 수 있는 태스크를 작은 태스크로 분할한 다음에 분할된 태스크를 각각의 스레드로 실행하며 서브태스크 각각의 결과를 합쳐서 최종 결과를 생산한다.</li> <li>Spliterator는 탐색하려는 데이터를 포함하는 스트림을 어떻게 병렬화 할 것인지 정의한다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/modern-java-in-action/06.html" class="prev">6장 스트림으로 데이터 수집</a></span> <span class="next"><a href="/study-collection/book/modern-java-in-action/08.html">8장 컬렉션 API 개선</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.92abfddd.js" defer></script><script src="/study-collection/assets/js/2.18806e4e.js" defer></script><script src="/study-collection/assets/js/25.fd7e0fb5.js" defer></script>
  </body>
</html>
