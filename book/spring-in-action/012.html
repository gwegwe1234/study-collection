<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>12강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.48760978.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.eeb7b2c8.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.47cec677.js" as="script"><link rel="preload" href="/study-collection/assets/js/28.681f8e9f.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.519075ef.js"><link rel="prefetch" href="/study-collection/assets/js/11.dc293d66.js"><link rel="prefetch" href="/study-collection/assets/js/12.54773ff9.js"><link rel="prefetch" href="/study-collection/assets/js/13.214e9fc0.js"><link rel="prefetch" href="/study-collection/assets/js/14.c238d2a8.js"><link rel="prefetch" href="/study-collection/assets/js/15.daf5b534.js"><link rel="prefetch" href="/study-collection/assets/js/16.01c6a401.js"><link rel="prefetch" href="/study-collection/assets/js/17.406cb4f3.js"><link rel="prefetch" href="/study-collection/assets/js/18.e53fb9c8.js"><link rel="prefetch" href="/study-collection/assets/js/19.54b74474.js"><link rel="prefetch" href="/study-collection/assets/js/20.79844ec8.js"><link rel="prefetch" href="/study-collection/assets/js/21.0365e010.js"><link rel="prefetch" href="/study-collection/assets/js/22.d012f840.js"><link rel="prefetch" href="/study-collection/assets/js/23.7481d6e5.js"><link rel="prefetch" href="/study-collection/assets/js/24.059e34a5.js"><link rel="prefetch" href="/study-collection/assets/js/25.034b76a0.js"><link rel="prefetch" href="/study-collection/assets/js/26.51ef0994.js"><link rel="prefetch" href="/study-collection/assets/js/27.54534641.js"><link rel="prefetch" href="/study-collection/assets/js/29.06d5d663.js"><link rel="prefetch" href="/study-collection/assets/js/3.b84f9e9f.js"><link rel="prefetch" href="/study-collection/assets/js/30.fed64dbb.js"><link rel="prefetch" href="/study-collection/assets/js/31.b2808cea.js"><link rel="prefetch" href="/study-collection/assets/js/32.56861aaf.js"><link rel="prefetch" href="/study-collection/assets/js/33.e89be56b.js"><link rel="prefetch" href="/study-collection/assets/js/34.3c532cd5.js"><link rel="prefetch" href="/study-collection/assets/js/35.72f6a55c.js"><link rel="prefetch" href="/study-collection/assets/js/36.a513c019.js"><link rel="prefetch" href="/study-collection/assets/js/37.bbc58c59.js"><link rel="prefetch" href="/study-collection/assets/js/38.3327f8ce.js"><link rel="prefetch" href="/study-collection/assets/js/39.76de1d70.js"><link rel="prefetch" href="/study-collection/assets/js/4.f59e9cfa.js"><link rel="prefetch" href="/study-collection/assets/js/40.50ae7f37.js"><link rel="prefetch" href="/study-collection/assets/js/41.3f69894e.js"><link rel="prefetch" href="/study-collection/assets/js/42.af52bbbf.js"><link rel="prefetch" href="/study-collection/assets/js/43.d233d845.js"><link rel="prefetch" href="/study-collection/assets/js/44.71b1d230.js"><link rel="prefetch" href="/study-collection/assets/js/45.0e6b69e9.js"><link rel="prefetch" href="/study-collection/assets/js/46.3b25e023.js"><link rel="prefetch" href="/study-collection/assets/js/47.19d966ee.js"><link rel="prefetch" href="/study-collection/assets/js/48.ca2c227f.js"><link rel="prefetch" href="/study-collection/assets/js/49.8639f7d9.js"><link rel="prefetch" href="/study-collection/assets/js/5.bf68b37d.js"><link rel="prefetch" href="/study-collection/assets/js/50.20e2f72c.js"><link rel="prefetch" href="/study-collection/assets/js/51.2b6d45f8.js"><link rel="prefetch" href="/study-collection/assets/js/52.73f16594.js"><link rel="prefetch" href="/study-collection/assets/js/53.4f2e907d.js"><link rel="prefetch" href="/study-collection/assets/js/54.a291dd31.js"><link rel="prefetch" href="/study-collection/assets/js/55.0a014030.js"><link rel="prefetch" href="/study-collection/assets/js/56.057db87b.js"><link rel="prefetch" href="/study-collection/assets/js/57.c40890e9.js"><link rel="prefetch" href="/study-collection/assets/js/58.1c873e93.js"><link rel="prefetch" href="/study-collection/assets/js/59.b5e2bf10.js"><link rel="prefetch" href="/study-collection/assets/js/6.c16e3183.js"><link rel="prefetch" href="/study-collection/assets/js/60.343b38ee.js"><link rel="prefetch" href="/study-collection/assets/js/61.6f86d77a.js"><link rel="prefetch" href="/study-collection/assets/js/62.9905c38b.js"><link rel="prefetch" href="/study-collection/assets/js/63.11c4daf1.js"><link rel="prefetch" href="/study-collection/assets/js/64.01bc4357.js"><link rel="prefetch" href="/study-collection/assets/js/65.8f23842b.js"><link rel="prefetch" href="/study-collection/assets/js/66.08104a47.js"><link rel="prefetch" href="/study-collection/assets/js/67.6dfa4186.js"><link rel="prefetch" href="/study-collection/assets/js/68.d5438c1d.js"><link rel="prefetch" href="/study-collection/assets/js/69.11c535d3.js"><link rel="prefetch" href="/study-collection/assets/js/7.5bd82421.js"><link rel="prefetch" href="/study-collection/assets/js/70.1a651c79.js"><link rel="prefetch" href="/study-collection/assets/js/71.e42b1ae9.js"><link rel="prefetch" href="/study-collection/assets/js/72.8f5f9707.js"><link rel="prefetch" href="/study-collection/assets/js/73.385b81b2.js"><link rel="prefetch" href="/study-collection/assets/js/74.75c88583.js"><link rel="prefetch" href="/study-collection/assets/js/75.0d50196b.js"><link rel="prefetch" href="/study-collection/assets/js/76.3a9710d8.js"><link rel="prefetch" href="/study-collection/assets/js/77.53bd05fc.js"><link rel="prefetch" href="/study-collection/assets/js/78.4d7bd78c.js"><link rel="prefetch" href="/study-collection/assets/js/79.61deaa22.js"><link rel="prefetch" href="/study-collection/assets/js/8.c5bbd57b.js"><link rel="prefetch" href="/study-collection/assets/js/80.80dcac1a.js"><link rel="prefetch" href="/study-collection/assets/js/81.125980e0.js"><link rel="prefetch" href="/study-collection/assets/js/82.bc041f84.js"><link rel="prefetch" href="/study-collection/assets/js/83.e4956489.js"><link rel="prefetch" href="/study-collection/assets/js/84.19d632a0.js"><link rel="prefetch" href="/study-collection/assets/js/85.c7d03ae4.js"><link rel="prefetch" href="/study-collection/assets/js/86.f86fae41.js"><link rel="prefetch" href="/study-collection/assets/js/87.0d2c2048.js"><link rel="prefetch" href="/study-collection/assets/js/88.aa26952e.js"><link rel="prefetch" href="/study-collection/assets/js/89.6f705cd1.js"><link rel="prefetch" href="/study-collection/assets/js/9.483b050d.js"><link rel="prefetch" href="/study-collection/assets/js/90.bb09d996.js"><link rel="prefetch" href="/study-collection/assets/js/91.9fcb74bc.js"><link rel="prefetch" href="/study-collection/assets/js/92.aab30ff8.js"><link rel="prefetch" href="/study-collection/assets/js/93.f20e7f45.js"><link rel="prefetch" href="/study-collection/assets/js/94.bbe0e91c.js"><link rel="prefetch" href="/study-collection/assets/js/95.1b606e04.js"><link rel="prefetch" href="/study-collection/assets/js/96.962d3f39.js"><link rel="prefetch" href="/study-collection/assets/js/97.09b3b895.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.48760978.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>스프링 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/spring-in-action/001.html" class="sidebar-link">1장 스프링 속으로</a></li><li><a href="/study-collection/book/spring-in-action/002.html" class="sidebar-link">2장 빈 와이어링</a></li><li><a href="/study-collection/book/spring-in-action/003.html" class="sidebar-link">3장 고급 와이어링</a></li><li><a href="/study-collection/book/spring-in-action/004.html" class="sidebar-link">4장 애스펙트 지향 스프링</a></li><li><a href="/study-collection/book/spring-in-action/005.html" class="sidebar-link">5장 스프링 웹 어플리케이션 만들기</a></li><li><a href="/study-collection/book/spring-in-action/006.html" class="sidebar-link">6장 웹 뷰 렌더링</a></li><li><a href="/study-collection/book/spring-in-action/007.html" class="sidebar-link">7장 고급 스프링MVC</a></li><li><a href="/study-collection/book/spring-in-action/008.html" class="sidebar-link">8장 스프링 웹플로로 작업하기</a></li><li><a href="/study-collection/book/spring-in-action/009.html" class="sidebar-link">9장 웹 어플리케이션 보안</a></li><li><a href="/study-collection/book/spring-in-action/010.html" class="sidebar-link">10장 스프링과 JDBC를 사용하여 데이터베이스 사용하기</a></li><li><a href="/study-collection/book/spring-in-action/011.html" class="sidebar-link">11장 객체 관계형 매핑을 통한 데이터 퍼시스팅</a></li><li><a href="/study-collection/book/spring-in-action/012.html" class="active sidebar-link">12장 NoSQL 데이터베이스 사용하기</a></li><li><a href="/study-collection/book/spring-in-action/013.html" class="sidebar-link">13장 데이터 캐싱하기</a></li><li><a href="/study-collection/book/spring-in-action/014.html" class="sidebar-link">14장 시큐리티 메소드</a></li><li><a href="/study-collection/book/spring-in-action/015.html" class="sidebar-link">15장 원격 서비스 사용하기</a></li><li><a href="/study-collection/book/spring-in-action/016.html" class="sidebar-link">16장 스프링 MVC로 REST API 사용하기</a></li><li><a href="/study-collection/book/spring-in-action/017.html" class="sidebar-link">17장 스프링 메시징</a></li><li><a href="/study-collection/book/spring-in-action/018.html" class="sidebar-link">18장 WebSocket과 STOMP를 사용하여 메시징하기</a></li><li><a href="/study-collection/book/spring-in-action/019.html" class="sidebar-link">19장 이메일 전송을 위해 스프링 설정하기</a></li><li><a href="/study-collection/book/spring-in-action/020.html" class="sidebar-link">20장 JMX를 이용한 스프링 빈 관리</a></li><li><a href="/study-collection/book/spring-in-action/021.html" class="sidebar-link">21장 스프링 부트를 사용한 스프링 개발 간소화</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>카프카 스트림즈 인 액션</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_12강"><a href="#_12강" class="header-anchor">#</a> 12강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-mongodb의-유지성-도큐먼트">1. MongoDB의 유지성 도큐먼트</a><ul><li><a href="#_1-1-mongodb-활성화">1-1. MongoDB 활성화</a></li><li><a href="#_1-2-mongodb-퍼시스턴트를-위한-어노테이션-모델-타입">1-2. MongoDB 퍼시스턴트를 위한 어노테이션 모델 타입</a></li><li><a href="#_1-3-mongotemplate을-사용하여-mongodb-액세스하기">1-3. MongoTemplate을 사용하여 MongoDB 액세스하기</a></li><li><a href="#_1-4-mongodb-저장소-작성하기">1-4. MongoDB 저장소 작성하기.</a></li></ul></li><li><a href="#_2-neo4j로-그래프-데이터-사용하기">2. Neo4j로 그래프 데이터 사용하기</a><ul><li><a href="#_2-1-스프링-데이터-neo4j-설정하기">2-1. 스프링 데이터 Neo4j 설정하기</a></li><li><a href="#_2-2-그래프-엔티티-어노테이션하기">2-2. 그래프 엔티티 어노테이션하기</a></li><li><a href="#_2-3-neo4jtemplate-사용하기">2-3. Neo4jTemplate 사용하기</a></li><li><a href="#_2-4-자동-neo4j-저장소-만들기">2-4. 자동 Neo4j 저장소 만들기</a></li></ul></li><li><a href="#_3-redis에서-키-값-데이터-사용하기">3. Redis에서 키-값 데이터 사용하기</a><ul><li><a href="#_3-1-redis에-연결하기">3-1. Redis에 연결하기</a></li><li><a href="#_3-2-redistemplate을-가지고-작업하기">3-2 RedisTemplate을 가지고 작업하기</a></li><li><a href="#_3-3-키와-값의-직렬-변환-설정">3-3. 키와 값의 직렬 변환 설정</a></li></ul></li></ul></div><p></p> <h2 id="_1-mongodb의-유지성-도큐먼트"><a href="#_1-mongodb의-유지성-도큐먼트" class="header-anchor">#</a> 1. MongoDB의 유지성 도큐먼트</h2> <ul><li>MongoDB는 오픈소스 도큐먼트 데이터 베이스</li> <li>스프링 데이터 MongoDB는 스프링 어플리케이션이 MongoDB를 사용하는 다음과 같은 세가지 기능을 지원해준다.
<ul><li>객체 도큐먼트 매핑을 위한 어노테이션</li> <li>MongoTemplate을 사용한 템플릿 기반의 데이터베이스 액세스</li> <li>자동 런타임 저장소 생성</li></ul></li> <li>MongoDB도 스프링 데이터 JPA와 비슷하게 자동 저장소 생성 설정을 해준다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>도큐먼트 데이터베이스를 언제 써야될지 확실하게 판단해야 한다. 도큐먼트 데이터베이스는 일반적인 목적의 디비가 아니며,
문제를 해결하기 위한 좁은 범위의 세트를 가진다.</p> <p>도큐먼트 데이터베이스는 중요 관계성을 가지는 데이터를 저장히기 위한 튜닝이 잘 되어있진 않다.
예를 들어 SNS의 사용자 사이에 어떠한 연관이 있는지 같은 데이터 저장엔 좋지 않다.</p></div> <h3 id="_1-1-mongodb-활성화"><a href="#_1-1-mongodb-활성화" class="header-anchor">#</a> 1-1. MongoDB 활성화</h3> <ul><li>스프링에서 필수적으로 설정해야할 빈
<ul><li>MongoClient 빈</li> <li>MongoTemplate 빈</li></ul></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableMongoRepositories</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token string">&quot;order.db&quot;</span><span class="token punctuation">)</span> <span class="token comment">// MongoDB 저장소 활성화</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MongoFactoryBean</span> <span class="token function">mongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// MongoClient 빈</span>
        <span class="token class-name">MongoFactoryBean</span> mongo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mongo<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;localHost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mongo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MongoOperations</span> <span class="token function">mongoTemplate</span><span class="token punctuation">(</span><span class="token class-name">Mongo</span> mongo<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// MongoTemplate 빈</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoTemplate</span><span class="token punctuation">(</span>mongo<span class="token punctuation">,</span> <span class="token string">&quot;OrdersDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>@EnableMongoRepositories 는 JPA의 @EnableJpaRepositories와 비슷한 역할</li> <li>MongoFactoryBean은 스프링 데이터 MongoDB와 데이터베이스 간의 다리 역할을 한다.
<ul><li>관계형 DB에서의 DataSource와는 역할이 다르다.</li></ul></li> <li>데이터베이스에 쿼리하기 위해서 MongoTemplate이 필요하다
<ul><li>직접적으로 사용하지 않더라도, 자동생성된 저장소를 사용할 수 있으므로 이 빈은 필요하다.</li></ul></li> <li>직접 이 빈을 선언하는 것 보다는 설정클래스를 AbstractMongoConfiguration을 확장하고, getDatabaseName(), mongo()를 오버라이드 한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableMongoRepositories</span><span class="token punctuation">(</span><span class="token string">&quot;orders.db&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMongoConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Overrride</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getDatabaseName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 데이터베이스 명 지정</span>
        <span class="token keyword">return</span> <span class="token string">&quot;OrdersDB&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mongo</span> <span class="token function">mongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  <span class="token comment">// Mongo 클라이언트 생성</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>위의 설정과 차이점은 MongoTemplate 빈을 선언하지 않는다.</li> <li>대신 데이터베이스 명을 제공하기 위한 getDatabaseName()을 오버라이드 한다.</li> <li>mongo()는 MongoClient를 설정한다.</li> <li>MongoDB가 다른 서버에서 동작을 한다면 다음과 같이 설정한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Mongo</span> <span class="token function">mongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodbserver&quot;</span><span class="token punctuation">,</span> <span class="token number">37017</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>MongoDB 서버가 제품 세팅으로 동작할 경우, 인증이 필요하다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">Environment</span> env<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Mongo</span> <span class="token function">mongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">MongoCredential</span> credential <span class="token operator">=</span> <span class="token class-name">MongoCredential</span><span class="token punctuation">.</span><span class="token function">createMongoCRCredential</span><span class="token punctuation">(</span>
        env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;mongo.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;OrdersDB&quot;</span><span class="token punctuation">,</span>
        env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;mongo.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">37017</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>찾아보니까 현재 <a href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/config/AbstractMongoConfiguration.html" target="_blank" rel="noopener noreferrer">AbstractMongoConfiguration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>은 deprecated 됐고, <a href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/config/AbstractMongoClientConfiguration.html" target="_blank" rel="noopener noreferrer">AbstractMongoClientConfiguration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 이거로 쓰는 듯 하다.</li></ul> <h3 id="_1-2-mongodb-퍼시스턴트를-위한-어노테이션-모델-타입"><a href="#_1-2-mongodb-퍼시스턴트를-위한-어노테이션-모델-타입" class="header-anchor">#</a> 1-2. MongoDB 퍼시스턴트를 위한 어노테이션 모델 타입</h3> <ul><li>객체 - 도큐먼트 매핑을 위한 스프링 데이터 MongoDB 어노테이션</li></ul> <table><thead><tr><th>어노테이션</th> <th>내용</th></tr></thead> <tbody><tr><td>@Document</td> <td>MongoDB 도큐먼트로 매칭될 수 있는 도메인 객체 구별</td></tr> <tr><td>@Id</td> <td>ID 필드임을 표시</td></tr> <tr><td>@DbRef</td> <td>다른 데이터베이스의 다른 도큐먼트를 참조하기 위한 필드임을 표시</td></tr> <tr><td>@Field</td> <td>도큐먼트 필드를 위한 맞춤형 메타데이터 정의</td></tr> <tr><td>@Version</td> <td>버전 필드로 사용되는 프로퍼티 구별</td></tr></tbody></table> <ul><li>@Document와 @Id 어노테이션은 JPA 의 @Entity와 @Id 어노테이션과 유사하다.</li> <li>MongoDB에 있는 Order 클래스 예시</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Document</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> customer<span class="token punctuation">;</span> <span class="token comment">// 기본 필드명 오버라이드</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> customer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>customer <span class="token operator">=</span> customer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setItems</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>items <span class="token operator">=</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Order는 @Document로 어노테이션 되며, MongoTemplate을 사용하여 지속성을 가질 수 있고, 자동으로 저장소를 생성한다.</li> <li>@ID는 도큐먼트의 ID를 나타내고, @Field로 매핑된 customer는 도큐먼트가 지속 유지될 때 field로 명명된 클라이언트로 매핑된다.</li> <li>다른 프로퍼티들은 어노테이션되지 않는다.</li> <li>프로퍼티들이 일시적인 상태로 마킹되지 않는다면, 자바 객체의 모든 필드는 도큐먼트 필드로 지속된다.</li></ul> <p><img src="/study-collection/assets/img/mongo1.0a59dfa8.png" alt="몽고1"></p> <ul><li>도큐먼트는 데이터 관계를 가지지만, 비정규화 되어있다.</li> <li>위의 그림을 보면, 그림의 순서대로 아이템 컬렉션을 갖는다.</li> <li>전형적인 관계형 데이터 세팅을 가지고, 아이템들은 외래 키로 참조된 독립 데이터베이스 테이블에서 관리되고, 아이템 필드는 @OneToMany로 JPA 어노테이션을 사용한다.</li> <li>도큐먼트는 다른 도큐먼트와 관련이 있지만, 어떤 도큐먼트 데이터 베이스가 적합한지를 알기가 어렵다.</li> <li>구매 순서와 라인 아이템 사이의 관계에서 라인 아이템들은 동일 주문 도큐먼트의 중첩된 파트에 속한다.(...)</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> orders<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Order</span> order<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> product<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> price<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> product<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProduct</span><span class="token punctuation">(</span><span class="token class-name">String</span> product<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>product <span class="token operator">=</span> product<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> price<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">double</span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> quantity<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setQuantity</span><span class="token punctuation">(</span><span class="token keyword">int</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>items는 순수한 pojo다.</li> <li>@Field 어노테이션을 사용해 도큐먼트에 어떻게 저장되는지 나타낼 수도 있긴하다.</li></ul> <h3 id="_1-3-mongotemplate을-사용하여-mongodb-액세스하기"><a href="#_1-3-mongotemplate을-사용하여-mongodb-액세스하기" class="header-anchor">#</a> 1-3. MongoTemplate을 사용하여 MongoDB 액세스하기</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MongoOperations</span> mongo<span class="token punctuation">;</span>
</code></pre></div><ul><li>이렇게 MongoOperations 타입으로 주입해준다.</li> <li>MongoOperations는 MongoDB 도큐먼트 데이터베이스를 사용하기 위한 메소드를 제공한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 주문 컬렉션으로 카운트를 하는 메소드</span>
<span class="token keyword">long</span> orderCount <span class="token operator">=</span> mongo<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 새 주문을 추가하는 메소드</span>
<span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 프로퍼티를 설정하고, 라인 아이템을 추가한다.</span>
mongo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>save()의 첫번째 파라미터는 새로 생성된 order 객체이고, 두번째는 저장해야 할 도큐먼트 저장명이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// orderId 로 찾는 메소드</span>
<span class="token class-name">String</span> orderId <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">Order</span> order <span class="token operator">=</span> mongo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> chucksOrders <span class="token operator">=</span> mongo<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&quot;Chuck Wagon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&quot;WEB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// document 삭제</span>
mongo<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-4-mongodb-저장소-작성하기"><a href="#_1-4-mongodb-저장소-작성하기" class="header-anchor">#</a> 1-4. MongoDB 저장소 작성하기.</h3> <ul><li>JPA와 비슷하게, 저장소 구현체 폼을 만들 수 있는 인터페이스를 만들면 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 스프링 데이터 MongoDB의 자동 저장소 인터페이스 구현</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderRepository</span> <span class="token keyword">extends</span> <span class="token class-name">MongoRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>OrderRepository는 MongoRepository를 확장하므로 저장소 마커 인터페이스를 확장한다.</li> <li>OrderRepository의 구현체가 런타임시에 생성되어 MongoDB 도큐먼트 데이터베이스에 읽기/쓰기를 한다.</li> <li>MongoRepository는 @Document 어노테이션된 객체타입과, @Id 가 매핑된 변수 타입을 파라미터로 받는다.</li> <li>즉 따로 OrderRepository가 자신의 메소드를 정의하지 않아도, 여러개의 메소드를 자동 상속한다.</li></ul> <table><thead><tr><th>메소드</th> <th>내용</th></tr></thead> <tbody><tr><td>long count()</td> <td>저장소 타입용 도큐먼트 카운트 반환</td></tr> <tr><td>void delete(Iterable&lt;? extends T&gt;)</td> <td>주어진 객체와 관련된 모든 모든 도큐먼트 삭제</td></tr> <tr><td>void delete(T)</td> <td>주어진 객체와 관련된 도큐먼트 삭제</td></tr> <tr><td>void delete(ID)</td> <td>ID 로 도큐먼트 삭제</td></tr> <tr><td>void deleteAll()</td> <td>주어진 저장소 타입의 모든 도큐먼트 삭제</td></tr> <tr><td>boolean exists(Object)</td> <td>주어진 객체와 관련된 도큐먼트가 존재하면 참 반환</td></tr> <tr><td>boolean exists(ID)</td> <td>주어진 ID에 대한 도큐먼트가 존재하면 참 반환</td></tr> <tr><td>List<T> findAll()</T></td> <td>저장소 타입별 모든 도큐먼트 반환</td></tr> <tr><td>List<T> findAll(Iterable<ID>)</ID></T></td> <td>주어진 도큐먼트 ID 별 모든 도큐먼트 반환</td></tr> <tr><td>List<T> findAll(Pageable)</T></td> <td>저장소 타입에 대한 페이징과 정렬된 도큐먼트 리스트 반환</td></tr> <tr><td>T findOne(ID)</td> <td>주어진 ID에 대한 단일 도큐먼트 반환</td></tr> <tr><td>&lt; S extends T &gt; Iterable&lt; S&gt; save(Iterable&lt; S &gt;)</td> <td>주어진 Iterable의 모든 도큐먼트 저장</td></tr> <tr><td>&lt; S extends T &gt; S save(S)</td> <td>주어진 객체에 대한 단일 도큐먼트 저장</td></tr></tbody></table> <h4 id="맞춤형-쿼리-메소드-추가"><a href="#맞춤형-쿼리-메소드-추가" class="header-anchor">#</a> 맞춤형 쿼리 메소드 추가</h4> <ul><li>MongoDB도 JPA와 비슷하게 명명 규칙을 사용해 맞춤형 메소드를 지원한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderRepository</span> <span class="token keyword">extends</span> <span class="token class-name">MongoRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByCustomerLike</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByCustomerAndType</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByCustomerLikeAndType</span><span class="token punctuation">(</span><span class="token class-name">Stirng</span> c<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Order에서 Customer를 찾는데, 타입이라던가, Like 같은거로 찾는다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>find 쿼리문은 get을 사용해도 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">readByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>또는 read로 바꿔도된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">countByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOrderByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Order</span> <span class="token function">findASingleOrderByCustomer</span><span class="token punctuation">(</span><span class="token class-name">String</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="쿼리-지정하기"><a href="#쿼리-지정하기" class="header-anchor">#</a> 쿼리 지정하기</h4> <ul><li>@Query사용도 가능하다</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;{'customer': 'Chuck Wagon', 'type': ?0}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findChucksOrders</span><span class="token punctuation">(</span><span class="token class-name">String</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>@Query의 json은 모든 Order 도큐먼트를 대상으로 매칭되는지 파악하며, 매칭되는 도큐먼트가 반환된다.</li> <li>type 프로퍼티는 ?0에 매핑된다. 0번째 파라미터라는 뜻</li></ul> <h4 id="맞춤형-저장소-동작의-혼합"><a href="#맞춤형-저장소-동작의-혼합" class="header-anchor">#</a> 맞춤형 저장소 동작의 혼합</h4> <ul><li>JPA와 마찬가지로 섞어 쓸 수있다. <a href="http://gwegwe1234.github.io/study-collection/book/spring-in-action/011.html#_3-3-%EB%A7%9E%EC%B6%A4%ED%98%95-%EA%B8%B0%EB%8A%A5-%ED%98%BC%ED%95%A9" target="_blank" rel="noopener noreferrer">link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>맞춤형 메소드와 맞춤형 메소드에 대한 구현 클래스를 선언하는 중간 버전의 인터페이스를 생성하고, 중간 버전의 인터페이스를 확장하기 위한 자동 저장소 인터페이스를 변경한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 중간 버전 인터페이스</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderOperations</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOrdersByType</span><span class="token punctuation">(</span><span class="token class-name">String</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 자동 저장소에 맞춤형 저장소 기능 혼합하기</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderRepositoryImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderOperations</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoOperations</span> mongo<span class="token punctuation">;</span> <span class="token comment">// MongoOperations 주입</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOrdersByType</span><span class="token punctuation">(</span><span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;NET&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;WEB&quot;</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>

        <span class="token class-name">Criteria</span> where <span class="token operator">=</span> <span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> mongo<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>믹싱 구현체는 MongoOperations가 주입된다.</li> <li>findOrdersByType() 은 MongoOperations에서 도큐먼트의 데이터베이스에 쿼리하는 쿼리를 실행한다(..)</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 중간 버전의 OrderOperations 인터페이스를 확장하기 위해 OrderRepository 변경</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderRepository</span> <span class="token keyword">extends</span> <span class="token class-name">MongoRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">OrderOperations</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>이 모든것을 엮는 것은 OrderRepositoryImpl 이라는 구현체 클래스를 통해서다.</li> <li>OrderRepository 인터페이스의 이름에 Impl이 붙는다.</li> <li>Impl이 싫으면 @EnableMongoRepositories의 repositoryImplementationPostfix를 설정한다.</li></ul> <h2 id="_2-neo4j로-그래프-데이터-사용하기"><a href="#_2-neo4j로-그래프-데이터-사용하기" class="header-anchor">#</a> 2. Neo4j로 그래프 데이터 사용하기</h2> <ul><li>그래프 데이터베이스로 도큐먼트 데이터베이스보다 더 일반적인 목적을 가지고, 관계형 데이터베이스보단 스키마가 없는 대안을 제공</li></ul> <h3 id="_2-1-스프링-데이터-neo4j-설정하기"><a href="#_2-1-스프링-데이터-neo4j-설정하기" class="header-anchor">#</a> 2-1. 스프링 데이터 Neo4j 설정하기</h3> <p><a href="https://novemberde.github.io/database/2018/04/12/Neo4j.html" target="_blank" rel="noopener noreferrer">그래프데이터베이스<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableNeo4jRepositories</span><span class="token punctuation">(</span>basePacakges<span class="token operator">=</span><span class="token string">&quot;orders.db&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 자동 저장소 활성화</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Neo4jConfig</span> <span class="token keyword">extends</span> <span class="token class-name">Neo4jConfiguration</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Neo4jConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setBasePacakge</span><span class="token punctuation">(</span><span class="token string">&quot;orders&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 모델 베이스 패키지 세팅</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">GraphDatabaseService</span> <span class="token function">graphDatabaseService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GraphDatabaseFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">newEmebeddedDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/graphdb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>@EnableNeo4jRepositories 어노테이션은 스프링 데이터 Neo4j를 활성화하여 자동 Neo4j 저장소 구현체를 생성한다.</li> <li>GraphDatabaseService 는 임베디드 Neo4j 데이터베이스를 생성하기 위해 GraphDatabaseFactory를 사용한다.</li> <li>외부 Neo4j 서버를 참조하려면 spring-data-neo4j-rest 라이브러리를 사용한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">GraphDatabaseService</span> <span class="token function">graphDatabaseService</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringRestGraphDatabase</span><span class="token punctuation">(</span>
      <span class="token string">&quot;http://graphdbserver:7474/db/data/&quot;</span><span class="token punctuation">,</span>
      env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;db.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;db.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-2-그래프-엔티티-어노테이션하기"><a href="#_2-2-그래프-엔티티-어노테이션하기" class="header-anchor">#</a> 2-2. 그래프 엔티티 어노테이션하기</h3> <ul><li>Neo4j는 두가지 엔티티를 정의한다.
<ul><li>노드 엔티티 : 어플리케이션의 요소</li> <li>관계 엔티티 : 요소들이 어떻게 관게를 가지고 있는지 나타냄</li></ul></li> <li>스프링 데이터 Neo4j는 퍼시스턴스용 도메인 타입과 필드에 적용 가능한 여러개의 어노테이션을 제공한다.</li></ul> <table><thead><tr><th>어노테이션</th> <th>내용</th></tr></thead> <tbody><tr><td>@NodeEntity</td> <td>노드 엔티티로 자바 타입 선언</td></tr> <tr><td>@RelationshipEntity</td> <td>관계 엔티티로 자바 타입 선언</td></tr> <tr><td>@StartNode</td> <td>관계 엔티티의 시작 노드로 프로퍼티 선언</td></tr> <tr><td>@EndNode</td> <td>관계 엔티티의 종단 노드로 프로퍼티 선언</td></tr> <tr><td>@Fetch</td> <td>로드된 엔티티의 프로퍼티 선언</td></tr> <tr><td>@GraphId</td> <td>엔티티의 ID 필드로 프로퍼티 선언 (필드는 Long 타입)</td></tr> <tr><td>@GraphProperty</td> <td>프로퍼티를 명시적으로 선언</td></tr> <tr><td>@GraphTraversal</td> <td>그래프를 통해 자동 반복이 가능한 프로퍼티 선언</td></tr> <tr><td>@Indexed</td> <td>인덱스화된 프로퍼티 선언</td></tr> <tr><td>@Labels</td> <td>@NodeEntity를 위한 레이블 선언</td></tr> <tr><td>@Query</td> <td>주어진 Cypher 쿼리를 실행하여 만들어진 반복이 가능한 프로퍼티 선언</td></tr> <tr><td>@QueryResult</td> <td>쿼리 결과를 보유할 수 잇는 자바 클래스 또는 인터페이스 선언</td></tr> <tr><td>@RelatedTo</td> <td>프로퍼티를 통해 @NodeEntity와 @NodeEntity 사이의 관계를 선언</td></tr> <tr><td>@RelatedToVia</td> <td>노드가 속하는 @RelationshipEntity를 참조할 때, @NodeEntity의 필드를 선언</td></tr> <tr><td>@RelationshipType</td> <td>관계 엔트리의 타입으로 필드를 선언</td></tr> <tr><td>@ResultColumn</td> <td>쿼리 결과에서 특정 필드를 캡쳐하기 위해 @QueryResult 어노테이션 된 타입의 프로퍼티를 선언</td></tr></tbody></table> <p><img src="/study-collection/assets/img/nosql1.fac37cab.jpg" alt="nosql"></p> <ul><li>두 개 노드의 간단한 관계, 자신의 프로퍼티는 가지지 않는다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NodeEntity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GraphId</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> customer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RelatedTo</span><span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">&quot;HAS_ITEMS&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 아이템의 관계</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span>item<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>items 프로퍼티는 @RelatedTo로 어노테이션 되고, Order는 Item의 Set에 관계된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NodeEntity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GraphId</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> product<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Order에서 Item은 노드로 사용되기 위해 @NodeEntity로 어노테이션 된다.</li> <li>ID 프로퍼티는 그래프 ID로 @GraphId를 사용하는 노드로 어노테이션 된다.</li> <li>product, price, quantity 프로퍼티는 그래프 데이터베이스의 노드 프로퍼티로 유지된다.</li></ul> <p><img src="/study-collection/assets/img/nosql2.f6d34e8e.jpg" alt="nosql2"></p> <ul><li>조금더 복잡한 관계 구성도.</li> <li>관계 엔티티는 자신의 프로퍼티를 가지는 관계를 나타낸다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RelationshipEntity</span><span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">&quot;HAS_LINE_ITEM_FOR&quot;</span><span class="token punctuation">)</span>	
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LineItem</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@GraphId</span>	
  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@StartNode</span>	
  <span class="token keyword">private</span> <span class="token class-name">Order</span> order<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@EndNode</span>	
  <span class="token keyword">private</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>Order는 노드로 지정되기 위해 @NodeEntity로 어노테이션 되며, LineItem은 @RelationshipEntity로 어노테이션 된다.</li> <li>LineItem은 @GraphId로 어노테이션 되는 id 프로퍼티를 가진다.</li></ul> <h3 id="_2-3-neo4jtemplate-사용하기"><a href="#_2-3-neo4jtemplate-사용하기" class="header-anchor">#</a> 2-3. Neo4jTemplate 사용하기</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">Neo4jOperations</span> neo4j<span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">Order</span> savedOrder <span class="token operator">=</span> neo4j<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>find, delete.. 등등 많다.</li> <li>특이한건 createReationshipBetween()</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">Product</span> prod <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">LineItem</span> lineItem <span class="token operator">=</span> neo4j<span class="token punctuation">.</span><span class="token function">createRelationshipBetween</span><span class="token punctuation">(</span>
    order<span class="token punctuation">,</span> prod<span class="token punctuation">,</span> <span class="token class-name">LineItem</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;HAS_LINE_ITEM_FOR&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lineItem<span class="token punctuation">.</span><span class="token function">setQuantity</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    neo4j<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-4-자동-neo4j-저장소-만들기"><a href="#_2-4-자동-neo4j-저장소-만들기" class="header-anchor">#</a> 2-4. 자동 Neo4j 저장소 만들기</h3> <ul><li>JPA / MongoDB 랑 거의 비슷하다</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">orders<span class="token punctuation">.</span>db</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> orders<span class="token punctuation">.</span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>neo4j<span class="token punctuation">.</span>repository</span><span class="token punctuation">.</span><span class="token class-name">GraphRepository</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderRepository</span> <span class="token keyword">extends</span> <span class="token class-name">GraphRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>비슷비슷.. 책보고하던가 공홈을 찾자.</li></ul> <h2 id="_3-redis에서-키-값-데이터-사용하기"><a href="#_3-redis에서-키-값-데이터-사용하기" class="header-anchor">#</a> 3. Redis에서 키-값 데이터 사용하기</h2> <h3 id="_3-1-redis에-연결하기"><a href="#_3-1-redis에-연결하기" class="header-anchor">#</a> 3-1. Redis에 연결하기</h3> <ul><li>Redis 연결 팩토리는 Redis 데이터베이스 서버 대상 연결점을 제공하낟.
<ul><li>JedisConnectionFactory</li> <li>JredisConnectionFactory</li> <li>LettuceConnectionFactory</li> <li>SrpConnectionFactory</li></ul></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
pulbic <span class="token class-name">RedisConnectionFactory</span> <span class="token function">redisCF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JedisConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>연결 팩토리의 인스턴스화를 통해 로컬호스트(6379) 로 팩토리 연결</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisConnectionFactory</span> <span class="token function">redisCF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">JedisConnectionFactory</span> cf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cf<span class="token punctuation">.</span><span class="token function">setHostName</span><span class="token punctuation">(</span><span class="token string">&quot;redis-server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cf<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">7379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>원격 호스트의 redis에 붙을때 설정해주는 법</li> <li>기타 LettuceConnectionFactory 같은 다른 팩토리를 사용해서 빈생성을 해줘도 된다.</li></ul> <h3 id="_3-2-redistemplate을-가지고-작업하기"><a href="#_3-2-redistemplate을-가지고-작업하기" class="header-anchor">#</a> 3-2 RedisTemplate을 가지고 작업하기</h3> <ul><li>Redis 연결 팩토리는 Redis 키 밸류 저장소에 대한 연결을 제공</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedisConnectionFactory</span> cf <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">RedisConnection</span> conn <span class="token operator">=</span> cf<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
conn<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;greeting&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> greetingBytes <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;greeting&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> greeting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>greetingBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>이런식으로 세팅해서 값을 가져오는게 잘 작동하지만, 바이트 배열은 불편하므로 Template을 쓰자</li> <li>다른 스프링 데이터 프로젝트와 비슷하게 스프링 데이터 Redis 템플릿을 사용해 데이터 엑세스가 가능하다
<ul><li>RedisTemplate</li> <li>StringRedisTemplate</li></ul></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedisConnectionFactory</span> cf <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> redis <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redis<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>RedisTemplate은 두 가지 타입으로 파라미터화 한다. Key &amp; Value</li> <li>Key는 String 형이고, Value는 Product 타입이다.</li> <li>String / String 으로 쓰려면 StringRedisTemplate을 쓰자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedisConnectionFactory</span> cf <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token class-name">StringRedisTemplate</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>StringRedisTemplate은 RedisConnectionFactory를 생성자에서 허용해서 따로 setConnection 할 필요는 없다.</li> <li>자주 사용되면 빈으로 등록해주자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> cf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redis<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="간단한-값을-가지고-사용하기"><a href="#간단한-값을-가지고-사용하기" class="header-anchor">#</a> 간단한 값을 가지고 사용하기</h4> <ul><li>Product를 RedisTemplate&lt;String, Product&gt;에 저장하고, 키는 &quot;123456&quot; 이라고 가정하자.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>redis<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>가져올때는</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Product</span> product <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="리스트-사용하기"><a href="#리스트-사용하기" class="header-anchor">#</a> 리스트 사용하기</h4> <ul><li>리스트 엔트리 종단에 값 추가</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>redis<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>리스트 엔트리 시작에 값 추가</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>redis<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>값을 가져올 땐 leftPop, RightPop</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Product</span> first <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftPop</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Product</span> last <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPop</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>단순한 값 추출은 range()</li> <li>range 메소드는 리스트 엔트리에서 값을 삭제할 수 없지만, 키와 인덱스 범위 값을 검색해 반환한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="set-내-동작수행"><a href="#set-내-동작수행" class="header-anchor">#</a> set 내 동작수행</h4> <ul><li>set 엔트리에 값 추가</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>합집합(Union), 교집합(Intersection), 차집합(Difference) 사용 가능</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> diff <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span><span class="token string">&quot;cart1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cart2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> union <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token string">&quot;cart1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cart2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> intersect <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token string">&quot;cart1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cart2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>삭제</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>무작위 요소 가져오기</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Product</span> random <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">randomMember</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-3-키와-값의-직렬-변환-설정"><a href="#_3-3-키와-값의-직렬-변환-설정" class="header-anchor">#</a> 3-3. 키와 값의 직렬 변환 설정</h3> <ul><li>엔트리가 Redis Key-Value 저장소에 저장될 때, 키와 값은 Redis 직렬 변환기를 사용하여 직렬화된다.</li> <li>스프링 데이터가 지원하는 직렬 변환기
<ul><li>GenericToStringSerializer : 스프링 변환 서비스를 이용한 직렬 변환</li> <li>JacksonJsonRedisSerializer : Jackson1을 이용하여 객체를 Json으로 직렬 변환</li> <li>Jakson2JsonRedisSerializer : Jackson2 이용</li> <li>JdkSerializationRedisSerializer : 자바 직렬 변환 사용</li> <li>OxmSerializer : XML 직렬 변환을 위해 스프링 O/X 매핑의 진행자 / 비진행자를 사용한 직렬 변환</li> <li>StringRedisSerializer : String 키와 값의 직렬 변환</li></ul></li> <li>RedisTemplate은 JdkSerializationRedisSerializer를 사용한다.</li> <li>다른거 쓰고싶으면 다른걸 설정하면 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span>
       <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> cf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> redis <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redis<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  redis<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redis<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/spring-in-action/011.html" class="prev">11장 객체 관계형 매핑을 통한 데이터 퍼시스팅</a></span> <span class="next"><a href="/study-collection/book/spring-in-action/013.html">13장 데이터 캐싱하기</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.eeb7b2c8.js" defer></script><script src="/study-collection/assets/js/2.47cec677.js" defer></script><script src="/study-collection/assets/js/28.681f8e9f.js" defer></script>
  </body>
</html>
