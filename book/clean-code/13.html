<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>13강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.48760978.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.e095f2ba.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.64d33ad4.js" as="script"><link rel="preload" href="/study-collection/assets/js/69.5e79a17a.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.cfeb7477.js"><link rel="prefetch" href="/study-collection/assets/js/11.a7bb7ba2.js"><link rel="prefetch" href="/study-collection/assets/js/12.822b5118.js"><link rel="prefetch" href="/study-collection/assets/js/13.eddf033e.js"><link rel="prefetch" href="/study-collection/assets/js/14.fd6eedfd.js"><link rel="prefetch" href="/study-collection/assets/js/15.8b9d6e54.js"><link rel="prefetch" href="/study-collection/assets/js/16.a1261af6.js"><link rel="prefetch" href="/study-collection/assets/js/17.7025b4fe.js"><link rel="prefetch" href="/study-collection/assets/js/18.763e3381.js"><link rel="prefetch" href="/study-collection/assets/js/19.078c1d13.js"><link rel="prefetch" href="/study-collection/assets/js/20.1915b569.js"><link rel="prefetch" href="/study-collection/assets/js/21.d921a59b.js"><link rel="prefetch" href="/study-collection/assets/js/22.cbc55aa5.js"><link rel="prefetch" href="/study-collection/assets/js/23.aa973f7a.js"><link rel="prefetch" href="/study-collection/assets/js/24.07e214f5.js"><link rel="prefetch" href="/study-collection/assets/js/25.7c0bb601.js"><link rel="prefetch" href="/study-collection/assets/js/26.633d2aa6.js"><link rel="prefetch" href="/study-collection/assets/js/27.152d612c.js"><link rel="prefetch" href="/study-collection/assets/js/28.f88d5f98.js"><link rel="prefetch" href="/study-collection/assets/js/29.8352242f.js"><link rel="prefetch" href="/study-collection/assets/js/3.6edd69e8.js"><link rel="prefetch" href="/study-collection/assets/js/30.f7d57a42.js"><link rel="prefetch" href="/study-collection/assets/js/31.935d5ac0.js"><link rel="prefetch" href="/study-collection/assets/js/32.af0b2705.js"><link rel="prefetch" href="/study-collection/assets/js/33.e5bcc7e9.js"><link rel="prefetch" href="/study-collection/assets/js/34.fcbfe40d.js"><link rel="prefetch" href="/study-collection/assets/js/35.d4cd9eaf.js"><link rel="prefetch" href="/study-collection/assets/js/36.30698b65.js"><link rel="prefetch" href="/study-collection/assets/js/37.f61dc9ca.js"><link rel="prefetch" href="/study-collection/assets/js/38.fe2678b0.js"><link rel="prefetch" href="/study-collection/assets/js/39.a8f587a4.js"><link rel="prefetch" href="/study-collection/assets/js/4.a56b00c7.js"><link rel="prefetch" href="/study-collection/assets/js/40.027acd88.js"><link rel="prefetch" href="/study-collection/assets/js/41.5601ccc1.js"><link rel="prefetch" href="/study-collection/assets/js/42.8d06592c.js"><link rel="prefetch" href="/study-collection/assets/js/43.cc5dec92.js"><link rel="prefetch" href="/study-collection/assets/js/44.626ac21a.js"><link rel="prefetch" href="/study-collection/assets/js/45.cf15b956.js"><link rel="prefetch" href="/study-collection/assets/js/46.a598a939.js"><link rel="prefetch" href="/study-collection/assets/js/47.0ea981b2.js"><link rel="prefetch" href="/study-collection/assets/js/48.ffd7a3d3.js"><link rel="prefetch" href="/study-collection/assets/js/49.06f43009.js"><link rel="prefetch" href="/study-collection/assets/js/5.8d84d72a.js"><link rel="prefetch" href="/study-collection/assets/js/50.656f589a.js"><link rel="prefetch" href="/study-collection/assets/js/51.79e10926.js"><link rel="prefetch" href="/study-collection/assets/js/52.cb2d86be.js"><link rel="prefetch" href="/study-collection/assets/js/53.ada7d112.js"><link rel="prefetch" href="/study-collection/assets/js/54.daaa21b4.js"><link rel="prefetch" href="/study-collection/assets/js/55.fb894d0e.js"><link rel="prefetch" href="/study-collection/assets/js/56.3cee08e3.js"><link rel="prefetch" href="/study-collection/assets/js/57.74abb126.js"><link rel="prefetch" href="/study-collection/assets/js/58.8d3636b1.js"><link rel="prefetch" href="/study-collection/assets/js/59.d0f9256e.js"><link rel="prefetch" href="/study-collection/assets/js/6.dc5b62b1.js"><link rel="prefetch" href="/study-collection/assets/js/60.c883123b.js"><link rel="prefetch" href="/study-collection/assets/js/61.359a5478.js"><link rel="prefetch" href="/study-collection/assets/js/62.28a925e3.js"><link rel="prefetch" href="/study-collection/assets/js/63.5c8f9435.js"><link rel="prefetch" href="/study-collection/assets/js/64.da37928d.js"><link rel="prefetch" href="/study-collection/assets/js/65.4ae4d0ac.js"><link rel="prefetch" href="/study-collection/assets/js/66.4585cec4.js"><link rel="prefetch" href="/study-collection/assets/js/67.59791af8.js"><link rel="prefetch" href="/study-collection/assets/js/68.ad5c401a.js"><link rel="prefetch" href="/study-collection/assets/js/7.9ac058e3.js"><link rel="prefetch" href="/study-collection/assets/js/70.34749a2a.js"><link rel="prefetch" href="/study-collection/assets/js/71.a1023840.js"><link rel="prefetch" href="/study-collection/assets/js/72.0dc58e0f.js"><link rel="prefetch" href="/study-collection/assets/js/73.f06a7c9a.js"><link rel="prefetch" href="/study-collection/assets/js/74.92511010.js"><link rel="prefetch" href="/study-collection/assets/js/75.efa057ac.js"><link rel="prefetch" href="/study-collection/assets/js/76.0787acb7.js"><link rel="prefetch" href="/study-collection/assets/js/77.bbfba147.js"><link rel="prefetch" href="/study-collection/assets/js/78.a3167a0b.js"><link rel="prefetch" href="/study-collection/assets/js/79.d6901390.js"><link rel="prefetch" href="/study-collection/assets/js/8.fee65fbb.js"><link rel="prefetch" href="/study-collection/assets/js/80.c64f4a94.js"><link rel="prefetch" href="/study-collection/assets/js/81.ac6358c7.js"><link rel="prefetch" href="/study-collection/assets/js/82.c8954bdd.js"><link rel="prefetch" href="/study-collection/assets/js/83.ae3c63a7.js"><link rel="prefetch" href="/study-collection/assets/js/84.d06cf404.js"><link rel="prefetch" href="/study-collection/assets/js/85.e61f92f7.js"><link rel="prefetch" href="/study-collection/assets/js/86.5201e522.js"><link rel="prefetch" href="/study-collection/assets/js/87.41dfffa3.js"><link rel="prefetch" href="/study-collection/assets/js/88.dd9b79b5.js"><link rel="prefetch" href="/study-collection/assets/js/89.39d093b0.js"><link rel="prefetch" href="/study-collection/assets/js/9.92cf100f.js"><link rel="prefetch" href="/study-collection/assets/js/90.8659c3a1.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.48760978.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>클린코드</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/clean-code/00.html" class="sidebar-link">0장 들어가면서</a></li><li><a href="/study-collection/book/clean-code/01.html" class="sidebar-link">1장 깨끗한 코드</a></li><li><a href="/study-collection/book/clean-code/02.html" class="sidebar-link">2장 의미있는 이름</a></li><li><a href="/study-collection/book/clean-code/03.html" class="sidebar-link">3장 함수</a></li><li><a href="/study-collection/book/clean-code/04.html" class="sidebar-link">4장 주석</a></li><li><a href="/study-collection/book/clean-code/05.html" class="sidebar-link">5장 포맷팅</a></li><li><a href="/study-collection/book/clean-code/06.html" class="sidebar-link">6장 객체와 자료구조</a></li><li><a href="/study-collection/book/clean-code/07.html" class="sidebar-link">7장 오류처리</a></li><li><a href="/study-collection/book/clean-code/08.html" class="sidebar-link">8장 경계</a></li><li><a href="/study-collection/book/clean-code/09.html" class="sidebar-link">9장 단위테스트</a></li><li><a href="/study-collection/book/clean-code/10.html" class="sidebar-link">10장 클래스</a></li><li><a href="/study-collection/book/clean-code/11.html" class="sidebar-link">11장 시스템</a></li><li><a href="/study-collection/book/clean-code/12.html" class="sidebar-link">12장 창발성</a></li><li><a href="/study-collection/book/clean-code/13.html" class="active sidebar-link">13장 동시성</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_13강"><a href="#_13강" class="header-anchor">#</a> 13강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#overview">Overview</a></li><li><a href="#동시성이-필요한-이유">동시성이 필요한 이유</a></li><li><a href="#미신과-오해">미신과 오해</a></li><li><a href="#동시성-구현의-난관">동시성 구현의 난관</a></li><li><a href="#동시성-방어-원칙">동시성 방어 원칙</a></li><li><a href="#라이브러리를-이해하라">라이브러리를 이해하라</a></li><li><a href="#실행-모델을-이해하라">실행 모델을 이해하라</a></li><li><a href="#동기화하는-메소드-사이에-존재하는-의존성-이해">동기화하는 메소드 사이에 존재하는 의존성 이해</a></li><li><a href="#동기화하는-부분을-작게-만들어라">동기화하는 부분을 작게 만들어라</a></li><li><a href="#올바른-종료-코드는-구현하기-어렵다">올바른 종료 코드는 구현하기 어렵다</a></li><li><a href="#스레드-코드-테스트하기">스레드 코드 테스트하기</a></li><li><a href="#결론">결론</a></li></ul></div><p></p> <h3 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h3> <div class="language-java extra-class"><pre class="language-java"><code>객체는 처리의 추상화다<span class="token punctuation">.</span> 스레드는 일정의 추상화다<span class="token punctuation">.</span>
</code></pre></div><ul><li>이 장에서는 여러 스레드를 동시에 돌리는 이유를 논한다.</li> <li>여러 스레드를 동시에 돌리는 어려움도 논한다.</li> <li>어려움을 대처하고 꺠끗한 코드를 작성하는 몇가지 방법도 제안한다.</li> <li>동시성을 테스트하는 방법과 문제점을 논한다.</li></ul> <h3 id="동시성이-필요한-이유"><a href="#동시성이-필요한-이유" class="header-anchor">#</a> 동시성이 필요한 이유</h3> <ul><li>동시성은 결합(coupling)을 없애는 전략이다.</li> <li>죽 무엇(what)과 언제(when)을 분리하는 전략이다.</li></ul> <hr> <ul><li>단일 스레드 프로그램은 무엇과 언제가 서로 밀접하다.</li> <li>이 2개를 분리하면 어플리케이션 <em>구조와 효율</em>이 극단적으로 좋아진다.
<ul><li>구조적인 관점에서 거대한 루프 하나가 아닌 작은 협력 프로그램 여럿으로 구성되는 것으로 보이고, 그로인해 문제를 분리하여 시스템을 이해하기 쉬워진다.</li></ul></li> <li>응담시간과 작업 처리량 개선에도 도움이 된다.
<ul><li>crawler같이 요청하고 오래 기다려야 하는 작업을 하는 경우, 여러 작업을 병렬적으로 해도 좋은 경우</li></ul></li></ul> <h3 id="미신과-오해"><a href="#미신과-오해" class="header-anchor">#</a> 미신과 오해</h3> <ul><li>동시성에 관한 일반적인 미신과 오해가 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>미신s

<span class="token number">1.</span> 동시성은 항상 성능을 높혀준다<span class="token punctuation">.</span>
<span class="token operator">-</span> 동시성은 때로는 성능을 높여준다<span class="token punctuation">.</span>
<span class="token operator">-</span> 대기 시간이 아주 길어 여러 스레드가 프로세서를 공유할 수 있거나<span class="token punctuation">,</span> 
여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능이 높아진다<span class="token punctuation">.</span>

<span class="token number">2.</span> 동시성을 구현해도 설계는 변하지 않는다<span class="token punctuation">.</span>
<span class="token operator">-</span> 단일 스레드 시스템과 다중 스레드 시스템은 설계가 아예 다르다<span class="token punctuation">.</span>
<span class="token operator">-</span> 일반적으로 무엇과 언제를 분리하면 시스템 구조가 크게 달라진다<span class="token punctuation">.</span>

<span class="token number">3.</span> 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다<span class="token punctuation">.</span>
<span class="token operator">-</span> 실제로는 컨테이너가 어떻게 동작하는지<span class="token punctuation">,</span> 어떻게 동시 수정<span class="token punctuation">,</span> 데드락 등과 같은 문제를 피할 수 있는지를 알아야 한다<span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>타당한 생각s

<span class="token number">1.</span> 동시성은 다소 부하를 유발한다<span class="token punctuation">.</span>
<span class="token operator">-</span> 성능 측면에서 부하가 걸리며<span class="token punctuation">,</span> 코드도 더 짜야한다<span class="token punctuation">.</span>

<span class="token number">2.</span> 동시성은 복잡하다<span class="token punctuation">.</span>
<span class="token operator">-</span> 간단한 문제라도 동시성은 복잡해진다<span class="token punctuation">.</span>

<span class="token number">3.</span> 동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다<span class="token punctuation">.</span>
</code></pre></div><h3 id="동시성-구현의-난관"><a href="#동시성-구현의-난관" class="header-anchor">#</a> 동시성 구현의 난관</h3> <ul><li>예를 들어보자</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">X</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> lastIdUsed<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span>lastIdUsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>두 쓰레드가 해당 인스턴스를 고유하면서 getnextId()를 호출한다고 가정하자.
<ul><li>43, 44를 받는다. lastIdUsed는 44가 된다.</li> <li>44, 43을 받는다. lastIdUsed는 44가 된다.</li> <li>43, 43을 받는다. lastIdUsed는 43이 된다.</li></ul></li> <li>두 스레드가 같은 변수를 참조하면 잘못된 결과를 낼 수 있는 위험한 상황이 생긴다.</li></ul> <h3 id="동시성-방어-원칙"><a href="#동시성-방어-원칙" class="header-anchor">#</a> 동시성 방어 원칙</h3> <h4 id="단일-책임-원칙-srp"><a href="#단일-책임-원칙-srp" class="header-anchor">#</a> 단일 책임 원칙 (SRP)</h4> <ul><li>동시성 관련 코드는 다른 코드와 분리해야 한다.</li> <li>동시성을 구현할 때 고려할 점
<ul><li>동시성 코드는 독자적인 개발, 변경, 조율 주기가 있다.</li> <li>동시성 코드에는 독자적인 난관이 있다. 다른 코드에서 겪는 난관과 다르며 훠얼씬 어렵다.</li> <li>잘못 구현한 동시성 코드는 별의별 방식으로 실패한다. 그냥 개어렵다.</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>동시성 코드는 다른 코드와 분리하라</p></div> <h4 id="따름-정리-corollary-자료-범위를-제한하라"><a href="#따름-정리-corollary-자료-범위를-제한하라" class="header-anchor">#</a> 따름 정리 (corollary) : 자료 범위를 제한하라</h4> <ul><li>위의 예제처럼 객체 하나를 공유한 후 동일 필드를 수정하면 두 스레드간 간섭이 발생해 문제가 발생한다.</li> <li>이런문제를 해결하는 방법으로 임계영역(critical section)을 synchronized 키워드로 보호하길 권장한다.</li> <li>이런 임계영역의 수를 줄이는 기술이 중요한데, 만약 공유 자료를 수정하는 위치가 많을수록 다음 가능성이 생긴다.
<ul><li>보호할 임계영역을 빼먹는다. 결국 수정하는 모든 코드를 망가뜨림</li> <li>모든 임계영역을 올바로 보호했는지 확인하느라 똑같은 노력과 수고를 반복한다. (<a href="https://medium.com/@duddk1551/java-dry%EC%9B%90%EC%B9%99-18abd5433b7f" target="_blank" rel="noopener noreferrer">Dry 위반<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li> <li>버그찾기가 더 어려워진다.</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>자료를 캡슐화하라. 공유 자료를 최대한 줄여라</p></div> <h4 id="따름정리-자료-사본을-사용하라"><a href="#따름정리-자료-사본을-사용하라" class="header-anchor">#</a> 따름정리 : 자료 사본을 사용하라</h4> <ul><li>공유 자료를 줄이려면 처음부터 공유하지 않는 방법이 제일 좋다.</li> <li>어떤 경우에는 객체를 복사해 읽기 전용으로 사용하는 방법이 가능하다.</li> <li>어떤 경우에는 각 스레드가 객체를 복사해 사용한 후 스레드가 해당 사본에서 결과를 가져오는 방법도 가능하다.</li> <li>이런식으로 사본생성이 시간과 부하를 잡아먹을 수도 있으니, 잘 확인해보고 정해야 한다.</li></ul> <h4 id="따름정리-스레드는-가능한-독립적으로-구현하라"><a href="#따름정리-스레드는-가능한-독립적으로-구현하라" class="header-anchor">#</a> 따름정리 : 스레드는 가능한 독립적으로 구현하라</h4> <ul><li>다른 스레드와 자료를 공유하지 않는 스레드를 구현하자.</li> <li>모든 정보는 비공유 출처에서 가져오며 로컬 변수에 저장한다.</li> <li>그러면 각 스레드는 세상에 자신만 있는 듯이 돌아갈 수 있다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>독자적인 스레드로, 가능하면 다른 프로세서에서 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라</p></div> <h3 id="라이브러리를-이해하라"><a href="#라이브러리를-이해하라" class="header-anchor">#</a> 라이브러리를 이해하라</h3> <ul><li>자바 5는 동시성 측면에서 많이 좋아졌다.
<ul><li>스레드 환경에 안전한 컬렉션을 사용한다.</li> <li>서로 무관한 작업을 수행할 때는 executor 프레임워크를 사용한다.</li> <li>가능하다면 스레드가 차단되지 않는 방법을 사용한다.</li> <li>일부 클래스 라이브러리는 스레드에 안전하지 못하다.</li></ul></li></ul> <h4 id="스레드-환경에-안전한-컬렉션"><a href="#스레드-환경에-안전한-컬렉션" class="header-anchor">#</a> 스레드 환경에 안전한 컬렉션</h4> <ul><li>java.util.concurrent 패키지에 추가된 클래스들</li> <li>해당 클래스들은 스레드 환경에서 안전하고, 성능도 좋다.
<ul><li>실제로 ConcurrentHashMap은 거의 모든상황에서 HashMap보다 빠르다.</li> <li>동시 읽기 / 쓰기를 지원하며, 자주 사용하는 복합 연산을 다중 스레드 상에서 안전하게 만든 메소드로 제공한다.</li></ul></li></ul> <table><thead><tr><th>클래스</th> <th>설명</th></tr></thead> <tbody><tr><td>ReentranLock</td> <td>한 메소드에서 잠그고 다른 메소드에서 푸는 락</td></tr> <tr><td>Semaphore</td> <td>전형적인 세마포어다. 개수(count)가 있는 락</td></tr> <tr><td>CountDownLatch</td> <td>지정한 수만큼 이벤트가 발생하고 나서야 대기중인 스레드를 모두 해제하는 락</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>언어가 제공하는 클래스를 검토하라. 자바에서는 java.util.concurrent, java.util.concurrent.atomic, java.util.concurrent.locks 를 익히자.</p></div> <h3 id="실행-모델을-이해하라"><a href="#실행-모델을-이해하라" class="header-anchor">#</a> 실행 모델을 이해하라</h3> <ul><li>아래의 표는 다중 스레드 어플리케이션을 분류하는 기본 용어</li></ul> <table><thead><tr><th>용어</th> <th>설명</th></tr></thead> <tbody><tr><td>한정된 자원 (Bound Resource)</td> <td>다중 스레드 환경에서 사용하는 자원으로, 크기나 숫자가 제한적이다. DB연결, 길이가 일정한 읽기/쓰기 버퍼 등</td></tr> <tr><td>상호 배제 (Mutual Exclusion)</td> <td>한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 있는 경우를 가르킴</td></tr> <tr><td>기아 (Starvation)</td> <td>한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원을 기다리는 상황</td></tr> <tr><td>데드락 (Deadlock)</td> <td>여러 스레드가 서로가 끝나기를 기다린다. 모든 스레드가 각기 필요한 자원을 다른 스레드가 점유하는 바람에 어느 쪽도 더 이상 진행하지 못하는 상황</td></tr> <tr><td>라이브락 (Livelock)</td> <td>락을 거는 단계에서 각 스레드가 서로를 방해한다. 스레드는 계속해서 진행하려 하지만, 공명(resonance) 으로 인해, 굉장히 오랫동안, 혹은 영원히 진행하지 못함</td></tr></tbody></table> <h4 id="생산자-소비자"><a href="#생산자-소비자" class="header-anchor">#</a> 생산자 - 소비자</h4> <ul><li>아래서 대기열은 Producer/Consumer 스레드가 함께 사용하는 한정된 자원이다.</li> <li>하나 이상의 Producer 스레드가 정보를 버퍼나 대기열에 넣는다.
<ul><li>Producer 스레드는 대기열에 빈 공간이 있을 때만 정보를 채운다.(아니면 기다림)</li> <li>정보를 채우고 Consumer 스레드에게 시그널을 보낸다.</li></ul></li> <li>하나 이상의 Consumer 스레드가 대기열에서 정보를 가져와 사용한다.
<ul><li>있을 때만 가져감. 채워질 때까지 기다림</li> <li>대기열에 빈 공간이 있을 경우 Producer 스레드에 시그널을 보낸다.</li></ul></li> <li>잘못하면 Producer/Consumer 스레드가 둘 다 진행 가능한 상태임에도 서로에게서 시그널을 기다릴 위험이 있다.</li></ul> <h4 id="읽기-쓰기"><a href="#읽기-쓰기" class="header-anchor">#</a> 읽기 - 쓰기</h4> <ul><li>읽기 스레드를 위한 주된 정보원으로 공유 자원을 사용하지만, 쓰기 쓰레드가 이 공유 자원을 이따금 갱신하는 상황을 의미한다.
<ul><li>읽는 스레드의 작업 동안 쓰는 스레드의 작업이 기다리면 정보 업데이트가 되지 않는 문제가 있다</li> <li>쓰는 스레드의 작업 동안 읽는 스레드의 작업이 기다리면 이것도 기아 현상의 위험이 있음.</li></ul></li> <li>보통은 쓰기 스레드가 읽기 스레드가 끝날 때까지 기다린다.</li></ul> <h4 id="식사하는-철학자들"><a href="#식사하는-철학자들" class="header-anchor">#</a> 식사하는 철학자들</h4> <ul><li><a href="https://ko.wikipedia.org/wiki/%EC%8B%9D%EC%82%AC%ED%95%98%EB%8A%94_%EC%B2%A0%ED%95%99%EC%9E%90%EB%93%A4_%EB%AC%B8%EC%A0%9C" target="_blank" rel="noopener noreferrer">식사하는 철학자들 설명 위키<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="동기화하는-메소드-사이에-존재하는-의존성-이해"><a href="#동기화하는-메소드-사이에-존재하는-의존성-이해" class="header-anchor">#</a> 동기화하는 메소드 사이에 존재하는 의존성 이해</h3> <ul><li>동기화하는 메소드 사이에 의존성이 생겨버리면 동시성 코드에 찾아내기 어려운 버그가 생긴다.</li> <li>자바에선 synchronized라는 개념을 제공하지만, 여러 메소드가 공유 클래스 하나에 물려있으면 확인이 필요하다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>공유 객체 하나에는 메소드 하나만 사용하라.</p></div> <h3 id="동기화하는-부분을-작게-만들어라"><a href="#동기화하는-부분을-작게-만들어라" class="header-anchor">#</a> 동기화하는 부분을 작게 만들어라</h3> <ul><li>synchronized 키워드를 사용하면 락을 설정해 같은락으로 감싼 모든 코드영역은 한 번에 한 스레드만 실행이 가능하다.</li> <li>하지만 락은 스레드를 지연시키고 부하를 가중시킨다.</li> <li>synchronized를 마구 남발하지 말고, 그렇다고 synchronized를 줄인다고 커다란 임계영역을 만들지 말자.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>동기화 하는 부분을 최대한 작게 만들어라.</p></div> <h3 id="올바른-종료-코드는-구현하기-어렵다"><a href="#올바른-종료-코드는-구현하기-어렵다" class="header-anchor">#</a> 올바른 종료 코드는 구현하기 어렵다</h3> <ul><li>데드락 때문에 구현하기가 어렵다.</li> <li>스레드가 절대 오지 않을 시그널을 기다리는 경우.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>종료 코드를 개발 초기부터 고민하고 동작하게 초기부터 구현하라. 생각보다 오래걸리낟. 생각보다 어려우므로 이미 나온 알고리즘을 검토하자.</p></div> <h3 id="스레드-코드-테스트하기"><a href="#스레드-코드-테스트하기" class="header-anchor">#</a> 스레드 코드 테스트하기</h3> <ul><li>테스트 하기가 어렵고 정확성을 보장하진 못하지만, 그럼에도 충반한 테스트는 위험을 낮춘다.</li> <li>스레드가 하나일땐 테스트하기가 그나마 쉽지만, 두개이상이 되면 겁나 헷갈려진다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>문제를 노출하는 테스트 케이스를 작성하자. 프로그램 설정과 시스템 설정과 부하를 바꿔가며 자주 돌려라. 테스트가 실패하면 원인을 추적하자. 다시 돌렸더니 통과하더라도 그냥 넘어가지 말자.</p></div> <h4 id="말이-안-되는-실패는-잠정적인-스레드-문제로-취급하라"><a href="#말이-안-되는-실패는-잠정적인-스레드-문제로-취급하라" class="header-anchor">#</a> 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라</h4> <ul><li>다중 스레드 코드는 오류를 재현하기가 매우 어렵다.</li> <li>직관적으로 어렵고, 여러가지 케이스로 에러가 날 수 있으니 단순 1회성 오류라고 치부하지 말자</li></ul> <h4 id="다중-스레드를-고려하지-않은-순차-코드부터-제대로-돌게-만들자"><a href="#다중-스레드를-고려하지-않은-순차-코드부터-제대로-돌게-만들자" class="header-anchor">#</a> 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자</h4> <ul><li>스레드 환경 밖에서 코드가 제대로 도는지 반드시 확인한다.</li> <li>스레드가 호출하는 POJO를 만든다. POJO는 스레드를 모른다. 따라서 스레드 환경밖에서 테스트가 가능하다.</li> <li>POJO에 넣는 코드는 많을수록 더 좋다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>스레드 환경 밖에서 생기는 버그와 스레드 환경에서 생기는 버그를 동시에 디버깅하지 마라. 먼저 스레드 환경 밖에서 코드를 올바로 돌려라.</p></div> <h3 id="결론"><a href="#결론" class="header-anchor">#</a> 결론</h3> <ul><li>다중 스레드 코드는 올바로 구현하기 어렵고, 공유 자료가 늘어나면서 난이도는 더욱 높아진다.</li> <li>다중 스레드 코드를 작성한다면 각별히 깨끗하게 코드를 짜야 한다. 주의하지 않으면 알 수 없는 오류에 직면할 수 있다.</li> <li>무엇보다 SRP를 준수해야 한다. 스레드를 아는 코드와 스레드를 모르는 코드를 분리한다.
<ul><li>테스트 할 때 스레드 코드를 테스트 할 때에는 스레드만 테스트한다.</li> <li>즉 스레드 코드는 최대한 집약되고 작아야 한다.</li></ul></li> <li>동시성 오류를 일으키는 잠정적인 원인을 철저히 이해해야 한다.
<ul><li>여러 스레드가 공유 자료를 조작하거나 자원 풀을 공유할 때 동시성 오류가 발생한다.</li> <li>루프 반복을 끝내거나 프로그램을 깔끔하게 종료하는 등 경계 조건의 경우 더 까다로우므로 특히 주의해야 한다.</li></ul></li> <li>사용하는 라이브러리와 기본 알고리즘을 이해한다.
<ul><li>특정 라이브러리 기능이 기본 알고리즘과 유사한 어떤 문제를 어떻게 해결하는지 파악한다.</li></ul></li> <li>보호할 코드 영역을 찾아내는 방법과 특정 코드 영역을 잠그는 방법을 이해한다. 또 공유하는 정보와 공유하지 않는 정보를 정확하게 이해한다.
<ul><li>잠글 필요가 없는 코드는 잠그지 않는다.</li> <li>잠긴 영역에서 다른 잠긴 영역을 호출하지 않는다.</li> <li>공유하는 객체 수와 버위를 최대한 줄인다.</li> <li>클라이언트에게 공유 상태를 관리하는 책임을 떠넘기지 않는다.</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/clean-code/12.html" class="prev">12장 창발성</a></span> <span class="next"><a href="/study-collection/book/spring-in-action/001.html">1장 스프링 속으로</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.e095f2ba.js" defer></script><script src="/study-collection/assets/js/2.64d33ad4.js" defer></script><script src="/study-collection/assets/js/69.5e79a17a.js" defer></script>
  </body>
</html>
