<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.d9b30d9c.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.4f5f64cd.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.5e892776.js" as="script"><link rel="preload" href="/study-collection/assets/js/11.268fb45c.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.5f5c5821.js"><link rel="prefetch" href="/study-collection/assets/js/100.79f89c7f.js"><link rel="prefetch" href="/study-collection/assets/js/101.62f2a263.js"><link rel="prefetch" href="/study-collection/assets/js/102.2a015e66.js"><link rel="prefetch" href="/study-collection/assets/js/103.9b84bea5.js"><link rel="prefetch" href="/study-collection/assets/js/104.421d6428.js"><link rel="prefetch" href="/study-collection/assets/js/105.0a132d4c.js"><link rel="prefetch" href="/study-collection/assets/js/106.e581c211.js"><link rel="prefetch" href="/study-collection/assets/js/107.1cc79a91.js"><link rel="prefetch" href="/study-collection/assets/js/108.df0beb06.js"><link rel="prefetch" href="/study-collection/assets/js/109.fe44f17c.js"><link rel="prefetch" href="/study-collection/assets/js/110.bd1c37d9.js"><link rel="prefetch" href="/study-collection/assets/js/111.3a334f3d.js"><link rel="prefetch" href="/study-collection/assets/js/112.dabde6b4.js"><link rel="prefetch" href="/study-collection/assets/js/113.15600039.js"><link rel="prefetch" href="/study-collection/assets/js/114.4fb2f335.js"><link rel="prefetch" href="/study-collection/assets/js/115.3be630ba.js"><link rel="prefetch" href="/study-collection/assets/js/116.4a4f9eac.js"><link rel="prefetch" href="/study-collection/assets/js/117.8f63d11b.js"><link rel="prefetch" href="/study-collection/assets/js/118.dd9b4805.js"><link rel="prefetch" href="/study-collection/assets/js/119.d061ae41.js"><link rel="prefetch" href="/study-collection/assets/js/12.946b7d38.js"><link rel="prefetch" href="/study-collection/assets/js/120.f14ccb7b.js"><link rel="prefetch" href="/study-collection/assets/js/121.d99d809f.js"><link rel="prefetch" href="/study-collection/assets/js/122.55d91c29.js"><link rel="prefetch" href="/study-collection/assets/js/123.86026058.js"><link rel="prefetch" href="/study-collection/assets/js/124.24ae0a19.js"><link rel="prefetch" href="/study-collection/assets/js/125.2b1d65ce.js"><link rel="prefetch" href="/study-collection/assets/js/126.2f16721a.js"><link rel="prefetch" href="/study-collection/assets/js/127.fd703755.js"><link rel="prefetch" href="/study-collection/assets/js/128.3a944092.js"><link rel="prefetch" href="/study-collection/assets/js/129.9691bffb.js"><link rel="prefetch" href="/study-collection/assets/js/13.1d6a6900.js"><link rel="prefetch" href="/study-collection/assets/js/130.3639b984.js"><link rel="prefetch" href="/study-collection/assets/js/131.828b8141.js"><link rel="prefetch" href="/study-collection/assets/js/132.b4c2f398.js"><link rel="prefetch" href="/study-collection/assets/js/133.1c17baf3.js"><link rel="prefetch" href="/study-collection/assets/js/134.6b91c316.js"><link rel="prefetch" href="/study-collection/assets/js/135.2e9884a2.js"><link rel="prefetch" href="/study-collection/assets/js/136.d7bd9b0e.js"><link rel="prefetch" href="/study-collection/assets/js/137.03b844ad.js"><link rel="prefetch" href="/study-collection/assets/js/138.c8d478de.js"><link rel="prefetch" href="/study-collection/assets/js/139.bdf6c163.js"><link rel="prefetch" href="/study-collection/assets/js/14.fe0249b2.js"><link rel="prefetch" href="/study-collection/assets/js/140.42eb003d.js"><link rel="prefetch" href="/study-collection/assets/js/141.2b72f8fb.js"><link rel="prefetch" href="/study-collection/assets/js/142.3363b327.js"><link rel="prefetch" href="/study-collection/assets/js/143.717432d8.js"><link rel="prefetch" href="/study-collection/assets/js/144.2db69140.js"><link rel="prefetch" href="/study-collection/assets/js/145.0920bb84.js"><link rel="prefetch" href="/study-collection/assets/js/146.dd2b16e9.js"><link rel="prefetch" href="/study-collection/assets/js/147.13a52162.js"><link rel="prefetch" href="/study-collection/assets/js/148.ef42dbea.js"><link rel="prefetch" href="/study-collection/assets/js/149.ebb7d715.js"><link rel="prefetch" href="/study-collection/assets/js/15.274ebfb3.js"><link rel="prefetch" href="/study-collection/assets/js/150.11fc2617.js"><link rel="prefetch" href="/study-collection/assets/js/151.f22056ba.js"><link rel="prefetch" href="/study-collection/assets/js/152.f3cfc06e.js"><link rel="prefetch" href="/study-collection/assets/js/153.a27a80b1.js"><link rel="prefetch" href="/study-collection/assets/js/154.833af25a.js"><link rel="prefetch" href="/study-collection/assets/js/155.2ef74b89.js"><link rel="prefetch" href="/study-collection/assets/js/156.ab2221c0.js"><link rel="prefetch" href="/study-collection/assets/js/16.b554b708.js"><link rel="prefetch" href="/study-collection/assets/js/17.fb29732f.js"><link rel="prefetch" href="/study-collection/assets/js/18.36b9d818.js"><link rel="prefetch" href="/study-collection/assets/js/19.39391880.js"><link rel="prefetch" href="/study-collection/assets/js/20.b7aa2612.js"><link rel="prefetch" href="/study-collection/assets/js/21.a24d9397.js"><link rel="prefetch" href="/study-collection/assets/js/22.db1a83c2.js"><link rel="prefetch" href="/study-collection/assets/js/23.db6234b3.js"><link rel="prefetch" href="/study-collection/assets/js/24.0b462536.js"><link rel="prefetch" href="/study-collection/assets/js/25.aa0fd03f.js"><link rel="prefetch" href="/study-collection/assets/js/26.2ad9b1ca.js"><link rel="prefetch" href="/study-collection/assets/js/27.fbdc549e.js"><link rel="prefetch" href="/study-collection/assets/js/28.887c1bce.js"><link rel="prefetch" href="/study-collection/assets/js/29.e3b0af97.js"><link rel="prefetch" href="/study-collection/assets/js/3.7d4df81e.js"><link rel="prefetch" href="/study-collection/assets/js/30.64f824b8.js"><link rel="prefetch" href="/study-collection/assets/js/31.2d8b7425.js"><link rel="prefetch" href="/study-collection/assets/js/32.864c4ef5.js"><link rel="prefetch" href="/study-collection/assets/js/33.ed26c461.js"><link rel="prefetch" href="/study-collection/assets/js/34.deb6597a.js"><link rel="prefetch" href="/study-collection/assets/js/35.d6a81b2e.js"><link rel="prefetch" href="/study-collection/assets/js/36.59ab6b64.js"><link rel="prefetch" href="/study-collection/assets/js/37.6550abc2.js"><link rel="prefetch" href="/study-collection/assets/js/38.b5e42513.js"><link rel="prefetch" href="/study-collection/assets/js/39.2de0197c.js"><link rel="prefetch" href="/study-collection/assets/js/4.08f2d1b0.js"><link rel="prefetch" href="/study-collection/assets/js/40.5e244a7f.js"><link rel="prefetch" href="/study-collection/assets/js/41.9a892199.js"><link rel="prefetch" href="/study-collection/assets/js/42.36d1b696.js"><link rel="prefetch" href="/study-collection/assets/js/43.00cb2d75.js"><link rel="prefetch" href="/study-collection/assets/js/44.866b3bb7.js"><link rel="prefetch" href="/study-collection/assets/js/45.a5e56880.js"><link rel="prefetch" href="/study-collection/assets/js/46.19fe51c7.js"><link rel="prefetch" href="/study-collection/assets/js/47.483b753c.js"><link rel="prefetch" href="/study-collection/assets/js/48.4f878869.js"><link rel="prefetch" href="/study-collection/assets/js/49.c8d87dc1.js"><link rel="prefetch" href="/study-collection/assets/js/5.0aa6b6fb.js"><link rel="prefetch" href="/study-collection/assets/js/50.fd8b91c1.js"><link rel="prefetch" href="/study-collection/assets/js/51.b901f3e0.js"><link rel="prefetch" href="/study-collection/assets/js/52.b433b37c.js"><link rel="prefetch" href="/study-collection/assets/js/53.256cd3d3.js"><link rel="prefetch" href="/study-collection/assets/js/54.4536ebc5.js"><link rel="prefetch" href="/study-collection/assets/js/55.8c9fc3cc.js"><link rel="prefetch" href="/study-collection/assets/js/56.16550368.js"><link rel="prefetch" href="/study-collection/assets/js/57.73c16a7d.js"><link rel="prefetch" href="/study-collection/assets/js/58.8913edfe.js"><link rel="prefetch" href="/study-collection/assets/js/59.9e8bb394.js"><link rel="prefetch" href="/study-collection/assets/js/6.c13e11f3.js"><link rel="prefetch" href="/study-collection/assets/js/60.cf3a4199.js"><link rel="prefetch" href="/study-collection/assets/js/61.5cb9025c.js"><link rel="prefetch" href="/study-collection/assets/js/62.78c69753.js"><link rel="prefetch" href="/study-collection/assets/js/63.2e8d224e.js"><link rel="prefetch" href="/study-collection/assets/js/64.61f0a8c4.js"><link rel="prefetch" href="/study-collection/assets/js/65.7c467bd7.js"><link rel="prefetch" href="/study-collection/assets/js/66.12c25cae.js"><link rel="prefetch" href="/study-collection/assets/js/67.f141029f.js"><link rel="prefetch" href="/study-collection/assets/js/68.e6fc698f.js"><link rel="prefetch" href="/study-collection/assets/js/69.09d1de11.js"><link rel="prefetch" href="/study-collection/assets/js/7.db13a9f9.js"><link rel="prefetch" href="/study-collection/assets/js/70.ec30d3ae.js"><link rel="prefetch" href="/study-collection/assets/js/71.dd4e50ba.js"><link rel="prefetch" href="/study-collection/assets/js/72.bd6ab5c8.js"><link rel="prefetch" href="/study-collection/assets/js/73.4f60cc6d.js"><link rel="prefetch" href="/study-collection/assets/js/74.1f579edf.js"><link rel="prefetch" href="/study-collection/assets/js/75.af370df4.js"><link rel="prefetch" href="/study-collection/assets/js/76.e409a605.js"><link rel="prefetch" href="/study-collection/assets/js/77.e4ab3a4f.js"><link rel="prefetch" href="/study-collection/assets/js/78.f1a78d30.js"><link rel="prefetch" href="/study-collection/assets/js/79.1a0edc83.js"><link rel="prefetch" href="/study-collection/assets/js/8.b620357c.js"><link rel="prefetch" href="/study-collection/assets/js/80.8ab76479.js"><link rel="prefetch" href="/study-collection/assets/js/81.4ae4589d.js"><link rel="prefetch" href="/study-collection/assets/js/82.a7940c2b.js"><link rel="prefetch" href="/study-collection/assets/js/83.fc044f05.js"><link rel="prefetch" href="/study-collection/assets/js/84.4d84387e.js"><link rel="prefetch" href="/study-collection/assets/js/85.6a275e91.js"><link rel="prefetch" href="/study-collection/assets/js/86.e58a1bc3.js"><link rel="prefetch" href="/study-collection/assets/js/87.f5d699f6.js"><link rel="prefetch" href="/study-collection/assets/js/88.c33a95ef.js"><link rel="prefetch" href="/study-collection/assets/js/89.25932ca0.js"><link rel="prefetch" href="/study-collection/assets/js/9.35ede549.js"><link rel="prefetch" href="/study-collection/assets/js/90.3d792880.js"><link rel="prefetch" href="/study-collection/assets/js/91.0950a526.js"><link rel="prefetch" href="/study-collection/assets/js/92.08c3a697.js"><link rel="prefetch" href="/study-collection/assets/js/93.80f72687.js"><link rel="prefetch" href="/study-collection/assets/js/94.69748e0f.js"><link rel="prefetch" href="/study-collection/assets/js/95.199ab735.js"><link rel="prefetch" href="/study-collection/assets/js/96.96d118fd.js"><link rel="prefetch" href="/study-collection/assets/js/97.b9caac65.js"><link rel="prefetch" href="/study-collection/assets/js/98.1ef00c38.js"><link rel="prefetch" href="/study-collection/assets/js/99.92514737.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.d9b30d9c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>카프카 스트림즈 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/kafka-streams-in-action/01.html" class="sidebar-link">1장 카프카 스트림즈에 오신 것을 환영합니다</a></li><li><a href="/study-collection/book/kafka-streams-in-action/02.html" class="sidebar-link">2장 빠르게 살펴보는 카프카</a></li><li><a href="/study-collection/book/kafka-streams-in-action/03.html" class="active sidebar-link">3장 카프카 스트림즈 개발</a></li><li><a href="/study-collection/book/kafka-streams-in-action/04.html" class="sidebar-link">4장 스트림과 상태</a></li><li><a href="/study-collection/book/kafka-streams-in-action/05.html" class="sidebar-link">5장 KTable API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/06.html" class="sidebar-link">6장 프로세서 API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/07.html" class="sidebar-link">7장 모니터링과 성능</a></li><li><a href="/study-collection/book/kafka-streams-in-action/08.html" class="sidebar-link">8장 카프카 스트림즈 어플리케이션 테스트</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>모던 자바 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>객체지향의 사실과 오해</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>뇌를 자극하는 윈도우즈 시스템 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링5를 활용한 리액티브 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_3강"><a href="#_3강" class="header-anchor">#</a> 3강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-스트림-프로세서-api">1. 스트림 프로세서 API</a></li><li><a href="#_2-카프카-스트림즈를-위한-hello-world">2. 카프카 스트림즈를 위한 Hello World</a><ul><li><a href="#_2-1-yelling-app의-토폴로지-생성하기">2-1. Yelling App의 토폴로지 생성하기</a></li><li><a href="#_2-2-카프카-스트림즈-설정">2-2. 카프카 스트림즈 설정</a></li><li><a href="#_2-3-serde-생성">2-3. Serde 생성</a></li></ul></li><li><a href="#_3-사용자-데이터로-작업하기">3. 사용자 데이터로 작업하기.</a><ul><li><a href="#_3-1-토폴로지-구성하기">3-1. 토폴로지 구성하기</a></li><li><a href="#_3-2-사용자-정의-serde-생성하기">3-2. 사용자 정의 Serde 생성하기</a></li></ul></li><li><a href="#_4-대화형-개발">4. 대화형 개발</a></li><li><a href="#_5-다음-단계">5. 다음 단계</a><ul><li><a href="#_5-1-새로운-요구사항">5-1. 새로운 요구사항</a></li><li><a href="#_5-2-카프카-외부에-레코드-기록하기">5-2. 카프카 외부에 레코드 기록하기</a></li></ul></li><li><a href="#요약">요약</a></li></ul></div><p></p> <h2 id="_1-스트림-프로세서-api"><a href="#_1-스트림-프로세서-api" class="header-anchor">#</a> 1. 스트림 프로세서 API</h2> <ul><li>카프카 스트림즈 DSL은 카프카 스트림즈 어플리케이션을 신속하게 만들수 있게 해주는 고수준 API.</li> <li>고수준 API의 핵심은 키/값 쌍 레코드 스트림을 나타내는 KStream 객체.</li> <li>카프카 스트림즈 DSL의 대부분의 메소드는 KStream 객체 레퍼런스를 반환해 플루언트 인터페이스 스타일의 프로그랭을 할 수 있다.</li> <li>KStream 메소드의 대부분은 단일 메소드 인터페이스로 구성된 타입을 허용해 자바 8 람다 표현식 사용이 가능.</li></ul> <h2 id="_2-카프카-스트림즈를-위한-hello-world"><a href="#_2-카프카-스트림즈를-위한-hello-world" class="header-anchor">#</a> 2. 카프카 스트림즈를 위한 Hello World</h2> <ul><li>새로운 프로그램, 들어오는 메세지를 가져와 대문자로 변환해 메세지를 읽는 사람들에게 외치는 장난감</li></ul> <p><img src="/study-collection/assets/img/ks_3_1.b472def6.jpg" alt="ks"></p> <ul><li>토폴로지는 소스 프로세서, 대문자 변경 프로세서, 싱크 프로세서로 나눠진다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 설정 항목을 정의한다<span class="token punctuation">.</span>
<span class="token number">2.</span> 사용자 정의 또는 기정의된 <span class="token class-name">Serde</span> 인스턴스를 생성한다<span class="token punctuation">.</span>
<span class="token number">3.</span> 프로세서 토폴로지를 만든다<span class="token punctuation">.</span>
<span class="token number">4.</span> <span class="token class-name">KStream</span>으 생성하고 시작한다<span class="token punctuation">.</span>
</code></pre></div><ul><li>와 같은 순서로 진행된다.</li></ul> <h3 id="_2-1-yelling-app의-토폴로지-생성하기"><a href="#_2-1-yelling-app의-토폴로지-생성하기" class="header-anchor">#</a> 2-1. Yelling App의 토폴로지 생성하기</h3> <ul><li>카프카 스트림즈 어플리케이션을 만드는 첫 번째 단계는 소스 노드를 만드는 것</li> <li>소스 노드는 어플리케이션을 통해 유입되는 레코드를 토픽에서 소비하는 역할을 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_2.bd68a9de.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> simpleFirstStream <span class="token operator">=</span> 
                builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">&quot;src-topic&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSede<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>simpleFirstStream 이라는 KStream 인스턴스는 src-topic 토픽에 저장된 메세지를 소비하도록 설정된다.</li> <li>토픽 이름 지정 외에도 카프카의 레코드를 역직렬화하기 위해 Serde 객체도 제공한다.</li> <li>카프카 스트림즈에서 소스 노드를 만들 때마다 선택 매개변수로 Consumed 클래스를 사용할 것이다.</li> <li>소스노드가 생겼으니, 데이터를 사용하려면 처리 노드를 연결해야 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_3.2d83264b.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> upperCasedStream <span class="token operator">=</span> 
                simpleFirstStream<span class="token punctuation">.</span><span class="token function">mapValue</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>KStream.mapValues 함수를 호출해서 노드의 입력값을 mapValues 호출을 통해 결괏값으로 만드는 새로운 처리 노드를 만든다.</li> <li>중요한 포인트는 mapValues에서 제공된 ValueMapper가 원래 값을 수정하면 안 된다는 점이다.</li> <li>upperCasedStream 인스턴스는 simpleFirstStream.mapValues 호출에서 초깃값의 변환된 복사본을 받는다.</li> <li>위의 경우엔 대문자 텍스트</li></ul> <p><img src="/study-collection/assets/img/ks_3_4.f3708fd0.jpg" alt="ks"></p> <ul><li>싱크 프로세서를 추가해준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>upperCasedStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;out-topic&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>KStream.to 메소드는 토폴로지에 싱크 처리 노드를 만든다.</li> <li>싱크 프로세서는 레코드를 다시 카프카로 보내준다.</li> <li>생성한 싱크노드는, upperCasedStream 프로세서에서 레코드를 가져와서 out-topic 토픽에 쓴다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>항상 Consumed 또는 Produced 객체에 Serde 객체를 제공할 필요는 없다. 그렇지 않은 경우, 어플리케이션은 설정에 나열된 직렬화기/역질렬화기를 사용한다. 또한 Consumed와 Produced클래스를 사용해 키 또는 값에 대해서만 Serde를 지정할 수 있다.</p></div> <ul><li>총 세줄의 코드로 토폴로지를 구성했는데, 좀더 깔끔하게 하면 플루언트 인터페이스 스타일의 프로그래밍을 사용할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">&quot;src-topic&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;out-topic&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-2-카프카-스트림즈-설정"><a href="#_2-2-카프카-스트림즈-설정" class="header-anchor">#</a> 2-2. 카프카 스트림즈 설정</h3> <ul><li>몇가지 속성으로 특정 요구사항 조정이 가능하다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>APPLICATION_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;yelling_app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>두개의 설정은 기본값을 제공하지 않아, 필수값이다.</li> <li>StreamsConfig.APPLICATION_ID_CONFIG는 카프카 스트림즈 어플리케이션을 식별하며 전체 클러스터에 대해 고유한 값이어야 한다.</li> <li>StreamsConfig.BOOTSTRAP_SERVERS_CONFIG는 hostname:port 쌍으로 구성되고, 여러개가 구성될 수 있다. 이 설정은 카프카 스트림즈 어플리케이션에 카프카 클러스터 위치를 알려준다.</li></ul> <h3 id="_2-3-serde-생성"><a href="#_2-3-serde-생성" class="header-anchor">#</a> 2-3. Serde 생성</h3> <ul><li>카프카 스트림즈에서 Serde 클래스는 생성 메소드를 제공해 준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringSerde <span class="token operator">=</span> <span class="token class-name">Sedes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Serde 클래스를 사용해 직렬화/역직렬화에 필요한 Serde 인스턴스를 생성하고, 토폴로지에서 반복적인 사용을 위해 Serde를 참조하는 변수를 생성한다.</li> <li>Serde 클래스는 다음과 같은 기본 구현을 제공한다.
<ul><li>String</li> <li>Byte array</li> <li>Long</li> <li>Integer</li> <li>Double</li></ul></li> <li>Serde 인터페이스 구현체는 직렬화기와 역직렬화기를 포함해, KStream 메소드에 Serde를 제공할 때마다 4개의 매개변수 (키 직렬화기, 값 직렬화기, 키 역직렬화기, 값 역직렬화기)를 지정하지 않아도 되서 유용하다.</li></ul> <hr> <ul><li>위의 소스의 전체 구성은 다음과 같다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaStreamsYellingApp</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>APPLICATION_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;yelling_app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">StreamsConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StreamsConfig</span> streamingConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsConfig</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Config 설정</span>

        <span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringSerde <span class="token operator">=</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Serde 생성</span>

        <span class="token class-name">StreamsBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 프로세서 토폴로지 구성을 위한 StreamsBuilder 생성</span>

        <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> simpleFirstStream <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">&quot;src-topic&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 소스 프로세서</span>

        <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> upperCasedStream <span class="token operator">=</span>
            simpleFirstStream<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 처리 프로세서</span>

        upperCasedStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;out-topic&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> stringSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 싱크프로세서</span>

        <span class="token class-name">KafkaStreams</span> kafkaStreams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> streamsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        kafkaStreams<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 카프카 스트림즈 쓰레드 시작</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">35000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down the Yelling APP now&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        kafkaStreams<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> <span class="token class-name">StreamsConfig</span> 인스턴스를 생성한다<span class="token punctuation">.</span>
<span class="token number">2.</span> <span class="token class-name">Serde</span> 객체를 생성한다<span class="token punctuation">.</span>
<span class="token number">3.</span> 처리 토폴로지를 구성한다<span class="token punctuation">.</span>
<span class="token number">4.</span> 카프카 스트림즈 프로그램을 시작한다<span class="token punctuation">.</span>
</code></pre></div><h2 id="_3-사용자-데이터로-작업하기"><a href="#_3-사용자-데이터로-작업하기" class="header-anchor">#</a> 3. 사용자 데이터로 작업하기.</h2> <ul><li>지마트 예제를 다시 가져온다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_5.72993b82.jpg" alt="ks"></p> <ul><li>모든 기록은 보호된 신용카드 번호를 가져야 하며, 이 경우 처음 12자리를 마스킹 해야한다.</li> <li>구매 패턴을 결정하려면 구입한 품목과 우편번호를 추출해야 한다. 이 데이터는 토픽에 기록할 것이다.</li> <li>고객의 지마트 회원 번호와 지출한 금액을 캡처해 이 정보를 토픽에 기록해야 한다. 토픽의 컨슈머는 이 데이터를 사용해 보상을 결정한다.</li> <li>전체 트랜잭션을 토픽에 기록해야 하며, 임의 분석을 위해 스토리지 엔진에서 사용한다.</li></ul> <h3 id="_3-1-토폴로지-구성하기"><a href="#_3-1-토폴로지-구성하기" class="header-anchor">#</a> 3-1. 토폴로지 구성하기</h3> <h4 id="소스-노드-만들기"><a href="#소스-노드-만들기" class="header-anchor">#</a> 소스 노드 만들기</h4> <p><img src="/study-collection/assets/img/ks_3_6.fb9bed8c.jpg" alt="ks"></p> <ul><li>소스 프로세서를 만들고, 마스킹을 처리하는 토폴로지의 첫 프로세서를 만든다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purcahse</span><span class="token punctuation">&gt;</span></span> purchaseKStrream <span class="token operator">=</span> 
                        streamBuilder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">&quot;transactions&quot;</span><span class="token punctuation">,</span> 
                        <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token class-name">Purchase</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maskCreditCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>String serde와 Purchase 객체를 사용하기 위한 사용자 정의 serde, 소스토픽 이름을 사용해 StreamsBuilder.stream 메소드를 호출한다.</li> <li>첫 번째 프로세서를 실행하기 위해 mapValues에서 람다를 통해, 마킹된 크래딧 카드 정보를 가진 Purchase 객체를 만든다.</li></ul> <h4 id="함수형-프로그래밍에-대한-힌트"><a href="#함수형-프로그래밍에-대한-힌트" class="header-anchor">#</a> 함수형 프로그래밍에 대한 힌트</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 상태 수정을 피한다<span class="token punctuation">.</span> 객체를 변경하거나<span class="token punctuation">,</span> 업데이트 할 필요가 있을 경우
   해당 객체를 함수에 전달하고 복사 또는 완전히 새로운 인스턴스를 만들고 원하는 변경을 한다<span class="token punctuation">.</span>
<span class="token number">2.</span> 여러 개의 작은 단일 용도의 함수를 함께 합성해 복잡한 작업을 구축하는 것이다<span class="token punctuation">.</span>
</code></pre></div><h4 id="두-번째-프로세서-만들기"><a href="#두-번째-프로세서-만들기" class="header-anchor">#</a> 두 번째 프로세서 만들기</h4> <ul><li>지역별 구매 패턴 결정을 위해 사용할 토픽에서 패턴 데이터를 추출하는 두 번째 프로세서를 만든다.</li> <li>카프카 토픽에 패턴 데이터를 쓰는 싱크 노드도 추가한다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_7.5633dfe8.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PurchasePattern</span><span class="token punctuation">&gt;</span></span> patternKStream <span class="token operator">=</span>
    purchaseKStream<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>purchase <span class="token operator">-&gt;</span>
    <span class="token class-name">PurchasePattern</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

patternKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;patterns&quot;</span><span class="token punctuation">,</span>
    <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>purchasePatternSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>위에서 나온 purchaseKStream 객체를 사용해 구매 패턴을 결정해 patternKStream 프로세서를 만든다.</li> <li>결과로 나오는 새로운 KStream은 patternKStream 이다.</li> <li>이후에 patterns 토픽에 쓴다.</li> <li>이전에 만든 Serde를 제공하기 위해 Produced 객체를 사용하는 점을 주의해 주면 된다.</li></ul> <h4 id="세-번째-프로세서-만들기"><a href="#세-번째-프로세서-만들기" class="header-anchor">#</a> 세 번째 프로세서 만들기</h4> <ul><li>우수 고객 회원 추적을 위한 보상 노드를 만든다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_8.833ca9ce.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RewardAccumulator</span><span class="token punctuation">&gt;</span></span> rewardsKStream <span class="token operator">=</span>
    purchaseKStream<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>purchase <span class="token operator">-&gt;</span>
    <span class="token class-name">RewardAccumulator</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rewardsKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;rewards&quot;</span><span class="token punctuation">,</span>
    <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span>rewardAccumulatorSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>위의 패턴 프로세서와 비슷하다.</li></ul> <h4 id="마지막-프로세서-만들기"><a href="#마지막-프로세서-만들기" class="header-anchor">#</a> 마지막 프로세서 만들기</h4> <ul><li>처음 생성한 KStream 인 purchasedKStream을 가져와 싱크노드로 붙여 purchase 토픽에 기록한다.</li> <li>해당 토픽은 NoSQL 저장소에 데이터를 공급해 즉시 분석을 수행하는데 사용한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>purchaseKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;purchases&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr>
- 전체 소스 구조는 다음과 같다.
<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZMartKafkaStreamsApp</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 설정 정보 등은 가독성을 위해 생략</span>

        <span class="token class-name">StreamsConfig</span> streamsConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsConfig</span><span class="token punctuation">(</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> purchaseJsonSerializer <span class="token operator">=</span> <span class="token keyword">new</span>
            <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> purchaseJsonDeserializer <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Purchase</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> purchaseSerde <span class="token operator">=</span>
            <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token function">serdeFrom</span><span class="token punctuation">(</span>purchaseJsonSerializer<span class="token punctuation">,</span> purchaseJsonDeserializer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Serde</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringSerde <span class="token operator">=</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StreamsBuilder</span> streamsBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> purchaseKStream <span class="token operator">=</span>
            streamsBuilder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">&quot;transactions&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">Consumed</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token class-name">Purchase</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maskCreditCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PurchasePattern</span><span class="token punctuation">&gt;</span></span> patternKStream <span class="token operator">=</span>
            purchaseKStream<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>purchase <span class="token operator">-&gt;</span>
                <span class="token class-name">PurchasePattern</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        patternKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;patterns&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchasePatternSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RewardAccumulator</span><span class="token punctuation">&gt;</span></span> rewardsKStream <span class="token operator">=</span>
            purchaseKStream<span class="token punctuation">.</span><span class="token function">mapValues</span><span class="token punctuation">(</span>purchase <span class="token operator">-&gt;</span>
                <span class="token class-name">RewardAccumulator</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        rewardsKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;rewards&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> rewardAccumulatorSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        purchaseKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;purchases&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaStreams</span> kafkaStreams <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">(</span>streamsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> streamsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        kafkaStreams<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> <span class="token class-name">StreamsConfig</span> 인스턴스를 생성한다<span class="token punctuation">.</span>
<span class="token number">2.</span> 하나 이상의 <span class="token class-name">Serde</span> 인스턴스를 작성한다<span class="token punctuation">.</span>
<span class="token number">3.</span> 처리 토폴로지를 구성한다<span class="token punctuation">.</span>
<span class="token number">4.</span> 모든 구성요소를 조립하고 카프카 스트림즈 프로그램을 시작한다<span class="token punctuation">.</span>
</code></pre></div><h3 id="_3-2-사용자-정의-serde-생성하기"><a href="#_3-2-사용자-정의-serde-생성하기" class="header-anchor">#</a> 3-2. 사용자 정의 Serde 생성하기</h3> <ul><li>카프카는 데이터를 바이트 배열 형시으로 전송한다.</li> <li>데이터 형식이 JSON 이기 때문에, 토픽에 데이터를 보낼 때 먼저 객체를 JSON으로 변환하고 바이트 배열로 변환하는 방법을 카프카에 알려주어야 한다.</li> <li>반대로 소비한 바이트 배열을 JSON으로 변환한 다음 프로세서에서 사용할 객체 타입으로 변환하는 방법을 명시해야 한다.</li> <li>즉 Serde는 데이터를 다른 형식으로 변환하기 위해 필요하다.</li> <li>Serde를 만들려면 Deserializer<T>와 Serializer<T> 인터페이스를 구현해야 한다.</T></T></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>직렬화의 경우 객체를 JSON으로 변환한 다음 문자열에서 바이트를 가져온다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Deserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> deserializedClass<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JsonDeserializer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> deserializedClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deserializedClass <span class="token operator">=</span> deserializedClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JsonDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deserializedClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deserializedClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;serializedClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">,</span> deserializedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-대화형-개발"><a href="#_4-대화형-개발" class="header-anchor">#</a> 4. 대화형 개발</h2> <ul><li>Printed&lt;K, V&gt; 클래스의 인스턴스를 사용하는 KStream.print 메소드를 사용해서 콘솔에서 보는 거처럼 편하게 로그를 찍어 줄 수 있다.</li> <li>Printed.toSysOut() 과 Printed.toFile(filePath) 를 사용 할 수 있다.</li> <li>withLabel() 메소드를 연결해 인쇄 결과에 레이블을 지정할 수도 있다.</li> <li>toString을 사용하고 싶지 않거나, 카프카 스트림즈에서 레코드를 인쇄하는 방법을 사용자가 정의해서 하려면, Printed.withKeyValueMapper 메소드를 사용하면 된다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>patternKStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PurchasePattern</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;patterns&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rewardsKStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RewardAccumulator</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;rewards&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

purchaseKStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;purchases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_3_9.6c01bf84.jpg" alt="ks"></p> <ul><li>print() 메소드는 터미널 노드를 생성해야 한다는 단점이 있다.</li> <li>노드를 프로세서 체인에 끼워넣을 수가 없다는 소리</li> <li>ForeachAction인스턴스를 매개변수로 사용해 새 KStream 인스턴스를 반환하는 KStream.peek 메소드도 있다.</li></ul> <h2 id="_5-다음-단계"><a href="#_5-다음-단계" class="header-anchor">#</a> 5. 다음 단계</h2> <h3 id="_5-1-새로운-요구사항"><a href="#_5-1-새로운-요구사항" class="header-anchor">#</a> 5-1. 새로운 요구사항</h3> <ul><li>동일한 소스 데이터를 쓰는 새로운 요구사항이 추가된다.
<ul><li>특정 액수 미만의 구매는 걸러낼 필요가 있다. 상위 관리자는 소량의 구매품목은 관심이 없다.</li> <li>지마트가 확장되어 전자제품 체인과 인기 있는 커피 하우스 체인을 샀다. 새 상점에서 구입한 모든 항목은 구축한 스트리밍 어플리케이션을 통해 전달된다.</li> <li>선택한 NoSQL 솔루션은 항목을 키/값 형식으로 저장한다. 카프카도 키/값 쌍을 사용하긴 하지만, 카프카 클러스터에 들어오는 레코드에는 키가 정의되어 있지 않다.</li></ul></li> <li>KStream API 를 사용하여 요구사항 충족이 가능 하다.</li></ul> <h4 id="구매-필터링"><a href="#구매-필터링" class="header-anchor">#</a> 구매 필터링</h4> <ul><li>최소 임곗값에 도달하지 못하는 구매는 걸러내야 한다.</li> <li>Kstream 인스턴스와 싱크 노드 사이에 필터 처리 노드를 삽입해 준다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_10.ab1a30cd.jpg" alt="ks"></p> <ul><li>Predicate&lt;K,V&gt; 인스턴스를 매개변수로 사용하는 KStream 메소드를 사용할 수 있다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> filteredKStream <span class="token operator">=</span>
   <span class="token function">purchaseKStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
   purchase<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">5.00</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectKey</span><span class="token punctuation">(</span>purchaseDateAsKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>구매 날짜를 키로, 5달러 미만의 구매는 필터링을 해준다.</li></ul> <h4 id="스트림-나누기"><a href="#스트림-나누기" class="header-anchor">#</a> 스트림 나누기</h4> <ul><li>구매 흐름을 다른 토픽에 쓸 수 있는 별도의 스트림으로 나누어야 한다.</li> <li>KStream.branch 메소드를 사용하면 된다.</li> <li>Kstream.branch는 임의의 수의 Predicate 인스턴스를 가져와서 KStream 인스턴스의 배열을 반환한다.</li> <li>반환된 배열의 크기는 호출에 제공된 predicate의 수와 일치한다.</li> <li>브랜치 프로세서는 주어진 predicate와 일치하지 않으면 레코드를 삭제한다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_11.066b8978.jpg" alt="ks"></p> <ul><li>위의 그림에서 브랜치 프로세서는 스트림을 2개로 나눈다.</li> <li>하나의 스트림은 카페로부터의 구매로 구성되고, 다른 스트림은 전자제품 상점에서의 구매를 포함한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> isCoffee <span class="token operator">=</span>
      <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
          purchase<span class="token punctuation">.</span><span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;coffee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
          <span class="token comment">// 자바 8 람다로 predicate 생성</span>

  <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> isElectronics <span class="token operator">=</span>
      <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
          purchase<span class="token punctuation">.</span><span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;electronics&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> coffee <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> electronics <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> kstreamByDept <span class="token operator">=</span>
      purchaseKStream<span class="token punctuation">.</span><span class="token function">branch</span><span class="token punctuation">(</span>isCoffee<span class="token punctuation">,</span> isElectronics<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 브랜치를 호춣해 2개의 스트림으로 나눈다.</span>

  kstreamByDept<span class="token punctuation">[</span>coffee<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span> <span class="token string">&quot;coffee&quot;</span><span class="token punctuation">,</span>
      <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  kstreamByDept<span class="token punctuation">[</span>electronics<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;electronics&quot;</span><span class="token punctuation">,</span>
      <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>stringSerde<span class="token punctuation">,</span> purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 각 스트림의 결과를 토픽에 쓴다.</span>
</code></pre></div><h4 id="키-생성하기"><a href="#키-생성하기" class="header-anchor">#</a> 키 생성하기</h4> <ul><li>기본적으로 키를 설정하지 않으면, 카프카 스트림즈 어플리케이션에 흐르는 모든 레코드는 null 키가 있다.</li> <li>키를 만들어야 하는 경우에 KStream.selectKey 메소드를 사용하면, 새로운 키와 동일한 값을 갖는 레코드를 만드는 KStream 인스턴스를 반환해 준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">KeyValueMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> purchaseDateAsKey <span class="token operator">=</span>
      <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> purchase<span class="token punctuation">.</span><span class="token function">getPurchaseDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// KeyValueMapper는 구매 날짜를 추출하고 Long으로 변환한다.</span>

  <span class="token class-name">KStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> filteredKStream <span class="token operator">=</span>
      <span class="token function">purchaseKStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
          purchase<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">5.00</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectKey</span><span class="token punctuation">(</span>purchaseDateAsKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 하나의 구문으로 구매를 필터링하고 키를 선택한다.</span>

  filteredKStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Printed</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span>
    <span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">&quot;purchases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  filteredKStream<span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token string">&quot;purchases&quot;</span><span class="token punctuation">,</span>
      <span class="token class-name">Produced</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>purchaseSerde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_3_12.8861a721.jpg" alt="ks"></p> <ul><li>purchases 토픽에 기록될 레코드의 키를 생성하기만 하면 되므로, 필터링 후에 키 선택 프로세서를 여기에 추가한다.</li></ul> <h3 id="_5-2-카프카-외부에-레코드-기록하기"><a href="#_5-2-카프카-외부에-레코드-기록하기" class="header-anchor">#</a> 5-2. 카프카 외부에 레코드 기록하기</h3> <ul><li>잘못된 사기정보 데이터를 토픽에 안넣고 싶어 할 경우의 예시이다.</li></ul> <h4 id="foreach-액션"><a href="#foreach-액션" class="header-anchor">#</a> Foreach 액션</h4> <ul><li>단일직원 ID로 필터링하는 새로운 KStream을 만든다.</li> <li>특정 직원 ID와 일치하는지 보는 predicate와 함께 KStream을 사용한다.</li> <li>이 필터는 이전 필터와 완전히 분리하여 소스 KStream 인스턴스에 연결할 것이다.</li></ul> <p><img src="/study-collection/assets/img/ks_3_13.f5f7e6d3.jpg" alt="ks"></p> <ul><li>Kstream.foreach 메소드를 사용한다.</li> <li>foreach 메소드는 ForeachAction&lt;K, V&gt; 인스턴스를 사용하며, 터미널 노드의 또다른 예이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ForeachAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Purchase</span><span class="token punctuation">&gt;</span></span> purchaseForeachAction <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    <span class="token class-name">SecurityDBService</span><span class="token punctuation">.</span><span class="token function">saveRecord</span><span class="token punctuation">(</span>purchase<span class="token punctuation">.</span><span class="token function">getPurchaseDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    purchase<span class="token punctuation">.</span><span class="token function">getEmployeeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> purchase<span class="token punctuation">.</span><span class="token function">getItemPurchased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

purchaseKStream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> purchase<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    purchase<span class="token punctuation">.</span><span class="token function">getEmployeeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;source code has 000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>purchaseForeachAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>ForeachAction은 자바 8 람다를 사용하고, 변수 purchaseForeachAction에 저장된다.</li></ul> <h2 id="요약"><a href="#요약" class="header-anchor">#</a> 요약</h2> <ul><li>KStream.mapValues 함수를 사용하면 들어오는 레코드값을 가능한 다른 타입의 새로운 값으로 매핑할 수 있다.</li> <li>predicate는 매개변수로 객체를 받아들이고 해당 객체가 주어진 조건과 일치하는지 여부에 따라 true 또는 false를 반환하는 구문이다.</li> <li>KStream.branch 메소드는 레코드가 주어진 predicate와 일치할 때 레코드를 새로운 스트림으로 레코드를 분할하기 위해 predicate를 사용한다.</li> <li>KStream.selectKey 메소드를 사용하면 기존 키를 수정하거나 새 키를 생성할 수 있다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/kafka-streams-in-action/02.html" class="prev">2장 빠르게 살펴보는 카프카</a></span> <span class="next"><a href="/study-collection/book/kafka-streams-in-action/04.html">4장 스트림과 상태</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.4f5f64cd.js" defer></script><script src="/study-collection/assets/js/2.5e892776.js" defer></script><script src="/study-collection/assets/js/11.268fb45c.js" defer></script>
  </body>
</html>
