<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.48760978.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.36927340.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.6514dd9e.js" as="script"><link rel="preload" href="/study-collection/assets/js/12.0c3879a3.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.b8af17bb.js"><link rel="prefetch" href="/study-collection/assets/js/100.4caa01e7.js"><link rel="prefetch" href="/study-collection/assets/js/101.90625c3d.js"><link rel="prefetch" href="/study-collection/assets/js/102.bc356fbc.js"><link rel="prefetch" href="/study-collection/assets/js/103.2f6f2008.js"><link rel="prefetch" href="/study-collection/assets/js/104.52e6f406.js"><link rel="prefetch" href="/study-collection/assets/js/11.42775f1c.js"><link rel="prefetch" href="/study-collection/assets/js/13.959ea4c3.js"><link rel="prefetch" href="/study-collection/assets/js/14.fb2cfcaf.js"><link rel="prefetch" href="/study-collection/assets/js/15.ba584a8a.js"><link rel="prefetch" href="/study-collection/assets/js/16.92b1ea26.js"><link rel="prefetch" href="/study-collection/assets/js/17.766508bc.js"><link rel="prefetch" href="/study-collection/assets/js/18.54ea3c22.js"><link rel="prefetch" href="/study-collection/assets/js/19.d38313f3.js"><link rel="prefetch" href="/study-collection/assets/js/20.dc4cea15.js"><link rel="prefetch" href="/study-collection/assets/js/21.1beb5e74.js"><link rel="prefetch" href="/study-collection/assets/js/22.26e1c155.js"><link rel="prefetch" href="/study-collection/assets/js/23.72c60d95.js"><link rel="prefetch" href="/study-collection/assets/js/24.ef2fa385.js"><link rel="prefetch" href="/study-collection/assets/js/25.922240ac.js"><link rel="prefetch" href="/study-collection/assets/js/26.72c0df9b.js"><link rel="prefetch" href="/study-collection/assets/js/27.4cb18a53.js"><link rel="prefetch" href="/study-collection/assets/js/28.d6b5a9e6.js"><link rel="prefetch" href="/study-collection/assets/js/29.b3ee8769.js"><link rel="prefetch" href="/study-collection/assets/js/3.2752d77d.js"><link rel="prefetch" href="/study-collection/assets/js/30.41658a58.js"><link rel="prefetch" href="/study-collection/assets/js/31.f06f0585.js"><link rel="prefetch" href="/study-collection/assets/js/32.92cdf704.js"><link rel="prefetch" href="/study-collection/assets/js/33.da020d5a.js"><link rel="prefetch" href="/study-collection/assets/js/34.f66170e6.js"><link rel="prefetch" href="/study-collection/assets/js/35.ec2379ba.js"><link rel="prefetch" href="/study-collection/assets/js/36.0335ac3d.js"><link rel="prefetch" href="/study-collection/assets/js/37.6434c9cc.js"><link rel="prefetch" href="/study-collection/assets/js/38.6eda2d35.js"><link rel="prefetch" href="/study-collection/assets/js/39.e271d871.js"><link rel="prefetch" href="/study-collection/assets/js/4.26c5429f.js"><link rel="prefetch" href="/study-collection/assets/js/40.c27237c9.js"><link rel="prefetch" href="/study-collection/assets/js/41.99b96679.js"><link rel="prefetch" href="/study-collection/assets/js/42.4c4d880e.js"><link rel="prefetch" href="/study-collection/assets/js/43.4526c514.js"><link rel="prefetch" href="/study-collection/assets/js/44.f091496d.js"><link rel="prefetch" href="/study-collection/assets/js/45.5ca75fbd.js"><link rel="prefetch" href="/study-collection/assets/js/46.deb17d87.js"><link rel="prefetch" href="/study-collection/assets/js/47.a8451709.js"><link rel="prefetch" href="/study-collection/assets/js/48.4bd0fbb0.js"><link rel="prefetch" href="/study-collection/assets/js/49.550358e3.js"><link rel="prefetch" href="/study-collection/assets/js/5.431418f2.js"><link rel="prefetch" href="/study-collection/assets/js/50.1d35e35b.js"><link rel="prefetch" href="/study-collection/assets/js/51.5145cae0.js"><link rel="prefetch" href="/study-collection/assets/js/52.86985db8.js"><link rel="prefetch" href="/study-collection/assets/js/53.2c25e6d4.js"><link rel="prefetch" href="/study-collection/assets/js/54.844d6a0d.js"><link rel="prefetch" href="/study-collection/assets/js/55.c31fd464.js"><link rel="prefetch" href="/study-collection/assets/js/56.2f99b5aa.js"><link rel="prefetch" href="/study-collection/assets/js/57.cfbb9ea7.js"><link rel="prefetch" href="/study-collection/assets/js/58.6960cde5.js"><link rel="prefetch" href="/study-collection/assets/js/59.ef6a3f12.js"><link rel="prefetch" href="/study-collection/assets/js/6.7a0ebd0b.js"><link rel="prefetch" href="/study-collection/assets/js/60.e0d5cda9.js"><link rel="prefetch" href="/study-collection/assets/js/61.a28e44c2.js"><link rel="prefetch" href="/study-collection/assets/js/62.7dffaf9e.js"><link rel="prefetch" href="/study-collection/assets/js/63.f94cc3d8.js"><link rel="prefetch" href="/study-collection/assets/js/64.4b71a51d.js"><link rel="prefetch" href="/study-collection/assets/js/65.2e5c0a0c.js"><link rel="prefetch" href="/study-collection/assets/js/66.2a910e0b.js"><link rel="prefetch" href="/study-collection/assets/js/67.81ed2dfa.js"><link rel="prefetch" href="/study-collection/assets/js/68.d0cf5b82.js"><link rel="prefetch" href="/study-collection/assets/js/69.dea57c7c.js"><link rel="prefetch" href="/study-collection/assets/js/7.0d78114a.js"><link rel="prefetch" href="/study-collection/assets/js/70.ce6a0938.js"><link rel="prefetch" href="/study-collection/assets/js/71.8c4d70f1.js"><link rel="prefetch" href="/study-collection/assets/js/72.2b349519.js"><link rel="prefetch" href="/study-collection/assets/js/73.0242250d.js"><link rel="prefetch" href="/study-collection/assets/js/74.3d6dff7a.js"><link rel="prefetch" href="/study-collection/assets/js/75.1432d76a.js"><link rel="prefetch" href="/study-collection/assets/js/76.6f933542.js"><link rel="prefetch" href="/study-collection/assets/js/77.b1fbe58e.js"><link rel="prefetch" href="/study-collection/assets/js/78.d53008f4.js"><link rel="prefetch" href="/study-collection/assets/js/79.e01e9fb6.js"><link rel="prefetch" href="/study-collection/assets/js/8.afd50715.js"><link rel="prefetch" href="/study-collection/assets/js/80.46e5c5b3.js"><link rel="prefetch" href="/study-collection/assets/js/81.2aa855ce.js"><link rel="prefetch" href="/study-collection/assets/js/82.cbdf36c6.js"><link rel="prefetch" href="/study-collection/assets/js/83.d8859094.js"><link rel="prefetch" href="/study-collection/assets/js/84.c241247a.js"><link rel="prefetch" href="/study-collection/assets/js/85.a325c4ac.js"><link rel="prefetch" href="/study-collection/assets/js/86.4ced47d9.js"><link rel="prefetch" href="/study-collection/assets/js/87.7fcb9c70.js"><link rel="prefetch" href="/study-collection/assets/js/88.a5d0ae96.js"><link rel="prefetch" href="/study-collection/assets/js/89.7128a4a4.js"><link rel="prefetch" href="/study-collection/assets/js/9.7cdc9dc7.js"><link rel="prefetch" href="/study-collection/assets/js/90.70019536.js"><link rel="prefetch" href="/study-collection/assets/js/91.df175d97.js"><link rel="prefetch" href="/study-collection/assets/js/92.2f6018dc.js"><link rel="prefetch" href="/study-collection/assets/js/93.613f83a3.js"><link rel="prefetch" href="/study-collection/assets/js/94.d709d04a.js"><link rel="prefetch" href="/study-collection/assets/js/95.eb00e217.js"><link rel="prefetch" href="/study-collection/assets/js/96.1ead2398.js"><link rel="prefetch" href="/study-collection/assets/js/97.5ba256c8.js"><link rel="prefetch" href="/study-collection/assets/js/98.bb7662c7.js"><link rel="prefetch" href="/study-collection/assets/js/99.4e738b20.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.48760978.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>고 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>카프카 스트림즈 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/kafka-streams-in-action/01.html" class="sidebar-link">1장 카프카 스트림즈에 오신 것을 환영합니다</a></li><li><a href="/study-collection/book/kafka-streams-in-action/02.html" class="sidebar-link">2장 빠르게 살펴보는 카프카</a></li><li><a href="/study-collection/book/kafka-streams-in-action/03.html" class="sidebar-link">3장 카프카 스트림즈 개발</a></li><li><a href="/study-collection/book/kafka-streams-in-action/04.html" class="sidebar-link">4장 스트림과 상태</a></li><li><a href="/study-collection/book/kafka-streams-in-action/05.html" class="sidebar-link">5장 KTable API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/06.html" class="active sidebar-link">6장 프로세서 API</a></li><li><a href="/study-collection/book/kafka-streams-in-action/07.html" class="sidebar-link">7장 모니터링과 성능</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6강"><a href="#_6강" class="header-anchor">#</a> 6강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-더-높은-수준의-추상화와-더-많은-제어-사이의-트레이드-오프">1. 더 높은 수준의 추상화와 더 많은 제어 사이의 트레이드 오프</a></li><li><a href="#_2-토폴로지를-만들기-위해-소스-프로세서-싱크와-함께-작업하기">2. 토폴로지를 만들기 위해 소스, 프로세서, 싱크와 함께 작업하기</a><ul><li><a href="#_2-1-소스-노드-추가">2-1. 소스 노드 추가</a></li><li><a href="#_2-2-프로세서-노드-추가">2-2. 프로세서 노드 추가</a></li><li><a href="#_2-3-싱크-노드-추가">2-3. 싱크 노드 추가</a></li></ul></li><li><a href="#_3-주식-분석-프로세서로-프로세서-api-자세히-살펴보기">3. 주식 분석 프로세서로 프로세서 API 자세히 살펴보기</a><ul><li><a href="#_3-1-주식-성과-프로세서-어플리케이션">3-1. 주식 성과 프로세서 어플리케이션</a></li><li><a href="#_3-2-process-메소드">3-2. process() 메소드</a></li><li><a href="#_3-3-펑추에이터-실행">3-3. 펑추에이터 실행</a></li></ul></li><li><a href="#_4-코그룹-프로세서">4. 코그룹 프로세서</a><ul><li><a href="#_4-1-코그룹-프로세서-작성">4-1. 코그룹 프로세서 작성</a></li><li><a href="#_5-프로세서-api와-카프카-스트림즈-api-통합하기">5. 프로세서 API와 카프카 스트림즈 API 통합하기</a></li></ul></li><li><a href="#요약">요약</a></li></ul></div><p></p> <h2 id="_1-더-높은-수준의-추상화와-더-많은-제어-사이의-트레이드-오프"><a href="#_1-더-높은-수준의-추상화와-더-많은-제어-사이의-트레이드-오프" class="header-anchor">#</a> 1. 더 높은 수준의 추상화와 더 많은 제어 사이의 트레이드 오프</h2> <ul><li>아래와 같은 상황을 다루기 위해 프로세서 API의 사용 방법을 배운다.
<ul><li>일정한 간격(레코드 타임스탬프나 벽 시간)으로 액션을 스케줄링</li> <li>레코드가 다운스트림에 전송될 때 완벽하게 제어</li> <li>특정 자식 노드에 레코드 전달</li> <li>카프카 스트림즈 API에 없는 기능 구현</li></ul></li></ul> <h2 id="_2-토폴로지를-만들기-위해-소스-프로세서-싱크와-함께-작업하기"><a href="#_2-토폴로지를-만들기-위해-소스-프로세서-싱크와-함께-작업하기" class="header-anchor">#</a> 2. 토폴로지를 만들기 위해 소스, 프로세서, 싱크와 함께 작업하기</h2> <ul><li>맥주를 파는 회사에서 주문이 국내인지, 해외인지 판단해서 처리해야하는 토폴로지가 있다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_1.c1f252f9.jpg" alt="ks"></p> <ul><li>위의 예시로 프로세서 API를 사용해 유연하게 하위노드를 선택하는지 확인을 해본다.</li></ul> <h3 id="_2-1-소스-노드-추가"><a href="#_2-1-소스-노드-추가" class="header-anchor">#</a> 2-1. 소스 노드 추가</h3> <div class="language-java extra-class"><pre class="language-java"><code>topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">,</span> <span class="token comment">// 사용할 오프셋 리셋을 지정</span>
                  purchaseSourceNodeName<span class="token punctuation">,</span> <span class="token comment">// 노드 이름 지정</span>
                  <span class="token keyword">new</span> <span class="token class-name">UsePreviousTimeOnInvalidTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TimestampExtractor 명시</span>
                  stringDeserializer<span class="token punctuation">,</span> <span class="token comment">// 키 역직렬화기 지정</span>
                  beerPurchaseDeserializer<span class="token punctuation">,</span> <span class="token comment">// 값 역직렬화기 지정</span>
                  <span class="token class-name">Topics</span><span class="token punctuation">.</span>POPS_HOPS_PURCHASES<span class="token punctuation">.</span><span class="token function">topicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 데이터를 소비할 토픽 이름 지정</span>
</code></pre></div><ul><li>Topology.addSource() 메소드에는 DSL에서 사용하지 않았던 몇몇 매개변수가 존재한다.</li> <li>소스 노드 이름을 지정해 명시하고, 노드 이름은 자식노드를 부모 노드에 묶기 위해 사용한다.</li> <li>TimestampExtractor를 지정해주어야 한다.</li> <li>특이한 점으로 키,값 역직렬화기를 설정해 주느데, DSL과는 달리 소스 노드를 만들때는 역 직렬화기를, 싱크 노드를 만들때는 직렬화기를 사용해야 한다.</li></ul> <h3 id="_2-2-프로세서-노드-추가"><a href="#_2-2-프로세서-노드-추가" class="header-anchor">#</a> 2-2. 프로세서 노드 추가</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">BeerPurchaseProcessor</span> beerProcessor <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">BeerPurchaseProcessor</span><span class="token punctuation">(</span>domesticSalesSink<span class="token punctuation">,</span> internationalSalesSink<span class="token punctuation">)</span><span class="token punctuation">;</span>

topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">,</span>
                  purchaseSourceNodeName<span class="token punctuation">,</span>
                  <span class="token keyword">new</span> <span class="token class-name">UsePreviousTimeOnInvalidTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  stringDeserializer<span class="token punctuation">,</span>
                  beerPurchaseDeserializer<span class="token punctuation">,</span>
                  <span class="token class-name">Topics</span><span class="token punctuation">.</span>POPS_HOPS_PURCHASES<span class="token punctuation">.</span><span class="token function">topicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span>purchaseProcessor<span class="token punctuation">,</span> <span class="token comment">// 프로세서 노드 이름</span>
                     <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> beerProcessor<span class="token punctuation">,</span> <span class="token comment">// 위에서 정의한 프로세서를 추가</span>
                     purchaseSourceNodeName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 부모 노드 또는 복수의 부모 노드 이름을 지정</span>
</code></pre></div><ul><li>위의 토폴로지를 구축하기 위해 플루언트 인터페이스 패턴을 사용한다.</li> <li>KStream나 KTable 인스턴스를 반환하는 KStream 메소드의 카프카 스트림즈 API와는 다르게, 프로세서 API에서 토폴로지에 대한 각각의 호출은 같은 토폴로지 인스턴스를 반환한다.</li> <li>두 번째 매개변수는 ProcessorSupplier 인터페이스의 인스턴스이다.</li> <li>세 번째 매개변수는 purchaseSourceNodeName인데, addProcessor() 메소드는 addSource() 메소드의 두 번째 매개변수와 같다.</li> <li>이렇게 부모-자식 관계를 설정한다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_2.04fb5c4f.jpg" alt="ks"></p> <p><img src="/study-collection/assets/img/ks_6_3.909df57b.jpg" alt="ks"></p> <ul><li>위의 예제에서 만든 BeerPurchaseProcessor은 2개의 역할을 담당한다.
<ul><li>해외 판매 총액을 유로화에서 달러화로 변환한다.</li> <li>국내 또는 해외의 판매 원가 기준으로 적절한 싱크 노드에 레코드를 전달한다.</li></ul></li> <li>이런 모든 작업은 process()에서 처리한다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 통화 유형을 확인한다<span class="token punctuation">.</span> 달러화가 아니라면 달러화로 환산한다<span class="token punctuation">.</span>
<span class="token number">2.</span> 국내 판매가 아니라면 업데이트된 레코드를 해외 판매 토픽에 전달한다<span class="token punctuation">.</span>
<span class="token number">3.</span> 그렇지 않다면<span class="token punctuation">,</span> 이 레코드를 국내 판매 토픽에 바로 전달한다<span class="token punctuation">.</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeerPurchaseProcessor</span> <span class="token keyword">extends</span>
 <span class="token class-name">AbstractProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeerPurchase</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> domesticSalesNode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> internationalSalesNode<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BeerPurchaseProcessor</span><span class="token punctuation">(</span><span class="token class-name">String</span> domesticSalesNode<span class="token punctuation">,</span>
                                 <span class="token class-name">String</span> internationalSalesNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>domesticSalesNode <span class="token operator">=</span> domesticSalesNode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>internationalSalesNode <span class="token operator">=</span> internationalSalesNode<span class="token punctuation">;</span> <span class="token comment">// 레코드가 전달될 각 노드 이름을 설정</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">BeerPurchase</span> beerPurchase<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 실제 액션이 실행될 process() 메소드</span>

        <span class="token class-name">Currency</span> transactionCurrency <span class="token operator">=</span> beerPurchase<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCurrency <span class="token operator">!=</span> DOLLARS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BeerPurchase</span> dollarBeerPurchase<span class="token punctuation">;</span>
            <span class="token class-name">BeerPurchase</span><span class="token punctuation">.</span><span class="token class-name">Builder</span> builder <span class="token operator">=</span>
                <span class="token class-name">BeerPurchase</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span>beerPurchase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">double</span> internationalSaleAmount <span class="token operator">=</span> beerPurchase<span class="token punctuation">.</span><span class="token function">getTotalSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> pattern <span class="token operator">=</span> <span class="token string">&quot;###.##&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">DecimalFormat</span> decimalFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">currency</span><span class="token punctuation">(</span>DOLLARS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">totalSale</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>decimalFormat
                <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>transactionCurrency
                <span class="token punctuation">.</span><span class="token function">convertToDollars</span><span class="token punctuation">(</span>internationalSaleAmount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 해외 판매액을 달러화로 환산</span>
            dollarBeerPurchase <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dollarBeerPurchase<span class="token punctuation">,</span> internationalSalesNode<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// context() 메소드가 반환하는 ProcessorContext를 사용해 레코드를 international 자식 노드에 전달</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> beerPurchase<span class="token punctuation">,</span> domesticSalesNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 국내 판매 레코드를 domestic 자식 노드로 전달</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>위의 예제는 Processor 인터페이스 메소드를 오버로드한 클래스인 AbstractProcessor를 process() 메소드만 제외하고 상속한다.</li> <li>Processor.process()는 토폴로지를 통해 흐르는 레코드에 대한 액션을 수행하는 메소드다.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Processor 인터페이스는 init(), process(), punctuate(), close() 메소드를 제공한다. 이 Processor는 스트리밍 어플리케이션에서 레코드로 작업하는 어플리케이션 로직의 핵심이다.</p></div> <ul><li>context() 메소드는 특정 자식 노드에 레코드를 전달하는 기능이 있다.</li></ul> <h3 id="_2-3-싱크-노드-추가"><a href="#_2-3-싱크-노드-추가" class="header-anchor">#</a> 2-3. 싱크 노드 추가</h3> <p><img src="/study-collection/assets/img/ks_6_4.29bfb2cb.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code>topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>LATEST<span class="token punctuation">,</span>
                  purchaseSourceNodeName<span class="token punctuation">,</span>
                  <span class="token keyword">new</span> <span class="token class-name">UsePreviousTimeOnInvalidTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  stringDeserializer<span class="token punctuation">,</span>
                  beerPurchaseDeserializer<span class="token punctuation">,</span>
                  <span class="token class-name">Topics</span><span class="token punctuation">.</span>POPS_HOPS_PURCHASES<span class="token punctuation">.</span><span class="token function">topicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span>purchaseProcessor<span class="token punctuation">,</span>
                     <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> beerProcessor<span class="token punctuation">,</span>
                     purchaseSourceNodeName<span class="token punctuation">)</span>

       <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>internationalSalesSink<span class="token punctuation">,</span> <span class="token comment">// 싱크 이름</span>
                <span class="token string">&quot;international-sales&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 이 싱크가 제공하는 토픽</span>
                stringSerializer<span class="token punctuation">,</span>      <span class="token comment">// 키에 대한 직렬화기</span>
                beerPurchaseSerializer<span class="token punctuation">,</span> <span class="token comment">// 값에 대한 직렬화기</span>
                purchaseProcessor<span class="token punctuation">)</span> <span class="token comment">// 이 싱크의 부모 노드</span>

       <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>domesticSalesSink<span class="token punctuation">,</span> 
                <span class="token string">&quot;domestic-sales&quot;</span><span class="token punctuation">,</span>
                stringSerializer<span class="token punctuation">,</span>
                beerPurchaseSerializer<span class="token punctuation">,</span>
                purchaseProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>두 개의 싱크노드를 추가해 주었다.</li> <li>두 개의 싱크노드를 추가하면, 부모노드는 무조건 동일하다.</li></ul> <h2 id="_3-주식-분석-프로세서로-프로세서-api-자세히-살펴보기"><a href="#_3-주식-분석-프로세서로-프로세서-api-자세히-살펴보기" class="header-anchor">#</a> 3. 주식 분석 프로세서로 프로세서 API 자세히 살펴보기</h2> <ul><li>데이 트레이딩을 살펴본다.</li> <li>데이 트레이더로서 최적의 매매 시점을 선택할 목적으로 주가가 어떻게 변하는지 분석하기를 원한다.</li> <li>즉, 시장 변동을 이용해 단가 수익을 만드는 것이 주목적</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 이 주식의 현재 가치 조회
<span class="token number">2.</span> 주식 가치가 상승<span class="token punctuation">,</span> 하강 추세인지 표시
<span class="token number">3.</span> 지금까지 총 주식 거래량과 상승<span class="token punctuation">,</span> 하강 추세 여부 포함
<span class="token number">4.</span> 추세 변동이 <span class="token number">2</span><span class="token operator">%</span>인 주식만 레코드를 다운스트림에 전송
<span class="token number">5.</span> 계산하기 전에 주식의 최소 샘플 <span class="token number">20</span>개를 수집
</code></pre></div><p><img src="/study-collection/assets/img/ks_6_5.b8867985.jpg" alt="ks"></p> <h3 id="_3-1-주식-성과-프로세서-어플리케이션"><a href="#_3-1-주식-성과-프로세서-어플리케이션" class="header-anchor">#</a> 3-1. 주식 성과 프로세서 어플리케이션</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Topology</span> topology <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Topology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">String</span> stocksStateStore <span class="token operator">=</span> <span class="token string">&quot;stock-performance-store&quot;</span><span class="token punctuation">;</span>
 <span class="token keyword">double</span> differentialThreshold <span class="token operator">=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>

<span class="token class-name">KeyValueBytesStoreSupplier</span> storeSupplier <span class="token operator">=</span>
 <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">inMemoryKeyValueStore</span><span class="token punctuation">(</span>stocksStateStore<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 인메모리 키/값 상태 저장소 생성</span>
<span class="token class-name">StoreBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockPerformance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> storeBuilder
 <span class="token operator">=</span> <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">keyValueStoreBuilder</span><span class="token punctuation">(</span>storeSupplier<span class="token punctuation">,</span> <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockPerformanceSerde<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 토폴로지에 추가할 StoreBuilder 생성</span>

  topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token string">&quot;stocks-source&quot;</span><span class="token punctuation">,</span>
                    stringDeserializer<span class="token punctuation">,</span>
                    stockTransactionDeserializer<span class="token punctuation">,</span>
                    <span class="token string">&quot;stock-transactions&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;stocks-processor&quot;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">StockPerformanceProcessor</span><span class="token punctuation">(</span>
                        stocksStateStore<span class="token punctuation">,</span> differentialThreshold<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;stocks-source&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addStateStore</span><span class="token punctuation">(</span>storeBuilder<span class="token punctuation">,</span><span class="token string">&quot;stocks-processor&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 프로세서에 상태 저장소 추가</span>
          <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token string">&quot;stocks-sink&quot;</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;stock-performance&quot;</span><span class="token punctuation">,</span>
                   stringSerializer<span class="token punctuation">,</span>
                   stockPerformanceSerializer<span class="token punctuation">,</span>
                   <span class="token string">&quot;stocks-processor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>이전 예제와 다르게 상태저장소를 사용해야하고, 레코드를 받을 때마다 넘겨주는게 아닌, 전송할 레코드의 스케쥴링이 필요해 init() 메소드 설정이 필요하다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> processorContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>processorContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// AbstractProcessor 슈퍼 클래스를 통해 ProcessorContext 초기화</span>
  keyValueStore <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">)</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStateStore</span><span class="token punctuation">(</span>stateStoreName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 토폴로지 구축 시 생성된 상태 저장소 조회</span>
  <span class="token class-name">StockPerformancePunctuator</span> punctuator <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">StockPerformancePunctuator</span><span class="token punctuation">(</span>differentialThreshold<span class="token punctuation">,</span>
                                <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                keyValueStore<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 스케줄링된 프로세싱을 처리하기 위한 Punctuator 초기화</span>
  <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token class-name">PunctuationType</span><span class="token punctuation">.</span>WALL_CLOCK_TIME<span class="token punctuation">,</span> punctuator<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 10초마다 Punctuator.punctuate()를 호출하도록 스케줄링</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Punctuator는 예약한 프로세서 로직을 실행을 처리하는 콜백 인터페이스이다.</li> <li>위의 예시는 WALL_CLOCK_TIME에 기반해서 호출하도록 명시해 준다.</li></ul> <h4 id="펑추에이션-시맨틱"><a href="#펑추에이션-시맨틱" class="header-anchor">#</a> 펑추에이션 시맨틱</h4> <ul><li>STREAM_TIME 스케줄을 결정하는 방식은 다음과 같다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> <span class="token class-name">StreamTask</span>는 가장 작은 타임스탬프를 <span class="token class-name">PartitionGroup</span>에서 가져온다<span class="token punctuation">.</span> 이 <span class="token class-name">PartitionGroup</span>은
주어진 <span class="token class-name">StreamThread</span>를 위한 파티션의 집합이고<span class="token punctuation">,</span> 이 그룹의 모든 파티션은 타임스탬프 정보를 갖고있다<span class="token punctuation">.</span>

<span class="token number">2.</span> 레코드를 처리하는 동안<span class="token punctuation">,</span> 이 <span class="token class-name">StreamThread</span>는 <span class="token class-name">StreamTask</span> 객체를 반복하고 각 태스크는 펑추에이션을
사용할 수 있는 개별 프로세서를 위해 punctuate 메소드를 호출한다<span class="token punctuation">.</span> 개별 주식의 성과를 조사하기 전에 최소
<span class="token number">20</span>건의 거래를 수집한다<span class="token punctuation">.</span>

<span class="token number">3.</span> 최근 실행한 <span class="token function">puctuate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 메소드의 타임스탬프<span class="token punctuation">(</span>쓰케줄 시간을 더한 타임스탬프<span class="token punctuation">)</span>가 <span class="token class-name">PartitionGroup</span>에서 
가져온 타임스탬프보다 작거나 같다면<span class="token punctuation">,</span> 카프카 스트림즈는 프로세서의 <span class="token function">punctuate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 메소드를 호출한다<span class="token punctuation">.</span>
</code></pre></div><ul><li>여기에서 핵심은 어플리케이션이 TimestampExtractor를 통해 타임스탬프를 증가시킨다는 것인데, 그래서 일정 주기로 데이터가 도달만 한다면 일관되게 punctuate()를 호출한다.</li> <li>PunctuationType.WALL_CLOCK_TIME에서 Punctuator.punctuate 실행은 벽 시간을 사용하기 때문에 더욱더 예측이 가능하다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_6.421d2ac0.jpg" alt="ks"></p> <ul><li>어떠한 방법을 사용할 건지는 전적으로 요구사항에 달려 있다.</li> <li>정기적으로 수행되는 활동이 필요하다면 데이터 흐름에 무관하게 시스템 시간을 사용하는것이 좋다.</li> <li>유입 데이터에서만 연산을 처리하고 실행 중 지연 시간을 허용할 수 있다면 스트림 시간 시맨틱이 좋다.</li></ul> <h3 id="_3-2-process-메소드"><a href="#_3-2-process-메소드" class="header-anchor">#</a> 3-2. process() 메소드</h3> <ul><li>process() 메소드는 주식 성과를 평가하는 모든 계산을 처리할 것이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 레코드가 주식 종목 코드에 관한 <span class="token class-name">StockPerformance</span> 객체와 관련이 있는지 상태 저장소를 확인한다<span class="token punctuation">.</span>

<span class="token number">2.</span> 이 저장소에 <span class="token class-name">StockPerformance</span> 객체가 없다면 생성한다<span class="token punctuation">.</span> 그런 다음<span class="token punctuation">,</span> <span class="token class-name">StockPerformance</span> 
인스턴스는 주식 가겨과 거래량을 추가하고 계산을 업데이트한다<span class="token punctuation">.</span>

<span class="token number">3.</span> <span class="token number">20</span>회 이상 거래가 있는 주식은 계산을 시작한다<span class="token punctuation">.</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_6_7.4082ba06.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> symbol<span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StockPerformance</span> stockPerformance <span class="token operator">=</span> keyValueStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stockPerformance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stockPerformance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stockPerformance<span class="token punctuation">.</span><span class="token function">updatePriceStats</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span><span class="token function">getSharePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 가격 통계 업데이트</span>
    stockPerformance<span class="token punctuation">.</span><span class="token function">updateVolumeStats</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span><span class="token function">getShares</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 주식 거래량 통계 업데이트</span>
    stockPerformance<span class="token punctuation">.</span><span class="token function">setLastUpdateSent</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 최근 업데이트한 타임스탬프 설정</span>

    keyValueStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> stockPerformance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 상태저장소에 저장</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>최종 결과는 상태 저장소에 저장하고 전달할 레코드는 Punctuator.punctuate 메소드에 남긴다.</li></ul> <h3 id="_3-3-펑추에이터-실행"><a href="#_3-3-펑추에이터-실행" class="header-anchor">#</a> 3-3. 펑추에이터 실행</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">punctuate</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">KeyValueIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockPerformance</span><span class="token punctuation">&gt;</span></span> performanceIterator <span class="token operator">=</span>
    keyValueStore<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>performanceIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">KeyValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockPerformance</span><span class="token punctuation">&gt;</span></span> keyValue <span class="token operator">=</span>
        performanceIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyValue<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token class-name">StockPerformance</span> stockPerformance <span class="token operator">=</span> keyValue<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stockPerformance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stockPerformance<span class="token punctuation">.</span><span class="token function">priceDifferential</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> differentialThreshold <span class="token operator">||</span>
                stockPerformance<span class="token punctuation">.</span><span class="token function">volumeDifferential</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> differentialThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> stockPerformance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 임곗값에 도달했거나 초과했다면, 이 레코드를 전달.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Punctuator.punctuate 메소드에 있는 절차는 단순하다.</li> <li>상태 저장소에 있는 키/값 쌍을 반복 조회해서, 이 값이 미리 정의해둔 임곗값을 넘어가면 이 레코드를 다운스트림에 전달한다.</li> <li>기억해야할 개념은, 커밋이나 캐시 플러시의 조합을 사용해 레코드를 전달하기 전에 레코드 전달 시기를 사전에 정의할 수 있다는 점이다.</li> <li>이 코드를 10초마다 실행한다고 해도 레코드를 내보낼 수 있다고 보장하지 않는다.</li> <li>또한 punctuate와 process 메소드가 동시에 실행은 불가능하다.</li></ul> <h2 id="_4-코그룹-프로세서"><a href="#_4-코그룹-프로세서" class="header-anchor">#</a> 4. 코그룹 프로세서</h2> <ul><li>조인을 하면, 스트림 A에서 스트림 B로의 레코드 매핑은 암묵적인 1:1 매핑이다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_8.fbed86ec.jpg" alt="ks"></p> <ul><li>이제는 1:1 조인 대신 공통 키로 조인한 2개의 데이터 컬렉션인 데이터의 코그룹으로 비슷한 유형의 분석을 할고 한다.</li> <li>주식 종목 코드를 클릭하는 이벤트와, 사용자의 주식 구매 사이의 연관관계를 분석하려고 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_9.f21b7921.jpg" alt="ks"></p> <ul><li>N초마다 주어진 회사에 대해 클릭 이벤트와 주식 거래 내역의 스냅샷을 결헙하는 것이 목적이지만, 두 스트림에 레코드가 도착하기를 기다리지는 않는다.</li> <li>지정된 시간이 지나면 종목 코드에 대해 클릭 이벤트와 주식 거래 내역을 co-grouping(공틍 그룹화) 해야한다.</li> <li></li></ul> <h3 id="_4-1-코그룹-프로세서-작성"><a href="#_4-1-코그룹-프로세서-작성" class="header-anchor">#</a> 4-1. 코그룹 프로세서 작성</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1.</span> 토픽 <span class="token number">2</span>개<span class="token punctuation">(</span>주식 거래 내역<span class="token punctuation">,</span> 이벤트<span class="token punctuation">)</span>를 정의한다<span class="token punctuation">.</span>

<span class="token number">2.</span> 토픽에서 레코드를 소비하는 프로세서 <span class="token number">2</span>개를 추가한다<span class="token punctuation">.</span>

<span class="token number">3.</span> <span class="token number">2</span>개의 선행 프로세서를 집계하고 고통 그룹 역할을 하는 세 번째 프로세서를 추가한다<span class="token punctuation">.</span>

<span class="token number">4.</span> 두 이벤트 상태를 유지하는 집계 프로세서에 상태 저장소를 추가한다<span class="token punctuation">.</span>

<span class="token number">5.</span> 결과를 기록하는 싱크 노드를 추가한다<span class="token punctuation">.</span>
</code></pre></div><h4 id="소스-노드-정의"><a href="#소스-노드-정의" class="header-anchor">#</a> 소스 노드 정의</h4> <div class="language-java extra-class"><pre class="language-java"><code>topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token string">&quot;Txn-Source&quot;</span><span class="token punctuation">,</span>
                  stringDeserializer<span class="token punctuation">,</span>
                  stockTransactionDeserializer<span class="token punctuation">,</span>
                  <span class="token string">&quot;stock-transactions&quot;</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token string">&quot;Events-Source&quot;</span><span class="token punctuation">,</span>
                  stringDeserializer<span class="token punctuation">,</span>
                  clickEventDeserializer<span class="token punctuation">,</span>
                  <span class="token string">&quot;eventsㅏ&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_6_10.47750840.jpg" alt="ks"></p> <h4 id="프로세서-노드-추가"><a href="#프로세서-노드-추가" class="header-anchor">#</a> 프로세서 노드 추가</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;Txn-Processor&quot;</span><span class="token punctuation">,</span>
              <span class="token class-name">StockTransactionProcessor</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span>
              <span class="token string">&quot;Txn-Source&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;Events-Processor&quot;</span><span class="token punctuation">,</span>
              <span class="token class-name">ClickEventProcessor</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span>
              <span class="token string">&quot;Events-Source&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;CoGrouping-Processor&quot;</span><span class="token punctuation">,</span>
              <span class="token class-name">CogroupingProcessor</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span>
              <span class="token string">&quot;Txn-Processor&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;Events-Processor&quot;</span><span class="token punctuation">)</span> <span class="token comment">//  두 프로세서의 자식 노드에 있는 CogroupingProcessor 추가</span>
</code></pre></div><p><img src="/study-collection/assets/img/ks_6_11.4b59ec1d.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockTransactionProcessor</span> <span class="token keyword">extends</span>
 <span class="token class-name">AbstractProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Tuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> tuple <span class="token operator">=</span>
                <span class="token class-name">Tuple</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// StockTransaction이 있는 객체 집게를 생성</span>
            <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 튜플을 CogroupingProcessor에 전달</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClickEventProcessor</span> <span class="token keyword">extends</span>
 <span class="token class-name">AbstractProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">ClickEvent</span> clickEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Tuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> tuple <span class="token operator">=</span>
                <span class="token class-name">Tuple</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>clickEvent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 초기 애그리게이터 객체에 ClickEvent 추가</span>
            <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>코 그루핑 프로세서를 정의해 준다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CogroupingProcessor</span> <span class="token keyword">extends</span>
 <span class="token class-name">AbstractProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">,</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">KeyValueStore</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span>
        <span class="token class-name">Tuple</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tupleStore<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span>  <span class="token class-name">String</span> TUPLE_STORE_NAME <span class="token operator">=</span> <span class="token string">&quot;tupleCoGroupStore&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ProcessorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tupleStore <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">)</span>
            <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStateStore</span><span class="token punctuation">(</span>TUPLE_STORE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CogroupingPunctuator</span> punctuator <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">CogroupingPunctuator</span><span class="token punctuation">(</span>tupleStore<span class="token punctuation">,</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token number">15000L</span><span class="token punctuation">,</span> STREAM_TIME<span class="token punctuation">,</span> punctuator<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>init() 메소드는 클래스 설정의 세부사항을 처리한다.</li> <li>CogroupingProcessor가 process() 메소드에서 주 태스크 중 하나를 수행하는 소스이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span>
 <span class="token class-name">Tuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Tuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> cogroupedTuple
            <span class="token operator">=</span> tupleStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cogroupedTuple <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             cogroupedTuple <span class="token operator">=</span>
            <span class="token class-name">Tuple</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>_1 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cogroupedTuple<span class="token punctuation">.</span>_1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>_2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cogroupedTuple<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        tupleStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cogroupedTuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>전체 코그룹에서 들어오는 부분 집계를 처리할 때, 첫 단꼐는 상태저장소에 이미 인스턴스가 있는지 확인한다.</li> <li>없다면 빈 clickEvent와 StockTransaction 컬렉션을 가진 Tuple을 생성한다.</li> <li>들어오는 부분집계를 확인해서 ClickEvent나 StockTransaction 둘 중 하나가 있다면 이를 전체 집계에 추가한다.</li> <li>process() 메소드에서 마지막 단계는 Tuple을 상태 저장소에 다시 넣고 전체 집계를 업데이트 하는 것이다.</li> <li>아래는 펑츄에이션이 처리되는 방식이다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">punctuate</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">KeyValueIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> tupleStore<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 상태저장소에서 코그룹 이터레이터를 얻는다.</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">KeyValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        cogrouping <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 다음 코그룹 조회</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cogrouping<span class="token punctuation">.</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
         <span class="token punctuation">(</span><span class="token operator">!</span>cogrouping<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_1<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
         <span class="token operator">!</span>cogrouping<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span></span> clickEvents <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cogrouping<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 코그룹 컬렉션의 방어적 복사본을 만든다.</span>
          <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span></span> stockTransactions <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cogrouping<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

          context<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>cogrouping<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
            <span class="token class-name">Tuple</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>clickEvents<span class="token punctuation">,</span> stockTransactions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 키와 집게된 코그룹을 전달한다.</span>
          cogrouped<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_1<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          cogrouped<span class="token punctuation">.</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          tupleStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cogrouped<span class="token punctuation">.</span>key<span class="token punctuation">,</span> cogrouped<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 정리한 튜플을 상태 저장소에 다시 넣는다.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    iterator<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>각 punctuate 호출 중에 KeyValueIterator에 저장된 모든 레코드를 검색하고, 이터레이터에 포함된 개별 코그룹 결과를 추출하기 시작한다.</li> <li>그런 다음 이 컬렉션의 방어적 복사본을 만들고 새 코그룹 Tuple을 만들어 다운스트림에 전달한다.</li> <li>이후에 현재 코그룹 결과는 삭제하고 상태 저장소에 이 튜플을 다시 저장하고 도착하는 다음 레코드를 기다린다.</li></ul> <h4 id="상태-저장소-추가"><a href="#상태-저장소-추가" class="header-anchor">#</a> 상태 저장소 추가</h4> <ul><li>카프카 스트리밍 어플리케이션에서 집계를 수행하려면 상태가 있어야 한다.</li> <li>CogroupingProcessor가 정상적으로 기능하기 위해선 상태 저장소를 추가해야 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_12.0943c0fa.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changeLogConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;retention.ms&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;120000&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 changeLogConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cleanup.policy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compact,delete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token class-name">KeyValueBytesStoreSupplier</span> storeSupplier <span class="token operator">=</span>
 <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">persistentKeyValueStore</span><span class="token punctuation">(</span>TUPLE_STORE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 영구 저장소(록스 DB)를 위한 저장소 서플라이어를 생성한다.</span>
        <span class="token class-name">StoreBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeyValueStore</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span>
 <span class="token class-name">Tuple</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ClickEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StockTransaction</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> storeBuilder <span class="token operator">=</span> <span class="token comment">// 저장소 빌더를 생성한다.</span>
                <span class="token class-name">Stores</span><span class="token punctuation">.</span><span class="token function">keyValueStoreBuilder</span><span class="token punctuation">(</span>storeSupplier<span class="token punctuation">,</span>
                        <span class="token class-name">Serdes</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        eventPerformanceTuple<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">withLoggingEnabled</span><span class="token punctuation">(</span>changeLogConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 저장소 빌더에 변경로그 구성을 추가한다.</span>

<span class="token punctuation">.</span><span class="token function">addStateStore</span><span class="token punctuation">(</span>storeBuilder<span class="token punctuation">,</span> <span class="token string">&quot;CoGrouping-Processor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 저장소에 접근할 프로세서 이름으로 토폴로지에 저장소를 추가한다.</span>
</code></pre></div><h4 id="싱크-노드-추가"><a href="#싱크-노드-추가" class="header-anchor">#</a> 싱크 노드 추가</h4> <ul><li>코그룹 토폴로지를 사용하려면, 데이터를 토픽에 써야 한다.</li></ul> <p><img src="/study-collection/assets/img/ks_6_13.cc2529ec.jpg" alt="ks"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token string">&quot;Tuple-Sink&quot;</span><span class="token punctuation">,</span>
         <span class="token string">&quot;cogrouped-results&quot;</span><span class="token punctuation">,</span>
          stringSerializer<span class="token punctuation">,</span>
          tupleSerializer<span class="token punctuation">,</span>
          <span class="token string">&quot;CoGrouping-Processor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 topology<span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;Print&quot;</span><span class="token punctuation">,</span>
                       <span class="token keyword">new</span> <span class="token class-name">KStreamPrinter</span><span class="token punctuation">(</span><span class="token string">&quot;Co-Grouping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token string">&quot;CoGrouping-Processor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-프로세서-api와-카프카-스트림즈-api-통합하기"><a href="#_5-프로세서-api와-카프카-스트림즈-api-통합하기" class="header-anchor">#</a> 5. 프로세서 API와 카프카 스트림즈 API 통합하기</h3> <ul><li>KStream 방식을 더 선호할 수 있지만, 저수준 제어를 위해 KStream 어플리케이션에 프로세서 API를 적용시킬 수 있다.</li> <li>카프카 스트림즈 API는 프로세서 API를 사용해 작성한 기능(KStream.process, KStream.transform, KStream.transformValues)을 결합할 수 있는 세 가지 방법을 제공한다.</li></ul> <h2 id="요약"><a href="#요약" class="header-anchor">#</a> 요약</h2> <ul><li>프로세서 API는 더 많은 코드 비용으로 더 높은 유연성을 제공한다.</li> <li>프로세서 API가 카프카 스트림즈 API보다 더 상세하지만, 여전히 카프카 스트림즈 API가 사용하기 쉽고, 카프카 스트림즈 API 자체가 내부적으로는 프로세서 API를 사용한다.</li> <li>사용할 API를 결정해야 할 때, 카프카 스트림즈 API를 사용하고 필요할 때 저수준 메소드 통합을 고려해 볼 수 있다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/kafka-streams-in-action/05.html" class="prev">5장 KTable API</a></span> <span class="next"><a href="/study-collection/book/kafka-streams-in-action/07.html">7장 모니터링과 성능</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.36927340.js" defer></script><script src="/study-collection/assets/js/2.6514dd9e.js" defer></script><script src="/study-collection/assets/js/12.0c3879a3.js" defer></script>
  </body>
</html>
