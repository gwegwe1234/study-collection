<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6강 | 끄적끄적 블로그</title>
    <meta name="description" content="개발 관련 블로그">
    <link rel="icon" href="/study-collection/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/study-collection/assets/css/0.styles.d9b30d9c.css" as="style"><link rel="preload" href="/study-collection/assets/js/app.981bd393.js" as="script"><link rel="preload" href="/study-collection/assets/js/2.79894b7f.js" as="script"><link rel="preload" href="/study-collection/assets/js/22.ad8f3b49.js" as="script"><link rel="prefetch" href="/study-collection/assets/js/10.c73d92b8.js"><link rel="prefetch" href="/study-collection/assets/js/100.a8265bad.js"><link rel="prefetch" href="/study-collection/assets/js/101.d481cdb7.js"><link rel="prefetch" href="/study-collection/assets/js/102.e052d43f.js"><link rel="prefetch" href="/study-collection/assets/js/103.aeecd6ed.js"><link rel="prefetch" href="/study-collection/assets/js/104.0d1c6f65.js"><link rel="prefetch" href="/study-collection/assets/js/105.0094a763.js"><link rel="prefetch" href="/study-collection/assets/js/106.339b5627.js"><link rel="prefetch" href="/study-collection/assets/js/107.e2180b07.js"><link rel="prefetch" href="/study-collection/assets/js/108.f33dca19.js"><link rel="prefetch" href="/study-collection/assets/js/109.cdad27d9.js"><link rel="prefetch" href="/study-collection/assets/js/11.cc59fcbe.js"><link rel="prefetch" href="/study-collection/assets/js/110.9774985d.js"><link rel="prefetch" href="/study-collection/assets/js/111.4a69c0e2.js"><link rel="prefetch" href="/study-collection/assets/js/112.3156d15f.js"><link rel="prefetch" href="/study-collection/assets/js/113.b3d9a30d.js"><link rel="prefetch" href="/study-collection/assets/js/114.6fd9b3e5.js"><link rel="prefetch" href="/study-collection/assets/js/115.31f7d2af.js"><link rel="prefetch" href="/study-collection/assets/js/116.14649872.js"><link rel="prefetch" href="/study-collection/assets/js/117.7ff753c4.js"><link rel="prefetch" href="/study-collection/assets/js/118.b71e52c4.js"><link rel="prefetch" href="/study-collection/assets/js/119.f68e91a6.js"><link rel="prefetch" href="/study-collection/assets/js/12.bfdc1eb0.js"><link rel="prefetch" href="/study-collection/assets/js/120.39de9258.js"><link rel="prefetch" href="/study-collection/assets/js/121.1973d20b.js"><link rel="prefetch" href="/study-collection/assets/js/122.d705b34a.js"><link rel="prefetch" href="/study-collection/assets/js/123.b362028a.js"><link rel="prefetch" href="/study-collection/assets/js/124.28924a5e.js"><link rel="prefetch" href="/study-collection/assets/js/125.3b49dfb5.js"><link rel="prefetch" href="/study-collection/assets/js/126.2a4fd106.js"><link rel="prefetch" href="/study-collection/assets/js/127.ae3c3339.js"><link rel="prefetch" href="/study-collection/assets/js/128.4880dac7.js"><link rel="prefetch" href="/study-collection/assets/js/129.cd5f4129.js"><link rel="prefetch" href="/study-collection/assets/js/13.6762bccc.js"><link rel="prefetch" href="/study-collection/assets/js/130.42ce478f.js"><link rel="prefetch" href="/study-collection/assets/js/131.6d21232e.js"><link rel="prefetch" href="/study-collection/assets/js/132.3db1fc5e.js"><link rel="prefetch" href="/study-collection/assets/js/133.78b300cd.js"><link rel="prefetch" href="/study-collection/assets/js/134.0e4af772.js"><link rel="prefetch" href="/study-collection/assets/js/135.084bea09.js"><link rel="prefetch" href="/study-collection/assets/js/136.5ad97a9a.js"><link rel="prefetch" href="/study-collection/assets/js/137.662c172f.js"><link rel="prefetch" href="/study-collection/assets/js/138.6d9f89db.js"><link rel="prefetch" href="/study-collection/assets/js/139.602315cc.js"><link rel="prefetch" href="/study-collection/assets/js/14.0cd5a3bf.js"><link rel="prefetch" href="/study-collection/assets/js/140.321d99c7.js"><link rel="prefetch" href="/study-collection/assets/js/141.bc8d5989.js"><link rel="prefetch" href="/study-collection/assets/js/142.611df089.js"><link rel="prefetch" href="/study-collection/assets/js/143.f164cd42.js"><link rel="prefetch" href="/study-collection/assets/js/144.5156f496.js"><link rel="prefetch" href="/study-collection/assets/js/145.5fc4663e.js"><link rel="prefetch" href="/study-collection/assets/js/146.0244acbe.js"><link rel="prefetch" href="/study-collection/assets/js/15.49d4c83a.js"><link rel="prefetch" href="/study-collection/assets/js/16.fd753616.js"><link rel="prefetch" href="/study-collection/assets/js/17.43bfa1bc.js"><link rel="prefetch" href="/study-collection/assets/js/18.7dc37fc1.js"><link rel="prefetch" href="/study-collection/assets/js/19.14a943fb.js"><link rel="prefetch" href="/study-collection/assets/js/20.1387b6bd.js"><link rel="prefetch" href="/study-collection/assets/js/21.22bda805.js"><link rel="prefetch" href="/study-collection/assets/js/23.b1b3193c.js"><link rel="prefetch" href="/study-collection/assets/js/24.d920fd24.js"><link rel="prefetch" href="/study-collection/assets/js/25.c254f946.js"><link rel="prefetch" href="/study-collection/assets/js/26.c5ce7e12.js"><link rel="prefetch" href="/study-collection/assets/js/27.186d2a3b.js"><link rel="prefetch" href="/study-collection/assets/js/28.afc675cd.js"><link rel="prefetch" href="/study-collection/assets/js/29.a0e03780.js"><link rel="prefetch" href="/study-collection/assets/js/3.6e6bc789.js"><link rel="prefetch" href="/study-collection/assets/js/30.d36d5acb.js"><link rel="prefetch" href="/study-collection/assets/js/31.74836063.js"><link rel="prefetch" href="/study-collection/assets/js/32.46ae03e8.js"><link rel="prefetch" href="/study-collection/assets/js/33.a82661d4.js"><link rel="prefetch" href="/study-collection/assets/js/34.cc024d2e.js"><link rel="prefetch" href="/study-collection/assets/js/35.1389d4a3.js"><link rel="prefetch" href="/study-collection/assets/js/36.1095b590.js"><link rel="prefetch" href="/study-collection/assets/js/37.5746a77e.js"><link rel="prefetch" href="/study-collection/assets/js/38.17d6c4e4.js"><link rel="prefetch" href="/study-collection/assets/js/39.25d83cb2.js"><link rel="prefetch" href="/study-collection/assets/js/4.18f8f2a5.js"><link rel="prefetch" href="/study-collection/assets/js/40.dbc0981f.js"><link rel="prefetch" href="/study-collection/assets/js/41.05251889.js"><link rel="prefetch" href="/study-collection/assets/js/42.ca8ed9e2.js"><link rel="prefetch" href="/study-collection/assets/js/43.73b9b492.js"><link rel="prefetch" href="/study-collection/assets/js/44.335b0fd5.js"><link rel="prefetch" href="/study-collection/assets/js/45.7e028493.js"><link rel="prefetch" href="/study-collection/assets/js/46.8667e296.js"><link rel="prefetch" href="/study-collection/assets/js/47.2c8e20cd.js"><link rel="prefetch" href="/study-collection/assets/js/48.606f7e1f.js"><link rel="prefetch" href="/study-collection/assets/js/49.afb6d934.js"><link rel="prefetch" href="/study-collection/assets/js/5.b1c236d5.js"><link rel="prefetch" href="/study-collection/assets/js/50.eabeeec9.js"><link rel="prefetch" href="/study-collection/assets/js/51.1f89a618.js"><link rel="prefetch" href="/study-collection/assets/js/52.32d0fe5a.js"><link rel="prefetch" href="/study-collection/assets/js/53.225ae96e.js"><link rel="prefetch" href="/study-collection/assets/js/54.e3aae24b.js"><link rel="prefetch" href="/study-collection/assets/js/55.8b6b8c10.js"><link rel="prefetch" href="/study-collection/assets/js/56.8ced7da1.js"><link rel="prefetch" href="/study-collection/assets/js/57.bd6f09b6.js"><link rel="prefetch" href="/study-collection/assets/js/58.3697fea3.js"><link rel="prefetch" href="/study-collection/assets/js/59.8801b72d.js"><link rel="prefetch" href="/study-collection/assets/js/6.9f56a452.js"><link rel="prefetch" href="/study-collection/assets/js/60.132e2a58.js"><link rel="prefetch" href="/study-collection/assets/js/61.f3404c4c.js"><link rel="prefetch" href="/study-collection/assets/js/62.dc48201f.js"><link rel="prefetch" href="/study-collection/assets/js/63.8491f5ad.js"><link rel="prefetch" href="/study-collection/assets/js/64.448a5957.js"><link rel="prefetch" href="/study-collection/assets/js/65.e24e26d9.js"><link rel="prefetch" href="/study-collection/assets/js/66.10c23f6e.js"><link rel="prefetch" href="/study-collection/assets/js/67.69f465af.js"><link rel="prefetch" href="/study-collection/assets/js/68.01923e32.js"><link rel="prefetch" href="/study-collection/assets/js/69.ded51dfa.js"><link rel="prefetch" href="/study-collection/assets/js/7.f93bb652.js"><link rel="prefetch" href="/study-collection/assets/js/70.634d4a27.js"><link rel="prefetch" href="/study-collection/assets/js/71.c7c10fc5.js"><link rel="prefetch" href="/study-collection/assets/js/72.4500fd9c.js"><link rel="prefetch" href="/study-collection/assets/js/73.c3787d5a.js"><link rel="prefetch" href="/study-collection/assets/js/74.aa880acc.js"><link rel="prefetch" href="/study-collection/assets/js/75.28a0a22c.js"><link rel="prefetch" href="/study-collection/assets/js/76.e9c38824.js"><link rel="prefetch" href="/study-collection/assets/js/77.5de8a236.js"><link rel="prefetch" href="/study-collection/assets/js/78.c1a0390b.js"><link rel="prefetch" href="/study-collection/assets/js/79.a6b8a641.js"><link rel="prefetch" href="/study-collection/assets/js/8.4ef5bb13.js"><link rel="prefetch" href="/study-collection/assets/js/80.6d7d236a.js"><link rel="prefetch" href="/study-collection/assets/js/81.0621b3a4.js"><link rel="prefetch" href="/study-collection/assets/js/82.54a6bb56.js"><link rel="prefetch" href="/study-collection/assets/js/83.581d54eb.js"><link rel="prefetch" href="/study-collection/assets/js/84.55e56a3c.js"><link rel="prefetch" href="/study-collection/assets/js/85.77d7d059.js"><link rel="prefetch" href="/study-collection/assets/js/86.f54e5e8c.js"><link rel="prefetch" href="/study-collection/assets/js/87.2e534d80.js"><link rel="prefetch" href="/study-collection/assets/js/88.0d2104b9.js"><link rel="prefetch" href="/study-collection/assets/js/89.7b7a1c1b.js"><link rel="prefetch" href="/study-collection/assets/js/9.48e42892.js"><link rel="prefetch" href="/study-collection/assets/js/90.fb1eec5e.js"><link rel="prefetch" href="/study-collection/assets/js/91.24858df4.js"><link rel="prefetch" href="/study-collection/assets/js/92.520723a1.js"><link rel="prefetch" href="/study-collection/assets/js/93.7f103f39.js"><link rel="prefetch" href="/study-collection/assets/js/94.f308972f.js"><link rel="prefetch" href="/study-collection/assets/js/95.0e21b3fc.js"><link rel="prefetch" href="/study-collection/assets/js/96.f62c7a1c.js"><link rel="prefetch" href="/study-collection/assets/js/97.3937576d.js"><link rel="prefetch" href="/study-collection/assets/js/98.15db166e.js"><link rel="prefetch" href="/study-collection/assets/js/99.e860d85c.js">
    <link rel="stylesheet" href="/study-collection/assets/css/0.styles.d9b30d9c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-collection/" class="home-link router-link-active"><!----> <span class="site-name">끄적끄적 블로그</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-collection/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/gwegwe1234/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/study-collection/guide.html" class="sidebar-link">Intro</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book summary</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>자바 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>클린코드</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>고 인 액션</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-collection/book/go-in-action/01.html" class="sidebar-link">1장 Go와의 첫 만남</a></li><li><a href="/study-collection/book/go-in-action/02.html" class="sidebar-link">2장 Go 간단히 살펴보기</a></li><li><a href="/study-collection/book/go-in-action/03.html" class="sidebar-link">3장 패키징과 내장 도구들</a></li><li><a href="/study-collection/book/go-in-action/04.html" class="sidebar-link">4장 배열, 슬라이스, 맵</a></li><li><a href="/study-collection/book/go-in-action/05.html" class="sidebar-link">5장 Go의 타입 시스템</a></li><li><a href="/study-collection/book/go-in-action/06.html" class="active sidebar-link">6장 동시성</a></li><li><a href="/study-collection/book/go-in-action/07.html" class="sidebar-link">7장 동시성 패턴</a></li><li><a href="/study-collection/book/go-in-action/08.html" class="sidebar-link">8장 표준 라이브러리</a></li><li><a href="/study-collection/book/go-in-action/09.html" class="sidebar-link">9장 테스트와 벤치마킹</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Go 언어를 활용한 마이크로서비스 개발</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>마이크로서비스 구축과 운영</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>카프카 스트림즈 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>모던 자바 인 액션</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>객체지향의 사실과 오해</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>뇌를 자극하는 윈도우즈 시스템 프로그래밍</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6강"><a href="#_6강" class="header-anchor">#</a> 6강</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-동시성과-병렬성">1. 동시성과 병렬성</a></li><li><a href="#_2-고루틴">2. 고루틴</a></li><li><a href="#_3-경쟁-상태">3. 경쟁 상태</a></li><li><a href="#_4-공유-자원-잠금">4. 공유 자원 잠금</a><ul><li><a href="#_4-1-원자성-함수들">4-1. 원자성 함수들</a></li><li><a href="#_4-2-뮤텍스">4-2. 뮤텍스</a></li></ul></li><li><a href="#_5-채널">5. 채널</a><ul><li><a href="#_5-1-버퍼가-없는-채널">5-1. 버퍼가 없는 채널</a></li><li><a href="#_5-2-버퍼가-있는-채널">5-2. 버퍼가 있는 채널</a></li></ul></li><li><a href="#_6-요약">6. 요약</a></li></ul></div><p></p> <h2 id="_1-동시성과-병렬성"><a href="#_1-동시성과-병렬성" class="header-anchor">#</a> 1. 동시성과 병렬성</h2> <ul><li>특정 시스템이 실행되면, 프로세스가 시작된다.</li> <li>프로세스는 어플리케이션이 실행되는 동안 사용하고 관리하는 모든 리소스를 가진 일종의 컨터이너</li></ul> <p><img src="/study-collection/assets/img/go6-1.006b3fd0.jpg" alt="process"></p> <ul><li>위의 그림은 어떤 프로세스에도 할당될 수 있는 공통의 자원을 가진 프로세스의 모습</li> <li>메모리 주소공간, 파일 및 장치, 스레드에 대한 핸들 등 다양한 자원들이 포함되어있다.</li> <li>최초로 실행된 스레드는 메인 스레드 라고 불린다.</li> <li>메인스레드가 종료되면 해당 프로그램도 종료가 된다.</li> <li>Go에서는 논리 프로세서를 각 물리 프로세서에 할당하고, 논리 프로세서에서 고루틴을 동시적으로 돌린다.</li> <li>수백 수천의 고루틴을 동시에 실행시켜 효율과 성능을 향상시킨다.</li></ul> <p><img src="/study-collection/assets/img/go6-2.0e6ec502.jpg" alt="process"></p> <ul><li>위의 그림을 보면 운영체제 스레드와 논리 프로세서, 그리고 지역 실행 큐(local run queue)의 관계를 알 수 있다.</li> <li>고루틴이 생성되고 실행할 준비가 되면 스케줄러의 범용 실행 큐(global run queue)에 위치한다.</li> <li>그리고 논리 프로세서가 할당되어 해당 프로세서의 지역 실행 큐에 위치한다.</li> <li>이후 논리 프로세서가 자신을 실행 할 때 까지 기다리게 된다.</li> <li>중간에 고루틴이 실행을 중단해야되면, 논리프로세서로부터 스레드와 고루틴이 분리되고, 스레든느 시스템 콜이 리턴될 떄까지 기다린다.</li> <li>그러면 논리 프로세서는 할당된 스레드가 없는 상태가 되어, 스케줄러가 새로운 스레드를 생성하여 논리 프로세서에 다시 연결해 지역 실행 큐에서 다른 고루틴을 선택해 돌린다.</li> <li>반복</li></ul> <hr> <ul><li>병렬성은 여러개의 코드가 각기 다른 물리적인 프로세서에서 동시에 실행되는 것이다.</li> <li>즉 한번에 여러개의 작업을 수행할 수 있다.</li> <li>동시성은 조금 다른 개념으로, 한번에 여러 작업을 관리하는(managing) 작업이다.</li> <li>보통 동시성이 병렬성보다 성능이 더 좋은데, 운영체제와 하드웨어에 가해지는 부담이 적어서 시스템이 일을 더 효율적으로 하기 때문</li> <li>고루틴을 병렬적으로 실행하고 싶으면, 여러개의 논리프로세서에 고루틴을 골고루 분배해 고루틴이 별개의 스레드에서 실행되게 하는것</li> <li>하지만 진정한 의미의 병렬은 여러개의 물리 멀티프로세서에서 프로그램을 실행해야 한다.</li></ul> <p><img src="/study-collection/assets/img/go6-3.dcc2b03b.jpg" alt="process"></p> <h2 id="_2-고루틴"><a href="#_2-고루틴" class="header-anchor">#</a> 2. 고루틴</h2> <ul><li>하나의 논리 프로세서에서 고루틴을 실행하는 예제 생성해보자</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token comment">// 스케쥴러가 하나의 논리 프로세서를 할당</span>
	runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token comment">// wg는 프로그램의 종료를 대기하기 위해 사용</span>
	<span class="token comment">// 각각의 고루틴마다 하나씩, 총 두 개의 카운트를 추가한다.</span>

	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;고루틴을 실행합니다.&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 익명 함수를 선언하고 고루틴을 생성한다.</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// main 함수에게 종료를 알리기 위한 Done 함수 호출을 예약</span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token comment">// 알파벳을 세번 출력</span>
		<span class="token keyword">for</span> count <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> count<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> char <span class="token operator">:=</span> <span class="token string">'a'</span><span class="token punctuation">;</span> char <span class="token operator">&lt;</span> <span class="token string">'a'</span><span class="token operator">+</span><span class="token number">26</span><span class="token punctuation">;</span> char<span class="token operator">++</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c &quot;</span><span class="token punctuation">,</span> char<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 익명 함수를 선언하고 고루틴을 생성한다.</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">for</span> count <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> count<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> char <span class="token operator">:=</span> <span class="token string">'A'</span><span class="token punctuation">;</span> char <span class="token operator">&lt;</span> <span class="token string">'A'</span><span class="token operator">+</span><span class="token number">26</span><span class="token punctuation">;</span> char<span class="token operator">++</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c &quot;</span><span class="token punctuation">,</span> char<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 고루틴이 종료 될 때까지 대기한다.</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;대기중!!&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;프로그램 종료!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>runtime 패키지의 GOMAXPROC를 통해 논리프로세서 수를 설정해 준다.</li> <li>두개의 고루틴은 하나의 논리 프로세서에서 동시적으로 실행된다.</li> <li>고루틴이 완료되기 전에 메인함수가 끝나버릴 수 있으니, WaitGroup을 이용해 메인 함수 종료를 제어해준다.</li> <li>WaitGroup은 카운팅 세마포어를 이용해 실행 중인 고루틴의 기록을 관리한다.</li> <li>WaitGroup의 값이 0보다 큰 값이면 Wait 메소드의 실행이 블록된다.</li> <li>명시적으로 2개의 waitgroup을 추가해줬고, 하나의 고루틴이 끝날떄마다 wg.Done을 해줘서 총 2번의 카운팅이 돼야 wg.Wait가 종료된다.</li> <li>내부 스케줄러에 의해 독점을 막기위해 고루틴이 실행중에 멈추고 다른 고루틴이 실행 될 떄가 있다.</li></ul> <p><img src="/study-collection/assets/img/go6-4.4c08e747.jpg" alt="process"></p> <ul><li>해당 그림을 확인해보기 위해 작업 시간이 오래걸리는 고루틴을 작성해보면</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start Goroutine!&quot;</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">printPrime</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">printPrime</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Done&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">printPrime</span><span class="token punctuation">(</span>prefix <span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	next<span class="token punctuation">:</span>
		<span class="token keyword">for</span> outer <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> outer <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> outer<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> inner <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> inner <span class="token operator">&lt;</span> outer<span class="token punctuation">;</span> inner<span class="token operator">++</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> outer <span class="token operator">%</span> inner <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span> next
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d\n&quot;</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> outer<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;완료: &quot;</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>결과값이 AB왔다갔다 한다 (내컴에선 안됨.. 논리 프로세서를 여러개로 두면 왔다갔다함 병렬이라 그렇겠지만)</li> <li>여러개의 프로세서로 병렬처리하려면</li></ul> <div class="language-go extra-class"><pre class="language-go"><code>runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>이렇게 해주면 된다.</li> <li>무조건 프로세서를 늘려준다고 성능이 향상되는건 아니니 잘쓰도록 하자</li></ul> <h2 id="_3-경쟁-상태"><a href="#_3-경쟁-상태" class="header-anchor">#</a> 3. 경쟁 상태</h2> <ul><li>두 개 혹은 그 이상의 고루틴이 동기화 없이 동시에 공유된 자원에 접근하여 읽기 쓰기를 하면 경쟁상태에 놓인다.</li> <li>경쟁상태는 동시성 프로그래밍에서 버그를 유발하고 찾기도 어렵다.</li> <li>즉 읽기 및 쓰기 작업은 반드시 원자성을 가져야 한다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token comment">// 모든 고루틴이 값을 증가라혀고 시도하는 변수</span>
	counter <span class="token builtin">int</span>

	wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;최종결과 : &quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">incCounter</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> count <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> count<span class="token operator">++</span> <span class="token punctuation">{</span>
		value <span class="token operator">:=</span> count

		<span class="token comment">// 스레드를 양보하여 큐로 돌아가도록 한다.</span>
		runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		value<span class="token operator">++</span>

		counter <span class="token operator">=</span> value
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

최종결과 <span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre></div><ul><li>예상 했던 결과는 4가 되어야 하는데 2가 나온다.</li></ul> <p><img src="/study-collection/assets/img/go6-5.fe80f121.jpg" alt="process"></p> <ul><li>그림을 보면 두 개의 고루틴은 각각 다른 고루틴이 증가시킨 카운터 값을 덮어 쓴다.</li> <li>예제는 값을 복사하고 보관하다가 다른 고루틴에게 실행을 양보한 이후에 값을 증가시킨다.</li> <li>즉 다른 고루틴 입장에선 값이 증가된 상황을 알 지 못해 위와 같은 결과가 나온다.</li> <li>go에서는 이런 경쟁상태를 검사할 수 있는 도구를 제공한다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">go</span> build <span class="token operator">-</span>race deadlock1

<span class="token punctuation">.</span><span class="token operator">/</span>deadlock1

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
WARNING<span class="token punctuation">:</span> DATA RACE
Write at <span class="token number">0x00000121e848</span> by goroutine <span class="token number">7</span><span class="token punctuation">:</span>
  main<span class="token punctuation">.</span><span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>Users<span class="token operator">/</span>ted<span class="token operator">/</span>github<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gwegwe1234<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>in<span class="token operator">-</span>action<span class="token operator">/</span>chapter6<span class="token operator">/</span>deadlock1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">38</span> <span class="token operator">+</span><span class="token number">0x74</span>

Previous write at <span class="token number">0x00000121e848</span> by goroutine <span class="token number">6</span><span class="token punctuation">:</span>
  main<span class="token punctuation">.</span><span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>Users<span class="token operator">/</span>ted<span class="token operator">/</span>github<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gwegwe1234<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>in<span class="token operator">-</span>action<span class="token operator">/</span>chapter6<span class="token operator">/</span>deadlock1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">38</span> <span class="token operator">+</span><span class="token number">0x74</span>

Goroutine <span class="token number">7</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> created at<span class="token punctuation">:</span>
  main<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>Users<span class="token operator">/</span>ted<span class="token operator">/</span>github<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gwegwe1234<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>in<span class="token operator">-</span>action<span class="token operator">/</span>chapter6<span class="token operator">/</span>deadlock1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">20</span> <span class="token operator">+</span><span class="token number">0x89</span>

Goroutine <span class="token number">6</span> <span class="token punctuation">(</span>finished<span class="token punctuation">)</span> created at<span class="token punctuation">:</span>
  main<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>Users<span class="token operator">/</span>ted<span class="token operator">/</span>github<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gwegwe1234<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>in<span class="token operator">-</span>action<span class="token operator">/</span>chapter6<span class="token operator">/</span>deadlock1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">19</span> <span class="token operator">+</span><span class="token number">0x68</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
</code></pre></div><ul><li>38, 38, 20 , 19 번째줄에서 경쟁상태가 있다는 식으로 알려준다.</li></ul> <h2 id="_4-공유-자원-잠금"><a href="#_4-공유-자원-잠금" class="header-anchor">#</a> 4. 공유 자원 잠금</h2> <ul><li>atomic 패키지와 sync 패키지를 사용해 공유자원을 잠그고 컨트롤을 할 수가 있다.</li></ul> <h3 id="_4-1-원자성-함수들"><a href="#_4-1-원자성-함수들" class="header-anchor">#</a> 4-1. 원자성 함수들</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	counter <span class="token builtin">int64</span>

	wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Result : &quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">incCounter</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> count <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> count<span class="token operator">++</span> <span class="token punctuation">{</span>
		atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>counter<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

		runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Result <span class="token punctuation">:</span>  <span class="token number">4</span>
</code></pre></div><ul><li>AddInt64를 사용하면 정수값을 더할 때 오직 한 개의 고루틴만 접근이 가능하도록 보장해준다.</li> <li>고루틴이 원자성 함수를 호출하면 함수가 참조하는 변수에 대한 동기화가 자동적으로 수행된다.</li> <li>atomic 패키지의 LoadInt64와 StoreInt64 함수도 쓸만하다</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
	<span class="token string">&quot;time&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	shutdown <span class="token builtin">int64</span>

	wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 고루틴이 작업할 시간을 1초 줌</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

	<span class="token comment">// 종료 플래그 설정</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;프로그램 종료!&quot;</span><span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shutdown<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;작업 진행중 : %s\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">250</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

		<span class="token comment">// 종료 플래그 확인</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shutdown<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;작업을 종료합니다: %s\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

작업 진행중 <span class="token punctuation">:</span> A
작업 진행중 <span class="token punctuation">:</span> B
작업 진행중 <span class="token punctuation">:</span> A
작업 진행중 <span class="token punctuation">:</span> B
작업 진행중 <span class="token punctuation">:</span> A
작업 진행중 <span class="token punctuation">:</span> B
작업 진행중 <span class="token punctuation">:</span> B
작업 진행중 <span class="token punctuation">:</span> A
프로그램 종료<span class="token operator">!</span>
작업을 종료합니다<span class="token punctuation">:</span> A
작업을 종료합니다<span class="token punctuation">:</span> B
</code></pre></div><ul><li>고루틴 안의 for문이 atomic에 값이 저장도리 때까지 돌게된다.</li></ul> <h3 id="_4-2-뮤텍스"><a href="#_4-2-뮤텍스" class="header-anchor">#</a> 4-2. 뮤텍스</h3> <ul><li>뮤텍스를 통해 공유 자원에 대한 접근을 동기화할 수 있다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	counter <span class="token builtin">int</span>
	wg sync<span class="token punctuation">.</span>WaitGroup
	mutex sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Result : %d&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">incCounter</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> count <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> count<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//이 임계 지역에는 한번에 하나의 고루틴만 접근 가능</span>
		mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			value <span class="token operator">:=</span> counter

			runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			value<span class="token operator">++</span>

			counter <span class="token operator">=</span> value
		<span class="token punctuation">}</span>
		mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Result <span class="token punctuation">:</span> <span class="token number">4</span>
</code></pre></div><ul><li>값을 보호하고 싶은 전 후로 mutex.Lock() / mutex.Unlock()을 걸어준다.</li> <li>Unlock이 되기 전에 다른 고루틴은 임계 지점으로 들어갈 수가 없다.</li></ul> <h2 id="_5-채널"><a href="#_5-채널" class="header-anchor">#</a> 5. 채널</h2> <ul><li>필요한 공유 자원을 다른 고루틴에 보내거나 받아 고루틴 사이의 동기화를 지원해주는 <em>채널</em> 존재</li> <li>채널 생성은 make 내장 함수를 사용한다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 버퍼의 크기가 정해지지 않은 정수 채널</span>
unbuffered <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	
<span class="token comment">// 버퍼의 크기가 정해진 문자열 채널</span>
buffered <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>채널을 통해 값이나 포인터를 보내려면 다음과 같이 &lt;- 연산자를 사용한다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code>buffered <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	
buffered <span class="token operator">&lt;-</span> <span class="token string">&quot;Gopher&quot;</span>
</code></pre></div><ul><li>값을 가져올 때도 &lt;- 를 사용한다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code>value <span class="token operator">:=</span> <span class="token operator">&lt;-</span> buffered
</code></pre></div><ul><li>버퍼가 없는 채널과 있는 채널은 조금 다르게 동작한다.</li></ul> <h3 id="_5-1-버퍼가-없는-채널"><a href="#_5-1-버퍼가-없는-채널" class="header-anchor">#</a> 5-1. 버퍼가 없는 채널</h3> <ul><li>채널을 사용 할 때, 채널에 값을 보내거나 받기 전에 값을 전달하는 고루틴과 전달받는 고루틴이 같은 시점에 채널을 사용할 준비가 되어야 한다.</li> <li>만약 한쪽은 주고 한쪽은 받을 준비가 안되있으면, 고루틴은 대기작업에 들어가게 돼 고루틴들이 비정상 작동을 한다.</li></ul> <p><img src="/study-collection/assets/img/go6-6.0286df3c.jpg" alt="goroutine"></p> <ul><li>버퍼가 없는 채널을 사용 할 때 고루틴 사이의 동기화 과정이다.</li> <li>3번처럼 둘다 손을 넣듯이 둘다 준비가 되어 있어야 한다.</li> <li>고루틴의 값이 교환 될 때까지 고루틴들은 잠금 상태가 된다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	court <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token comment">// 두명의 선수</span>
	<span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">&quot;Sunny&quot;</span><span class="token punctuation">,</span> court<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">&quot;Cindy&quot;</span><span class="token punctuation">,</span> court<span class="token punctuation">)</span>

	court <span class="token operator">&lt;-</span> <span class="token number">1</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">player</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> court <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 공이 되돌아 올 때까지 기다린다.</span>
		ball<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span> court
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// 채널이 닫혔으면 승리한 것으로 간주한다.</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s 선수가 승리했습니다! \n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 랜덤 값을 이용해 공을 받아치지 못했는지 확인</span>
		n <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">13</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s 선수가 공을 받아치지 못했습니다.\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

			<span class="token comment">// 채널을 닫아 현재 선수가 패배했음을 알린다.</span>
			<span class="token function">close</span><span class="token punctuation">(</span>court<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 선수가 공을 받아친 횟수를 출력하고 그 값을 증가시킨다.</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s 선수가 %d 번째 공을 받아 쳤습니다. \n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> ball<span class="token punctuation">)</span>
		ball<span class="token operator">++</span>

		<span class="token comment">// 공을 상대에게 보낸다.</span>
		court <span class="token operator">&lt;-</span> ball
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>두 고루틴 사이에 공을 쳐낸 횟수를 교환하기 위해 int 타입의 버퍼 크기가 정해지지 않은 채널을 생성한다.</li> <li>실제로 player 함수내에서 court 값을 주고받으면서, 한쪽이 조건문에 걸려서 채널을 close 할때까지 핑퐁하게 된다.</li> <li>한쪽이 닫으면 다른 고루틴은 ball, ok 쪽에서 ok가 false가 오므로, 고루틴이 정상적으로 종료가 된다.</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	baton <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">Runner</span><span class="token punctuation">(</span>baton<span class="token punctuation">)</span>

	<span class="token comment">// 경기 시작!</span>
	baton <span class="token operator">&lt;-</span> <span class="token number">1</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Runner</span><span class="token punctuation">(</span>baton <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">var</span> newRunner <span class="token builtin">int</span>

	<span class="token comment">// 바통을 전달 받을 때 까지 기다린다.</span>
	runner <span class="token operator">:=</span> <span class="token operator">&lt;-</span> baton

	<span class="token comment">// 트랙을 달린다.</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d 번째 주자가 바통을 받아 달리기 시작합니다! \n&quot;</span><span class="token punctuation">,</span> runner<span class="token punctuation">)</span>

	<span class="token comment">// 새로운 주자가 교체 지점에서 대기</span>
	<span class="token keyword">if</span> runner <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">{</span>
		newRunner <span class="token operator">=</span> runner <span class="token operator">+</span> <span class="token number">1</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d 번째 주자가 대기합니다. \n&quot;</span><span class="token punctuation">,</span> newRunner<span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">Runner</span><span class="token punctuation">(</span>baton<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 트랙을 달린다</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

	<span class="token comment">// 경기가 끝났는지 확인</span>
	<span class="token keyword">if</span> runner <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d 번째 주자가 도착했습니다. 경기가 끝났습니다.&quot;</span><span class="token punctuation">,</span> runner<span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 다음 주자에게 바통을 넘긴다.</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d 번째 주자가 %d 번째 주자에게 바통을 넘겨줍니다.\n&quot;</span><span class="token punctuation">,</span> runner<span class="token punctuation">,</span> newRunner<span class="token punctuation">)</span>

	baton <span class="token operator">&lt;-</span> newRunner
<span class="token punctuation">}</span>

<span class="token number">1</span> 번째 주자가 바통을 받아 달리기 시작합니다<span class="token operator">!</span> 
<span class="token number">2</span> 번째 주자가 대기합니다<span class="token punctuation">.</span> 
<span class="token number">1</span> 번째 주자가 <span class="token number">2</span> 번째 주자에게 바통을 넘겨줍니다<span class="token punctuation">.</span>
<span class="token number">2</span> 번째 주자가 바통을 받아 달리기 시작합니다<span class="token operator">!</span> 
<span class="token number">3</span> 번째 주자가 대기합니다<span class="token punctuation">.</span> 
<span class="token number">2</span> 번째 주자가 <span class="token number">3</span> 번째 주자에게 바통을 넘겨줍니다<span class="token punctuation">.</span>
<span class="token number">3</span> 번째 주자가 바통을 받아 달리기 시작합니다<span class="token operator">!</span> 
<span class="token number">4</span> 번째 주자가 대기합니다<span class="token punctuation">.</span> 
<span class="token number">3</span> 번째 주자가 <span class="token number">4</span> 번째 주자에게 바통을 넘겨줍니다<span class="token punctuation">.</span>
<span class="token number">4</span> 번째 주자가 바통을 받아 달리기 시작합니다<span class="token operator">!</span> 
<span class="token number">4</span> 번째 주자가 도착했습니다<span class="token punctuation">.</span> 경기가 끝났습니다<span class="token punctuation">.</span>
</code></pre></div><ul><li>Runner 클래스 중간에 go Runner는 채널값이 옮겨지기 전까진 대기한다.</li></ul> <h3 id="_5-2-버퍼가-있는-채널"><a href="#_5-2-버퍼가-있는-채널" class="header-anchor">#</a> 5-2. 버퍼가 있는 채널</h3> <ul><li>버퍼가 있는 채널은 고루틴이 값을 받아가기 전까지 채널에 보관할 수 있는 값의 개수를 지정할 수 있다.</li> <li>이 채널을 이용해 보내고 받는 동작을 하면, 반드시 동시에 일어날 필요는 없다.</li> <li>값을 받는 작업의 잠금 작업은 채널 내에 받아갈 값이 없을 때만 실행된다.</li> <li>값을 보내는 작업의 잠금은 채널 내 버퍼가 가득 차서 더이상 값을 보관할 수 없을떄만 실행한다.</li> <li>즉 버퍼가 없는 채널은 보내고 받는 동작이 반드시 동기적으로 작업하는 반면, 버퍼가 있는 채널은 보장할 수 없다.</li></ul> <p><img src="/study-collection/assets/img/go6-7.e8a85801.jpg" alt="goroutine"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	nuberGoroutines <span class="token operator">=</span> <span class="token number">4</span>
	taskLoad <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token comment">// 버퍼가 있는 채널 생성</span>
	tasks <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> taskLoad<span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>nuberGoroutines<span class="token punctuation">)</span>

	<span class="token comment">// 작업을 처리할 고루틴을 실행한다.</span>
	<span class="token keyword">for</span> gr <span class="token operator">:=</span> <span class="token number">1</span> <span class="token punctuation">;</span> gr <span class="token operator">&lt;=</span> nuberGoroutines<span class="token punctuation">;</span> gr<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> gr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 실행할 작업을 추가한다.</span>
	<span class="token keyword">for</span> post <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> post <span class="token operator">&lt;=</span> taskLoad<span class="token punctuation">;</span> post<span class="token operator">++</span> <span class="token punctuation">{</span>
		tasks <span class="token operator">&lt;-</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;작업 : %d&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">close</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>tasks <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> worker <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 작업이 할당될 때까지 대기한다.</span>
		task<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span> tasks

		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// 채널이 닫힌 경우</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;작업자 : %d : 종료합니다. \n&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;작업자 : %d : 작업시작 : %s\n&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> task<span class="token punctuation">)</span>

		sleep <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>sleep<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;작업자 : %d : 작업 완료 : %s\n&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> task<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>4개의 고루틴을 생성하고, 10개의 작업을 버퍼에 넣는다.</li> <li>채널이 닫히더라도, 각 고루틴들은 더 이상 받을 값이 없을 때까지 채널에서 계속 값을 받는다.</li> <li>즉 값의 유실을 막아주기 위해 버퍼 채널 내에 있는 값들은 무조건 보장해 주는것</li></ul> <h2 id="_6-요약"><a href="#_6-요약" class="header-anchor">#</a> 6. 요약</h2> <ul><li>동시성이란 고루틴을 독립적으로 실행하는 기능</li> <li>함수는 go 키워드를 이용해 고루틴으로 동작</li> <li>고루틴은 하나의 운영체제 스레드와 실행 큐를 가진 논리 프로세서의 범위 내에서 실행</li> <li>경쟁 상태란 두 개 혹은 그 이상의 고루틴이 동일한 자원에 접근하려고 시도하는 현상</li> <li>원자성 함수들과 뮤텍스는 경쟁 상태를 피해 공유되는 자원응ㄹ 보호할 방법을 제공</li> <li>채널은 두 고루틴 사이의 공유 데이터를 본질적으로 안전하게 보호하는 방법을 제공</li> <li>버퍼가 없는 채널은 데이터가 반드시 교환될 수 있도록 보장하고, 버퍼가 잇는 채널은 그렇지 않다.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-collection/book/go-in-action/05.html" class="prev">5장 Go의 타입 시스템</a></span> <span class="next"><a href="/study-collection/book/go-in-action/07.html">7장 동시성 패턴</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-collection/assets/js/app.981bd393.js" defer></script><script src="/study-collection/assets/js/2.79894b7f.js" defer></script><script src="/study-collection/assets/js/22.ad8f3b49.js" defer></script>
  </body>
</html>
